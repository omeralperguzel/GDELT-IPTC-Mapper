<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDELT Theme ‚Üí IPTC Media Topics Mapping Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .config-panel {
            background: #e8eaf6;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .config-group {
            display: flex;
            flex-direction: column;
        }
        
        .config-group label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .config-group input,
        .config-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .config-buttons {
            display: flex;
            gap: 10px;
        }
        
        .run-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .run-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .run-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            padding: 10px 15px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .methodology {
            font-size: 0.95em;
            opacity: 0.85;
            margin-top: 10px;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .stat-card h3 {
            color: #667eea;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .filter-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .method-tabs {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        
        .method-tab {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .method-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .charts-section {
            padding: 30px;
            background: #f8f9fa;
        }
        
        #tab-charts .charts-section {
            padding: 20px;
            background: transparent;
        }
        
        .method-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-box {
            background: #e8eaf6;
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        
        .info-box h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .info-box p {
            font-size: 0.9em;
            color: #555;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .formula-container {
            background: white;
            padding: 20px;
            border-radius: 5px;
            margin: 15px 0;
            text-align: center;
            border: 1px solid #d0d0e8;
        }
        
        .formula-title {
            font-size: 0.85em;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .katex {
            font-size: 1.1em;
        }
        
        .parameters-list {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #d0d0e8;
            margin-top: 10px;
        }
        
        .parameters-list h5 {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .param-item {
            font-size: 0.85em;
            color: #555;
            line-height: 1.6;
            margin-bottom: 6px;
            padding-left: 10px;
            border-left: 2px solid #667eea;
        }
        
        .param-item strong {
            color: #667eea;
        }
        
        .country-detail-view {
            display: none;
        }
        
        .country-detail-view.active {
            display: block;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        
        .detail-header h3 {
            color: #667eea;
            font-size: 1.5em;
            margin: 0;
        }
        
        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .back-button:hover {
            background: #5a6268;
        }
        
        .calculation-section {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .calculation-section h4 {
            color: #667eea;
            margin-top: 0;
            font-size: 1.05em;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .data-table th, .data-table td {
            padding: 8px;
            text-align: right;
            border: 1px solid #ddd;
        }
        
        .data-table th {
            background: #f0f0f5;
            color: #667eea;
            font-weight: 600;
        }
        
        .data-table tr:hover {
            background: #f9f9fc;
        }
        
        .calculation-steps {
            background: #f9f9fc;
            padding: 12px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        .calculation-step {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-left: 3px solid #667eea;
            padding-left: 12px;
        }
        
        .formula-result {
            background: #e8eaf6;
            padding: 12px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: 600;
            color: #667eea;
            text-align: center;
            font-size: 1.1em;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .chart-container h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #667eea;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            background: rgba(255,255,255,0.1);
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .positive {
            color: #27ae60;
            font-weight: bold;
        }
        
        .negative {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .significant {
            background: #ecf0f1;
            font-weight: 500;
        }
        
        .table-wrapper {
            padding: 30px;
            overflow-x: auto;
        }
        
        .legend {
            padding: 20px;
            background: #f8f9fa;
            margin-top: 20px;
            border-radius: 8px;
            font-size: 0.95em;
        }
        
        .legend p {
            margin-bottom: 8px;
        }
        
        /* TAB STYLING */
        .tabs-container {
            display: flex;
            gap: 5px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 12px 24px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s;
            color: #666;
        }
        
        .tab-button:hover {
            background: #f0f0f0;
            border-color: #667eea;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .tab-content {
            display: none;
            width: 100%;
            animation: fadeIn 0.3s ease-in;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåê GDELT Theme ‚Üí IPTC Media Topics Mapping</h1>
            <p>Semantic Embedding Analysis with Sentence-Transformers (all-MiniLM-L6-v2)</p>
            <p class="methodology">Cosine Similarity ‚Ä¢ IPTC NewsCodes (17 Categories) ‚Ä¢ Supervised Mapping</p>
        </header>
        
        <div class="config-panel">
            <h3 style="color: #0f3460; margin-bottom: 15px;">‚öôÔ∏è GDELT & IPTC Analiz Parametreleri</h3>
            <div class="config-grid">
                <div class="config-group">
                    <label for="min-docs-threshold">Min. Dok√ºman E≈üiƒüi:</label>
                    <input type="number" id="min-docs-threshold" min="0" max="100000" value="1000" title="Minimum toplam dok√ºman sayƒ±sƒ± filtresi">
                </div>
                <div class="config-group">
                    <label for="quality-threshold">Min. Kalite Oranƒ± (%):</label>
                    <input type="number" id="quality-threshold" min="0" max="100" value="50" title="Minimum aylƒ±k kalite oranƒ±">
                </div>
                <div class="config-group">
                    <label for="similarity-threshold">Min. Benzerlik Skoru:</label>
                    <input type="number" id="similarity-threshold" min="0" max="1" step="0.01" value="0.30" title="IPTC e≈üle≈ütirme minimum benzerlik">
                </div>
                <div class="config-group">
                    <label for="iptc-filter-param">IPTC Kategori Filtresi:</label>
                    <select id="iptc-filter-param">
                        <option value="all">T√ºm Kategoriler (17)</option>
                        <option value="economy, business and finance">üí∞ Economy</option>
                        <option value="conflict, war and peace">‚öîÔ∏è Conflict</option>
                        <option value="politics and government">üèõÔ∏è Politics</option>
                        <option value="health">üè• Health</option>
                        <option value="education">üìö Education</option>
                        <option value="disaster, accident and emergency incident">üö® Disaster</option>
                        <option value="environment">üåç Environment</option>
                    </select>
                </div>
            </div>
            <div class="config-buttons">
                <button class="run-btn" id="run-analysis-btn" onclick="applyGDELTFilters()">üîç Filtreleri Uygula</button>
                <button class="run-btn" style="background: #6c757d;" id="reset-btn" onclick="resetGDELTFilters()">üîÑ Sƒ±fƒ±rla</button>
                <span style="margin: 0 10px; color: #999;">|</span>
                <button class="run-btn" style="background: #28a745;" id="save-btn" title="Mevcut analizi kaydet" onclick="saveGDELTAnalysis()">üíæ Kaydet</button>
                <button class="run-btn" style="background: #17a2b8;" id="import-btn" title="Dosyadan i√ße aktar" onclick="triggerImport()">üì• ƒ∞√ße Aktar</button>
                <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="handleGDELTImportFile(event)">
            </div>
            <div class="status-message" id="status-message"></div>
        </div>
        
        <!-- TAB BUTTONS -->
        <div class="tabs-container">
            <button class="tab-button active" data-tab="gdelt">üì∞ GDELT Tema</button>
            <button class="tab-button" data-tab="charts">üìà Grafikler</button>
            <button class="tab-button" data-tab="clustering">ü§ñ K√ºmeleme</button>
            <button class="tab-button" data-tab="export">üì§ Dƒ±≈üarƒ± Aktar</button>
        </div>
        
        <!-- TAB 2: CHARTS - GDELT/IPTC Grafikleri -->
        <div class="tab-content" id="tab-charts">
            <div class="charts-section">
                <h3 style="color: #0f3460; margin-bottom: 20px; text-align: center;">üìà GDELT Tema & IPTC Kategori Grafikleri</h3>
                <p style="text-align: center; color: #666; margin-bottom: 25px;">
                    GDELT tema daƒüƒ±lƒ±mlarƒ± ve IPTC kategori bazlƒ± g√∂rselle≈ütirmeler
                </p>
                
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>üìä IPTC Kategori Daƒüƒ±lƒ±mƒ±</h3>
                        <div class="chart-wrapper">
                            <canvas id="iptc-distribution-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>üåç √úlke Bazlƒ± Tema Hacmi</h3>
                        <div class="chart-wrapper">
                            <canvas id="country-theme-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>üìà En Y√ºksek Hacimli Temalar</h3>
                        <div class="chart-wrapper">
                            <canvas id="top-themes-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>üéØ IPTC Benzerlik Skorlarƒ±</h3>
                        <div class="chart-wrapper">
                            <canvas id="iptc-similarity-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Grafik Olu≈ütur Butonu -->
                <div style="text-align: center; margin-top: 20px;">
                    <button class="run-btn" onclick="generateGDELTCharts()">üîÑ Grafikleri Olu≈ütur</button>
                    <p style="font-size: 0.85em; color: #888; margin-top: 10px;">
                        Not: √ñnce GDELT Tema sekmesinden CSV verilerini y√ºkleyin
                    </p>
                </div>
            </div>
        </div>
        
        <!-- TAB 3: CLUSTERING -->
        <div class="tab-content" id="tab-clustering">
            <!-- GDELT Theme ‚Üí IPTC Media Topics Mapping -->
            <div class="charts-section" style="text-align: center; padding: 20px;">
                <h3 style="color: #667eea; margin-bottom: 20px;">üéØ GDELT Tema ‚Üí IPTC Media Topics E≈üle≈ütirme</h3>
                <p style="text-align: center; color: #666; margin-bottom: 15px;">
                    Sentence-Transformer embedding + Cosine Similarity ‚Üí IPTC NewsCodes (17 √ºst d√ºzey kategori)
                </p>
                <p style="text-align: center; color: #888; font-size: 0.85em; margin-bottom: 20px;">
                    <em>Referans: Kuzman & Ljube≈°iƒá (2024), Tarekegn (2024) - IPTC top-level news classification</em>
                </p>
                
                <!-- Kontrol Paneli -->
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; justify-content: center;">
                    <button class="run-btn" id="iptc-mapping-btn" onclick="runIPTCMapping()">üöÄ IPTC E≈üle≈ütirme √áalƒ±≈ütƒ±r</button>
                    <button class="run-btn" style="background: #4CAF50;" id="iptc-load-results-btn" onclick="loadIPTCMappingResults()">üì• Sonu√ßlarƒ± Y√ºkle</button>
                </div>
                <div id="iptc-mapping-status" class="status-message" style="max-width: 800px; margin: 0 auto 20px;"></div>
                
                <!-- IPTC Kategori Kartlarƒ± Grid -->
                <div id="iptc-categories-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px auto; max-width: 1000px;">
                    <!-- Dinamik olarak doldurulacak -->
                </div>
                
                <!-- Tema-IPTC E≈üle≈ütirme Tablosu -->
                <div class="chart-container" style="margin-top: 25px; max-width: 900px; margin-left: auto; margin-right: auto;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">üìä T√ºm Temalar ve IPTC E≈üle≈ütirmeleri</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table id="iptc-themes-table" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                            <thead style="position: sticky; top: 0; background: #e3f2fd;">
                                <tr>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #2196F3;">Tema Kodu</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #2196F3;">IPTC Kategori</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #2196F3;">Benzerlik</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #2196F3;">G√ºven</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #2196F3;">2. En Yakƒ±n</th>
                                </tr>
                            </thead>
                            <tbody id="iptc-themes-tbody">
                                <tr><td colspan="5" style="text-align: center; padding: 30px; color: #999;">IPTC e≈üle≈ütirme sonu√ßlarƒ± y√ºklenmedi</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB 1: GDELT TEMA ANALƒ∞Zƒ∞ -->
        <div class="tab-content active" id="tab-gdelt">
            <div class="charts-section">
                <h3 style="color: #0f3460; margin-bottom: 20px; text-align: center;">üì∞ GDELT Tema ‚Üí IPTC Media Topics Analizi</h3>
                <p style="text-align: center; color: #666; margin-bottom: 25px;">
                    GDELT GKG temalarƒ±nƒ±n IPTC NewsCodes (17 √ºst d√ºzey kategori) ile semantic e≈üle≈ütirmesi
                </p>
                
                <!-- Kontrol Paneli -->
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; justify-content: center;">
                    <button class="run-btn" id="load-gdelt-data-btn" onclick="loadGDELTData()">üì• CSV Verilerini Y√ºkle</button>
                    <button class="run-btn" style="background: #4CAF50;" id="analyze-themes-btn" onclick="analyzeThemes()" disabled>üîç Tema Analizi Yap</button>
                    <button class="run-btn" style="background: #FF9800;" id="generate-matrix-btn" onclick="generateCountryThemeMatrix()" disabled>üìä Matris Olu≈ütur</button>
                </div>
                
                <div id="gdelt-status" class="status-message" style="max-width: 600px; margin: 0 auto 20px;"></div>
                
                <!-- Ana ƒ∞√ßerik Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                    
                    <!-- SOL PANEL: Tablo-1 (total_docs) -->
                    <div class="chart-container" style="border-left: 4px solid #2196F3;">
                        <h4 style="color: #2196F3; margin-bottom: 10px;">üìã Tablo-1: Toplam Haber Hacmi</h4>
                        <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">
                            Her √ºlke-tema i√ßin 2022-2024 toplam dok√ºman sayƒ±sƒ± (Hocanƒ±n 2. maddesi i√ßin)
                        </p>
                        
                        <!-- √úlke Se√ßimi -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: 600; font-size: 0.9em;">√úlke Se√ß:</label>
                            <select id="gdelt-country-select" onchange="updateTotalDocsTable()" style="padding: 8px 12px; border-radius: 5px; border: 1px solid #ddd; margin-left: 10px;">
                                <option value="ALL">üåç T√ºm √úlkeler</option>
                                <option value="CE">CE - Sri Lanka</option>
                                <option value="HO">HO - Honduras</option>
                                <option value="HR">HR - Croatia</option>
                                <option value="KG">KG - Kyrgyzstan</option>
                                <option value="LO">LO - Slovakia</option>
                                <option value="SA">SA - Saudi Arabia</option>
                            </select>
                        </div>
                        
                        <!-- Tablo -->
                        <div style="max-height: 450px; overflow-y: auto;">
                            <table id="total-docs-table" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                                <thead style="position: sticky; top: 0; background: #e3f2fd;">
                                    <tr>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #2196F3;">√úlke</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #2196F3;">Tema Kodu</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #2196F3;">Toplam Dok√ºman</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #2196F3;">IPTC Kategorisi</th>
                                    </tr>
                                </thead>
                                <tbody id="total-docs-tbody">
                                    <tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">CSV y√ºklenmedi. Yukarƒ±daki butona tƒ±klayƒ±n.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- A√ßƒ±klama -->
                        <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 5px; font-size: 0.85em;">
                            <strong>üéØ IPTC Media Topics (17 Kategori):</strong><br>
                            üí∞ <span style="color: #FF9800;">Economy</span>: ECON, EPU, EPU_ECONOMY |
                            ‚öîÔ∏è <span style="color: #F44336;">Conflict</span>: CRISISLEX, ARMEDCONFLICT |
                            üèõÔ∏è <span style="color: #2196F3;">Politics</span>: LEADER, GOV, ELECTION<br>
                            üè• <span style="color: #4CAF50;">Health</span>: HEALTH, MEDICAL |
                            üìö <span style="color: #9C27B0;">Education</span>: EDUCATION |
                            ‚úàÔ∏è <span style="color: #00BCD4;">Lifestyle</span>: TOURISM
                        </div>
                    </div>
                    
                    <!-- SAƒû PANEL: Tablo-2 (months_ok, median_docs) -->
                    <div class="chart-container" style="border-left: 4px solid #4CAF50;">
                        <h4 style="color: #4CAF50; margin-bottom: 10px;">üìã Tablo-2: Aylƒ±k Veri Kalitesi</h4>
                        <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">
                            Her √ºlke-tema i√ßin aylƒ±k haber yeterliliƒüi (Hocanƒ±n 3. maddesi i√ßin)
                        </p>
                        
                        <!-- Filtre -->
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <label style="font-weight: 600; font-size: 0.9em;">Kalite Filtresi:</label>
                            <select id="gdelt-quality-filter" onchange="updateMonthlyQualityTable()" style="padding: 8px 12px; border-radius: 5px; border: 1px solid #ddd;">
                                <option value="all">T√ºm√º</option>
                                <option value="good">‚úÖ ƒ∞yi (‚â•70%)</option>
                                <option value="marginal">‚ö†Ô∏è Sƒ±nƒ±rda (40-70%)</option>
                                <option value="poor">‚ùå Yetersiz (<40%)</option>
                            </select>
                        </div>
                        
                        <!-- Tablo -->
                        <div style="max-height: 450px; overflow-y: auto;">
                            <table id="monthly-quality-table" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                                <thead style="position: sticky; top: 0; background: #e8f5e9;">
                                    <tr>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #4CAF50;">√úlke</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #4CAF50;">Tema</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #4CAF50;">IPTC Kategorisi</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #4CAF50;">Ay</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #4CAF50;">Oran</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #4CAF50;">Karar</th>
                                    </tr>
                                </thead>
                                <tbody id="monthly-quality-tbody">
                                    <tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">CSV y√ºklenmedi. Yukarƒ±daki butona tƒ±klayƒ±n.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Karar Kurallarƒ± -->
                        <div style="margin-top: 15px; padding: 12px; background: #e8f5e9; border-radius: 5px; font-size: 0.85em;">
                            <strong>üìå Karar Kurallarƒ± (Aylƒ±k Sentiment i√ßin):</strong><br>
                            ‚úÖ <span style="color: #4CAF50;">months_ok/total ‚â• 0.7</span> ‚Üí Kullan (aylƒ±k)<br>
                            ‚ö†Ô∏è <span style="color: #FF9800;">0.4 ‚Äì 0.7</span> ‚Üí Quarterly aggregation<br>
                            ‚ùå <span style="color: #f44336;">< 0.4</span> ‚Üí O kategoriyi √ßƒ±kar
                        </div>
                    </div>
                </div>
                
                <!-- √ñZET PANEL: Se√ßilen Kategoriler & Matris -->
                <div class="chart-container" style="margin-top: 25px; border-left: 4px solid #9C27B0;">
                    <h4 style="color: #9C27B0; margin-bottom: 15px;">üéØ Adƒ±m A: Ana Kategori Se√ßimi (5-6 Kategori)</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <!-- √ñnerilen Kategoriler (IPTC 17 Kategori) -->
                        <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                            <h5 style="color: #9C27B0; margin-bottom: 10px;">üéØ IPTC Media Topics (17 Kategori)</h5>
                            <div id="suggested-categories" style="font-size: 0.85em; line-height: 1.7; max-height: 280px; overflow-y: auto;">
                                <div>üé® <strong>Arts/Media:</strong> <code>MEDIA</code>, <code>CULTURE</code></div>
                                <div>‚öîÔ∏è <strong>Conflict:</strong> <code>CRISISLEX</code>, <code>ARMEDCONFLICT</code>, <code>TERROR</code></div>
                                <div>üëÆ <strong>Crime/Justice:</strong> <code>CRIME</code>, <code>LAW</code></div>
                                <div>üö® <strong>Disaster:</strong> <code>MANMADE</code>, <code>DISASTER</code>, <code>NATURAL</code></div>
                                <div>üí∞ <strong>Economy:</strong> <code>ECON</code>, <code>EPU</code>, <code>EPU_ECONOMY</code></div>
                                <div>üìö <strong>Education:</strong> <code>EDUCATION</code></div>
                                <div>üåç <strong>Environment:</strong> <code>ENV</code>, <code>CLIMATE</code></div>
                                <div>üè• <strong>Health:</strong> <code>HEALTH</code>, <code>MEDICAL</code></div>
                                <div>‚ù§Ô∏è <strong>Human Interest:</strong> <code>AFFECT</code>, <code>GENERAL</code></div>
                                <div>üíº <strong>Labour:</strong> <code>LABOR</code>, <code>EMPLOYMENT</code></div>
                                <div>‚úàÔ∏è <strong>Lifestyle:</strong> <code>TOURISM</code>, <code>TRAVEL</code></div>
                                <div>üèõÔ∏è <strong>Politics:</strong> <code>LEADER</code>, <code>ELECTION</code>, <code>GOV</code></div>
                                <div>üïå <strong>Religion:</strong> <code>RELIGION</code></div>
                                <div>üî¨ <strong>Science/Tech:</strong> <code>SCIENCE</code>, <code>TECHNOLOGY</code></div>
                                <div>üë• <strong>Society:</strong> <code>SOC</code>, <code>SOCIAL</code></div>
                                <div>‚öΩ <strong>Sport:</strong> <code>SPORT</code></div>
                                <div>üå§Ô∏è <strong>Weather:</strong> <code>WEATHER</code></div>
                            </div>
                        </div>
                        
                        <!-- T√ºm √úlkelerde Ortak Temalar -->
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                            <h5 style="color: #4CAF50; margin-bottom: 10px;">‚úÖ T√ºm √úlkelerde Y√ºksek Hacimli Ortak Temalar</h5>
                            <div id="common-themes-list" style="font-size: 0.9em; line-height: 1.6; max-height: 200px; overflow-y: auto;">
                                <span style="color: #999;">Analiz sonrasƒ± doldurulacak...</span>
                            </div>
                        </div>
                        
                        <!-- Rapor C√ºmleleri -->
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                            <h5 style="color: #FF9800; margin-bottom: 10px;">üìù Rapor i√ßin Hazƒ±r C√ºmleler</h5>
                            <div style="font-size: 0.85em; line-height: 1.6;">
                                <p style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px;">
                                    <em>"We identified the most frequent GDELT theme families for each country and retained those that consistently appeared across all six countries and corresponded to meaningful news topics."</em>
                                </p>
                                <p style="padding: 8px; background: white; border-radius: 4px;">
                                    <em>"To ensure robust sentiment aggregation, we required at least 50 distinct news records per country‚Äìtheme‚Äìmonth. Categories failing this criterion were either excluded or aggregated quarterly."</em>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Adƒ±m B: √úlke-Kategori Matrisi -->
                    <h4 style="color: #E91E63; margin: 25px 0 15px;">üìä Adƒ±m B: √úlke-Kategori Kullanƒ±labilirlik Matrisi</h4>
                    <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">
                        ‚úî = Aylƒ±k sentiment i√ßin uygun (‚â•70%) | ‚ö† = Quarterly gerekli (40-70%) | ‚úñ = Yetersiz (<40%)
                    </p>
                    
                    <div style="overflow-x: auto;">
                        <table id="country-theme-matrix" style="width: 100%; border-collapse: collapse; font-size: 0.9em; text-align: center;">
                            <thead style="background: linear-gradient(135deg, #E91E63 0%, #9C27B0 100%); color: white;">
                                <tr>
                                    <th style="padding: 12px;">√úlke</th>
                                    <th style="padding: 12px;">Economy</th>
                                    <th style="padding: 12px;">Government</th>
                                    <th style="padding: 12px;">Security</th>
                                    <th style="padding: 12px;">Health</th>
                                    <th style="padding: 12px;">Education</th>
                                    <th style="padding: 12px;">Tourism</th>
                                </tr>
                            </thead>
                            <tbody id="matrix-tbody">
                                <tr><td colspan="7" style="text-align: center; padding: 30px; color: #999;">"Matris Olu≈ütur" butonuna tƒ±klayƒ±n</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Export Butonu -->
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="run-btn" style="background: #9C27B0;" onclick="exportGDELTAnalysis()" disabled id="export-gdelt-btn">üì§ Analiz Sonu√ßlarƒ±nƒ± CSV Olarak ƒ∞ndir</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB 5: EXPORT - GDELT/IPTC Export -->
        <div class="tab-content" id="tab-export">
            <div class="charts-section">
                <h3 style="color: #0f3460; margin-bottom: 20px; text-align: center;">üì§ GDELT & IPTC Veri Dƒ±≈üarƒ± Aktarma</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px;">
                    
                    <!-- GDELT TEMA EXPORT -->
                    <div class="chart-container" style="border-left: 4px solid #4CAF50;">
                        <h4 style="color: #4CAF50; margin-bottom: 15px;">üìã GDELT Tema Verileri</h4>
                        
                        <!-- S√ºtun Se√ßimi -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: 600; color: #333; display: block; margin-bottom: 8px;">S√ºtunlar:</label>
                            <div id="export-columns-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; background: #f8f9fa; padding: 12px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="country" checked> √úlke
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="theme_code" checked> Tema Kodu
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="total_docs" checked> Toplam Dok√ºman
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="iptc_category" checked> IPTC Kategorisi
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="months_ok"> Uygun Ay Sayƒ±sƒ±
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="months_total"> Toplam Ay
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="quality_ratio"> Kalite Oranƒ±
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="median_docs"> Median Dok√ºman
                                </label>
                            </div>
                            <div style="margin-top: 8px;">
                                <button onclick="selectAllExportCols()" style="padding: 5px 10px; font-size: 0.85em; cursor: pointer; margin-right: 5px;">T√ºm√ºn√º Se√ß</button>
                                <button onclick="deselectAllExportCols()" style="padding: 5px 10px; font-size: 0.85em; cursor: pointer;">T√ºm√ºn√º Kaldƒ±r</button>
                            </div>
                        </div>
                        
                        <!-- IPTC Filtre Se√ßimi -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: 600; color: #333; display: block; margin-bottom: 8px;">IPTC Kategori Filtresi:</label>
                            <select id="export-iptc-filter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="all">T√ºm Kategoriler</option>
                                <option value="economy, business and finance">üí∞ Economy</option>
                                <option value="conflict, war and peace">‚öîÔ∏è Conflict</option>
                                <option value="politics and government">üèõÔ∏è Politics</option>
                                <option value="health">üè• Health</option>
                                <option value="education">üìö Education</option>
                                <option value="lifestyle and leisure">‚úàÔ∏è Lifestyle</option>
                                <option value="disaster, accident and emergency incident">üö® Disaster</option>
                                <option value="environment">üåç Environment</option>
                                <option value="arts, culture, entertainment and media">üé® Arts/Media</option>
                                <option value="society">üë• Society</option>
                            </select>
                        </div>
                        
                        <!-- Export Butonlarƒ± -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="run-btn" style="background: #4CAF50;" onclick="exportGDELTDataXLSX()">
                                üìä XLSX ƒ∞ndir
                            </button>
                            <button class="run-btn" style="background: #2196F3;" onclick="exportGDELTDataCSV()">
                                üìÑ CSV ƒ∞ndir
                            </button>
                            <button class="run-btn" style="background: #9C27B0;" onclick="showGDELTLatexTable()">
                                üìù LaTeX Kodu
                            </button>
                        </div>
                        
                        <!-- LaTeX √ñnizleme -->
                        <div id="latex-table-preview" style="display: none; margin-top: 15px;">
                            <label style="font-weight: 600; color: #9C27B0; display: block; margin-bottom: 8px;">LaTeX Tablo Kodu:</label>
                            <textarea id="latex-table-code" readonly style="width: 100%; height: 200px; font-family: monospace; font-size: 0.85em; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f5f5f5;"></textarea>
                            <button onclick="copyLatexTable()" style="margin-top: 8px; padding: 8px 15px; cursor: pointer;">üìã Kopyala</button>
                        </div>
                    </div>
                    
                    <!-- IPTC MAPPING EXPORT -->
                    <div class="chart-container" style="border-left: 4px solid #FF9800;">
                        <h4 style="color: #FF9800; margin-bottom: 15px;">üéØ IPTC E≈üle≈ütirme Sonu√ßlarƒ±</h4>
                        
                        <!-- IPTC Mapping Export Se√ßenekleri -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: 600; color: #333; display: block; margin-bottom: 8px;">Export ƒ∞√ßeriƒüi:</label>
                            <div style="display: flex; flex-direction: column; gap: 8px; background: #f8f9fa; padding: 12px; border-radius: 5px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" id="export-iptc-themes" checked> Tema-IPTC E≈üle≈ütirmeleri
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" id="export-iptc-summary" checked> IPTC Kategori √ñzeti
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" id="export-iptc-similarity"> Benzerlik Matrisi
                                </label>
                            </div>
                        </div>
                        
                        <!-- Export Butonlarƒ± -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="run-btn" style="background: #FF9800;" onclick="exportIPTCMappingJSON()">
                                üìã JSON ƒ∞ndir
                            </button>
                            <button class="run-btn" style="background: #E91E63;" onclick="exportIPTCMappingCSV()">
                                üìÑ CSV ƒ∞ndir
                            </button>
                        </div>
                        
                        <!-- Grafik Export -->
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                            <h5 style="color: #FF9800; margin-bottom: 10px;">üìà Grafik Export</h5>
                            <div style="margin-bottom: 10px;">
                                <label style="font-weight: 600; color: #333; display: block; margin-bottom: 8px;">Grafik Se√ßin:</label>
                                <select id="export-chart-select" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em;">
                                    <option value="iptc-distribution-chart">üìä IPTC Kategori Daƒüƒ±lƒ±mƒ±</option>
                                    <option value="country-theme-chart">üåç √úlke Bazlƒ± Tema Hacmi</option>
                                    <option value="top-themes-chart">üìà En Y√ºksek Hacimli Temalar</option>
                                    <option value="iptc-similarity-chart">üéØ IPTC Benzerlik Skorlarƒ±</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="run-btn" style="background: #9C27B0;" onclick="exportChartPNG()">
                                    üñºÔ∏è PNG ƒ∞ndir
                                </button>
                                <button class="run-btn" style="background: #673AB7;" onclick="exportChartSVG()">
                                    üìê SVG ƒ∞ndir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- TOPLU EXPORT B√ñL√úM√ú -->
                <div class="chart-container" style="margin-top: 20px; border-left: 4px solid #0f3460;">
                    <h4 style="color: #0f3460; margin-bottom: 15px;">üì¶ Toplu Dƒ±≈üarƒ± Aktarma</h4>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">T√ºm GDELT tema verilerini ve IPTC e≈üle≈ütirmelerini tek seferde dƒ±≈üarƒ± aktarƒ±n.</p>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="run-btn" style="background: #0f3460;" onclick="exportAllGDELTData()">
                            üìä T√ºm Verileri ƒ∞ndir (XLSX)
                        </button>
                        <button class="run-btn" style="background: #00BCD4;" onclick="exportAllChartsPNG()">
                            üñºÔ∏è T√ºm Grafikleri ƒ∞ndir (PNG)
                        </button>
                        <button class="run-btn" style="background: #795548;" onclick="exportFullReport()">
                            üìë Tam Rapor (ZIP)
                        </button>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 5px;">
                        <p style="font-size: 0.85em; color: #666; margin: 0;">
                            <strong>üí° ƒ∞pucu:</strong> Toplu export, GDELT tema analizi ve IPTC e≈üle≈ütirme sonu√ßlarƒ±nƒ± i√ßerir. 
                            √ñnce GDELT Tema sekmesinden CSV y√ºkleyin ve K√ºmeleme sekmesinden IPTC e≈üle≈ütirmesini √ßalƒ±≈ütƒ±rƒ±n.
                        </p>
                    </div>
                </div>
            </div>
        </div>
                            üñºÔ∏è T√ºm Grafikleri ƒ∞ndir (PNG)
                        </button>
                        <button class="run-btn" style="background: #795548;" onclick="exportFullLatexReport()">
                            üìÑ Tam LaTeX Raporu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let allData = [];
        let currentMethod = 'pearson';
        let currentFilter = 'all';
        let currentVariableMode = 'gdp-independent'; // 'gdp-independent' or 'happiness-independent'
        let chartsInitialized = false;
        let chartInstances = [];
        
        // KaTeX render fonksiyonu
        function renderKaTeX() {
            setTimeout(() => {
                if (!window.katex) return;
                
                // Form√ºlleri render et
                document.querySelectorAll('.formula').forEach(el => {
                    try {
                        const content = el.textContent.trim();
                        if (content.startsWith('$$') && content.endsWith('$$')) {
                            const formula = content.slice(2, -2);
                            el.textContent = '';
                            katex.render(formula, el, { displayMode: true, throwOnError: false });
                        }
                    } catch (e) {
                        console.log('KaTeX render error:', e);
                    }
                });
                
                // Parametrelerin sembollerini render et
                document.querySelectorAll('.param-symbol').forEach(el => {
                    try {
                        const symbol = el.textContent.trim();
                        if (symbol) {
                            el.textContent = '';
                            katex.render(symbol, el, { displayMode: false, throwOnError: false });
                        }
                    } catch (e) {
                        console.log('KaTeX symbol render error:', e);
                    }
                });
            }, 100);
        }
        
        // Dinamik info box'ƒ± g√ºncelle
        function updateInfoBox() {
            const infoBox = document.getElementById('dynamic-info-box');
            const startYear = parseInt(document.getElementById('start-year').value);
            const endYear = parseInt(document.getElementById('end-year').value);
            const happinessSource = document.getElementById('happiness-source').value;
            
            const sourceText = happinessSource === 'ourworldindata' 
                ? 'Our World in Data (Cantril Ladder)' 
                : 'World Happiness Report (Life Satisfaction)';
            
            // Baƒüƒ±msƒ±z/baƒüƒ±mlƒ± deƒüi≈ükenleri belirle
            let independentVar, dependentVar;
            if (currentVariableMode === 'gdp-independent') {
                independentVar = 'GDP per Capita';
                dependentVar = 'Mutluluk Endeksi';
            } else {
                independentVar = 'Mutluluk Endeksi';
                dependentVar = 'GDP per Capita';
            }
            
            const methodInfo = {
                pearson: {
                    icon: 'üìà',
                    name: 'Pearson Korelasyon Katsayƒ±sƒ± (r)',
                    description: 'Lineer (doƒürusal) ili≈ükiyi √∂l√ßer. Normal daƒüƒ±lmƒ±≈ü veriler i√ßin en uygun y√∂ntemdir.',
                    formula: 'r = \\frac{\\sum(x_i - \\bar{x})(y_i - \\bar{y})}{\\sqrt{\\sum(x_i - \\bar{x})^2 \\sum(y_i - \\bar{y})^2}}',
                    parameters: [
                        { symbol: 'r', desc: 'Pearson korelasyon katsayƒ±sƒ± (-1 ile +1 arasƒ±nda)' },
                        { symbol: 'x_i', desc: `Baƒüƒ±msƒ±z deƒüi≈ükenin (${independentVar}) g√∂zlem deƒüerleri` },
                        { symbol: '\\bar{x}', desc: `Baƒüƒ±msƒ±z deƒüi≈ükenin (${independentVar}) ortalamasƒ±` },
                        { symbol: 'y_i', desc: `Baƒüƒ±mlƒ± deƒüi≈ükenin (${dependentVar}) g√∂zlem deƒüerleri` },
                        { symbol: '\\bar{y}', desc: `Baƒüƒ±mlƒ± deƒüi≈ükenin (${dependentVar}) ortalamasƒ±` },
                        { symbol: '\\Sigma', desc: 'Toplama operat√∂r√º' }
                    ]
                },
                spearman: {
                    icon: 'üîó',
                    name: 'Spearman Sƒ±ra Korelasyonu (œÅ)',
                    description: 'Monoton (artan veya azalan) ili≈ükileri √∂l√ßer. Parametrik olmayan, aykƒ±rƒ± deƒüerlere diren√ßli.',
                    formula: '\\rho = 1 - \\frac{6 \\sum d_i^2}{n(n^2 - 1)}',
                    parameters: [
                        { symbol: '\\rho', desc: 'Spearman sƒ±ra korelasyon katsayƒ±sƒ± (-1 ile +1 arasƒ±nda)' },
                        { symbol: 'd_i', desc: 'Her √ßiftin sƒ±ralamalarƒ±ndaki fark (rank difference)' },
                        { symbol: 'n', desc: 'G√∂zlem sayƒ±sƒ± (veri noktasƒ± sayƒ±sƒ±)' },
                        { symbol: '\\sum d_i^2', desc: 'Sƒ±ra farklarƒ± karelerinin toplamƒ±' }
                    ]
                },
                kendall: {
                    icon: 'üéØ',
                    name: 'Kendall\'s Tau (œÑ)',
                    description: 'Parametrik olmayan, sƒ±ra tabanlƒ±. K√º√ß√ºk √∂rneklemler i√ßin uygun, daha g√ºvenilir standart hatalar.',
                    formula: '\\tau = \\frac{n_c - n_d}{\\frac{n(n-1)}{2}}',
                    parameters: [
                        { symbol: '\\tau', desc: 'Kendall\'s tau katsayƒ±sƒ± (-1 ile +1 arasƒ±nda)' },
                        { symbol: 'n_c', desc: 'Uyumlu √ßift sayƒ±sƒ± (concordant pairs)' },
                        { symbol: 'n_d', desc: 'Uyumsuz √ßift sayƒ±sƒ± (discordant pairs)' },
                        { symbol: 'n', desc: 'Toplam g√∂zlem sayƒ±sƒ±' }
                    ]
                }
            };
            
            const method = methodInfo[currentMethod];
            
            let parametersHTML = '';
            method.parameters.forEach(param => {
                parametersHTML += `<div class="param-item"><span class="param-symbol">${param.symbol}</span> = ${param.desc}</div>`;
            });
            
            infoBox.innerHTML = `
                <h4>${method.icon} ${method.name}</h4>
                <p><strong>A√ßƒ±klama:</strong> ${method.description}</p>
                
                <p style="margin-top: 10px; padding: 10px; background: #f0f4ff; border-radius: 5px; border-left: 3px solid #667eea;">
                    <strong>üìä Analiz Perspektifi:</strong> 
                    <br>Baƒüƒ±msƒ±z Deƒüi≈üken: <strong>${independentVar}</strong>
                    <br>Baƒüƒ±mlƒ± Deƒüi≈üken: <strong>${dependentVar}</strong>
                </p>
                
                <div class="formula-container">
                    <div class="formula-title">Matematiksel Denklem</div>
                    <div class="formula">$$${method.formula}$$</div>
                </div>
                
                <div class="parameters-list">
                    <h5>Parametrelerin Anlamlarƒ±</h5>
                    ${parametersHTML}
                </div>
                
                <p style="margin-top: 15px;"><strong>üìã Analiz Parametreleri:</strong></p>
                <p>üìÖ <strong>D√∂nem:</strong> ${startYear}-${endYear} (${endYear - startYear + 1} yƒ±l)</p>
                <p>üìä <strong>Veri Kaynaƒüƒ±:</strong> ${sourceText}</p>
            `;
            
            // KaTeX render et
            renderKaTeX();
        }
        
        // Durum mesajƒ± g√∂ster
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
        }
        
        // Analiz √ßalƒ±≈ütƒ±r
        async function runAnalysis() {
            const startYear = parseInt(document.getElementById('start-year').value);
            const endYear = parseInt(document.getElementById('end-year').value);
            const happinessSource = document.getElementById('happiness-source').value;
            const economicIndicator = document.getElementById('economic-indicator').value;
            
            if (startYear > endYear) {
                showStatus('‚ùå Ba≈ülangƒ±√ß yƒ±lƒ± biti≈ü yƒ±lƒ±ndan sonra olamaz!', 'error');
                return;
            }
            
            const runBtn = document.getElementById('run-analysis-btn');
            runBtn.disabled = true;
            runBtn.innerHTML = '<span class="loading-spinner"></span>Analiz √áalƒ±≈üƒ±yor...';
            
            const indicatorLabel = economicIndicator === 'gdp' ? 'Toplam GDP' : 'GDP per Capita';
            showStatus(`üîÑ Analiz ba≈ülatƒ±lƒ±yor (${startYear}-${endYear}, ${happinessSource}, ${indicatorLabel})...`, 'info');
            
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        start_year: startYear,
                        end_year: endYear,
                        happiness_source: happinessSource,
                        economic_indicator: economicIndicator
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success === false) {
                    showStatus(`‚ùå Hata: ${data.error}`, 'error');
                    return;
                }
                
                // Verileri g√ºncelle
                allData = data.results || [];
                
                // √ñzet istatistikleri g√ºncelle
                document.getElementById('total-countries').textContent = data.summary.total_countries;
                document.getElementById('significant-countries').textContent = data.summary.significant_countries;
                document.getElementById('year-range').textContent = data.summary.year_range;
                
                const validData = allData.filter(item => item.pearson_r !== null && !isNaN(item.pearson_r));
                const avgPearson = validData.length > 0 
                    ? (validData.reduce((sum, item) => sum + item.pearson_r, 0) / validData.length).toFixed(3)
                    : 0;
                document.getElementById('avg-correlation').textContent = avgPearson;
                
                // Grafikler √∂nceki instanslarƒ± sil
                chartInstances.forEach(chart => {
                    if (chart) chart.destroy();
                });
                chartInstances = [];
                chartsInitialized = false;
                
                renderTable(allData);
                renderCharts();
                attachEventListeners();
                updateInfoBox();
                updateExportFilterInfo();  // Export filtre bilgisini g√ºncelle
                
                showStatus(`‚úÖ Analiz tamamlandƒ±! ${data.summary.total_countries} √ºlke analiz edildi.`, 'success');
                
            } catch (error) {
                console.error('Analiz hatasƒ±:', error);
                showStatus(`‚ùå Analiz ba≈üarƒ±sƒ±z: ${error.message}`, 'error');
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = 'üöÄ Analizi √áalƒ±≈ütƒ±r';
            }
        }
        
        // Sƒ±fƒ±rla
        let currentPipelineType = 'both';  // "multivariate", "score_only", "both"
        
        // Cluster badge olu≈ütur
        function getClusterBadge(item) {
            const clusterGroup = item.multivar_happiness_group || item.score_happiness_group || null;
            
            if (!clusterGroup) {
                return '<span style="background: #9e9e9e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.85em;">‚Äî</span>';
            }
            
            const colors = {
                'low': { bg: '#f44336', text: 'D√º≈ü√ºk', icon: 'üî¥' },
                'medium': { bg: '#ff9800', text: 'Orta', icon: 'üü°' },
                'high': { bg: '#4caf50', text: 'Y√ºksek', icon: 'üü¢' }
            };
            
            const config = colors[clusterGroup] || { bg: '#9e9e9e', text: clusterGroup, icon: '‚ö™' };
            return `<span style="background: ${config.bg}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.85em;">${config.icon} ${config.text}</span>`;
        }
        
        // Pipeline se√ßim butonlarƒ±
        function initPipelineButtons() {
            document.querySelectorAll('.pipeline-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Aktif sƒ±nƒ±fƒ± g√ºncelle
                    document.querySelectorAll('.pipeline-btn').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'white';
                        b.style.color = b.dataset.pipeline === 'both' ? '#667eea' : 
                                        b.dataset.pipeline === 'multivariate' ? '#4CAF50' : '#FF9800';
                    });
                    this.classList.add('active');
                    
                    // Buton stilini g√ºncelle
                    if (this.dataset.pipeline === 'both') {
                        this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    } else if (this.dataset.pipeline === 'multivariate') {
                        this.style.background = '#4CAF50';
                    } else {
                        this.style.background = '#FF9800';
                    }
                    this.style.color = 'white';
                    
                    currentPipelineType = this.dataset.pipeline;
                    
                    // A√ßƒ±klama panelini g√ºncelle
                    document.querySelectorAll('.pipeline-desc').forEach(desc => {
                        desc.style.display = 'none';
                    });
                    document.getElementById('pipeline-info-' + currentPipelineType).style.display = 'block';
                });
            });
        }
        
        // Mutluluk K√ºmelendirmesi
        async function runClustering() {
            const btn = document.getElementById('clustering-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>K√ºmeleniyor...';
            
            showStatus(`ü§ñ ${currentPipelineType === 'both' ? 'Her iki pipeline' : currentPipelineType} k√ºmeleme ba≈ülatƒ±lƒ±yor...`, 'info');
            
            try {
                const startYear = parseInt(document.getElementById('start-year').value) || 2013;
                const endYear = parseInt(document.getElementById('end-year').value) || 2023;
                
                const response = await fetch('/api/clustering', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pipeline_type: currentPipelineType,
                        start_year: startYear,
                        end_year: endYear
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    showStatus(`‚ùå K√ºmelendirme hatasƒ±: ${result.error}`, 'error');
                    return;
                }
                
                // K√ºmeleme sonucunu sakla
                lastClusteringResult = result;
                
                // Veriyi yeniden y√ºkle
                await loadData();
                
                // Clustering grafiklerini g√∂ster
                renderDualClusteringCharts(result);
                showStatus(`‚úÖ K√ºmelendirme tamamlandƒ±!`, 'success');
                
            } catch (error) {
                console.error('K√ºmelendirme hatasƒ±:', error);
                showStatus(`‚ùå K√ºmelendirme ba≈üarƒ±sƒ±z: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ü§ñ K√ºmelemeyi √áalƒ±≈ütƒ±r';
            }
        }
        
        // Dual Clustering grafiklerini renderla
        function renderDualClusteringCharts(apiResult) {
            const pipelines = apiResult.pipelines || {};
            
            // Container'larƒ± g√∂ster/gizle
            const multivarContainer = document.getElementById('multivar-chart-container');
            const scoreContainer = document.getElementById('score-chart-container');
            const comparisonSection = document.getElementById('comparison-section');
            
            // Multivariate varsa g√∂ster
            if (pipelines.multivariate || currentPipelineType === 'multivariate' || currentPipelineType === 'both') {
                multivarContainer.style.display = 'block';
                
                const mv = pipelines.multivariate;
                
                // 1. PCA scatter plot √ßiz
                if (mv && mv.pca_data) {
                    renderPCAScatterChart(mv.pca_data, mv.pca_explained_variance);
                }
                
                // 2. GDP vs Happiness scatter plot √ßiz
                if (mv && mv.scatter_data) {
                    renderGDPHappinessScatterChart(mv.scatter_data);
                }
                
                // 3. Validasyon metriklerini g√ºncelle
                if (mv && mv.validation) {
                    document.getElementById('sil-k2').textContent = mv.validation.silhouette_k2?.toFixed(4) || '-';
                    document.getElementById('sil-k3').textContent = mv.validation.silhouette_k3?.toFixed(4) || '-';
                    document.getElementById('sil-k4').textContent = mv.validation.silhouette_k4?.toFixed(4) || '-';
                    document.getElementById('inertia-value').textContent = mv.validation.inertia?.toFixed(2) || '-';
                    
                    // K√ºme boyutlarƒ±nƒ± g√ºncelle
                    const sizes = mv.validation.cluster_sizes || [];
                    // Cluster_means'ten label e≈üle≈ütirmesi yap
                    if (mv.cluster_means) {
                        for (const [clusterId, data] of Object.entries(mv.cluster_means)) {
                            if (data.label === 'low') {
                                document.getElementById('cluster-size-low').textContent = data.size;
                            } else if (data.label === 'medium') {
                                document.getElementById('cluster-size-med').textContent = data.size;
                            } else if (data.label === 'high') {
                                document.getElementById('cluster-size-high').textContent = data.size;
                            }
                        }
                    }
                }
                
                // 4. Model metriklerini g√ºncelle
                if (mv) {
                    document.getElementById('mv-rf-r2').textContent = mv.rf_test_r2?.toFixed(4) || '-';
                    document.getElementById('mv-xgb-r2').textContent = mv.xgb_test_r2?.toFixed(4) || '-';
                    document.getElementById('mv-features').textContent = (mv.features_used || []).join(', ');
                }
                
                // 5. K√ºme ortalamalarƒ± tablosunu olu≈ütur
                if (mv && mv.cluster_means) {
                    renderClusterMeansTable(mv.cluster_means, mv.features_used);
                }
                
            } else {
                multivarContainer.style.display = 'none';
            }
            
            // Score-only varsa g√∂ster
            if (pipelines.score_only || currentPipelineType === 'score_only' || currentPipelineType === 'both') {
                scoreContainer.style.display = 'block';
                renderScoreOnlyChart();
                
                // Grup istatistiklerini g√ºncelle
                if (pipelines.score_only && pipelines.score_only.group_stats) {
                    const stats = pipelines.score_only.group_stats;
                    document.getElementById('sc-low-avg').textContent = stats.low?.avg_score?.toFixed(2) || '-';
                    document.getElementById('sc-low-n').textContent = stats.low?.size || '-';
                    document.getElementById('sc-med-avg').textContent = stats.medium?.avg_score?.toFixed(2) || '-';
                    document.getElementById('sc-med-n').textContent = stats.medium?.size || '-';
                    document.getElementById('sc-high-avg').textContent = stats.high?.avg_score?.toFixed(2) || '-';
                    document.getElementById('sc-high-n').textContent = stats.high?.size || '-';
                }
            } else {
                scoreContainer.style.display = 'none';
            }
            
            // Her iki pipeline varsa kar≈üƒ±la≈ütƒ±rma tablosunu g√∂ster
            if (currentPipelineType === 'both') {
                comparisonSection.style.display = 'block';
                renderComparisonTable();
            } else {
                comparisonSection.style.display = 'none';
            }
        }
        
        // Multivariate Clustering Chart
        function renderMultivariateChart() {
            const canvas = document.getElementById('multivar-clustering-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Cluster gruplarƒ±nƒ± ayƒ±r
            const clusterGroups = {
                'low': { countries: [], color: '#FF6B6B', label: 'D√º≈ü√ºk Mutluluk' },
                'medium': { countries: [], color: '#FFA500', label: 'Orta Mutluluk' },
                'high': { countries: [], color: '#4CAF50', label: 'Y√ºksek Mutluluk' }
            };
            
            allData.forEach(item => {
                const cluster = item.multivar_happiness_group || item.happiness_cluster || 'unknown';
                const clusterKey = cluster.replace('_happiness', '');
                if (clusterGroups[clusterKey]) {
                    clusterGroups[clusterKey].countries.push({
                        country: item.country,
                        gdp: item.avg_gdp || 0,
                        happiness: item.avg_happiness || 0
                    });
                }
            });
            
            const datasets = Object.keys(clusterGroups).map(key => ({
                label: clusterGroups[key].label,
                data: clusterGroups[key].countries.map(c => ({
                    x: c.gdp,
                    y: c.happiness,
                    label: c.country
                })),
                backgroundColor: clusterGroups[key].color,
                borderColor: clusterGroups[key].color,
                borderWidth: 1
            }));
            
            if (window.multivarChartInstance) {
                window.multivarChartInstance.destroy();
            }
            
            window.multivarChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.raw.label || `GDP: ${ctx.raw.x.toFixed(0)}, Score: ${ctx.raw.y.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Ortalama GDP per Capita ($)' } },
                        y: { title: { display: true, text: 'Ortalama Mutluluk Skoru' } }
                    }
                }
            });
        }
        
        // PCA Scatter Chart (G√∂rsel gibi - Dim1 vs Dim2)
        function renderPCAScatterChart(pcaData, explainedVariance) {
            const canvas = document.getElementById('pca-scatter-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Variance bilgisini g√ºncelle
            if (explainedVariance && explainedVariance.length >= 2) {
                document.getElementById('pca-dim1-var').textContent = `Dim1: ${explainedVariance[0].toFixed(1)}%`;
                document.getElementById('pca-dim2-var').textContent = `Dim2: ${explainedVariance[1].toFixed(1)}%`;
            }
            
            // Cluster'lara g√∂re grupla (g√∂rsel renklerine uygun)
            const clusterGroups = {
                'low': { points: [], color: 'rgba(244, 114, 114, 0.8)', borderColor: '#F47272', label: 'Cluster 1 (D√º≈ü√ºk)', pointStyle: 'circle' },
                'medium': { points: [], color: 'rgba(76, 175, 80, 0.8)', borderColor: '#4CAF50', label: 'Cluster 2 (Orta)', pointStyle: 'triangle' },
                'high': { points: [], color: 'rgba(66, 133, 244, 0.8)', borderColor: '#4285F4', label: 'Cluster 3 (Y√ºksek)', pointStyle: 'rectRot' }
            };
            
            pcaData.forEach(item => {
                const group = item.happiness_group || 'unknown';
                if (clusterGroups[group]) {
                    clusterGroups[group].points.push({
                        x: item.dim1,
                        y: item.dim2,
                        country: item.country,
                        iso3: item.iso3
                    });
                }
            });
            
            const datasets = Object.keys(clusterGroups).map((key, idx) => ({
                label: clusterGroups[key].label,
                data: clusterGroups[key].points.map(p => ({
                    x: p.x,
                    y: p.y,
                    label: p.country
                })),
                backgroundColor: clusterGroups[key].color,
                borderColor: clusterGroups[key].borderColor,
                borderWidth: 1.5,
                pointRadius: 7,
                pointHoverRadius: 10,
                pointStyle: clusterGroups[key].pointStyle
            }));
            
            if (window.pcaChartInstance) {
                window.pcaChartInstance.destroy();
            }
            
            window.pcaChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 12, weight: '500' }
                            }
                        },
                        title: {
                            display: true,
                            text: 'K-Means Clustering (K=3) with PCA',
                            font: { size: 16, weight: 'bold' },
                            color: '#333',
                            padding: { bottom: 15 }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleFont: { size: 13 },
                            bodyFont: { size: 12 },
                            padding: 10,
                            callbacks: {
                                title: ctx => ctx[0].raw.label,
                                label: ctx => `Dim1: ${ctx.raw.x.toFixed(2)}, Dim2: ${ctx.raw.y.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { 
                                display: true, 
                                text: explainedVariance ? `Dim1 (${explainedVariance[0].toFixed(1)}%)` : 'Dim1',
                                font: { weight: 'bold', size: 13 },
                                color: '#333'
                            },
                            grid: { color: 'rgba(0,0,0,0.08)' },
                            ticks: { color: '#666' }
                        },
                        y: { 
                            title: { 
                                display: true, 
                                text: explainedVariance ? `Dim2 (${explainedVariance[1].toFixed(1)}%)` : 'Dim2',
                                font: { weight: 'bold', size: 13 },
                                color: '#333'
                            },
                            grid: { color: 'rgba(0,0,0,0.08)' },
                            ticks: { color: '#666' }
                        }
                    }
                }
            });
        }
        
        // GDP vs Happiness Scatter Chart
        function renderGDPHappinessScatterChart(scatterData) {
            const canvas = document.getElementById('gdp-happiness-scatter-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Cluster'lara g√∂re grupla
            const clusterGroups = {
                'low': { points: [], color: 'rgba(244, 114, 114, 0.8)', borderColor: '#F47272', label: 'D√º≈ü√ºk Mutluluk', pointStyle: 'circle' },
                'medium': { points: [], color: 'rgba(76, 175, 80, 0.8)', borderColor: '#4CAF50', label: 'Orta Mutluluk', pointStyle: 'triangle' },
                'high': { points: [], color: 'rgba(66, 133, 244, 0.8)', borderColor: '#4285F4', label: 'Y√ºksek Mutluluk', pointStyle: 'rectRot' }
            };
            
            scatterData.forEach(item => {
                const group = item.happiness_group || 'unknown';
                if (clusterGroups[group]) {
                    clusterGroups[group].points.push({
                        x: item.gdp,
                        y: item.happiness,
                        country: item.country
                    });
                }
            });
            
            const datasets = Object.keys(clusterGroups).map((key, idx) => ({
                label: clusterGroups[key].label,
                data: clusterGroups[key].points.map(p => ({
                    x: p.x,
                    y: p.y,
                    label: p.country
                })),
                backgroundColor: clusterGroups[key].color,
                borderColor: clusterGroups[key].borderColor,
                borderWidth: 1.5,
                pointRadius: 7,
                pointHoverRadius: 10,
                pointStyle: clusterGroups[key].pointStyle
            }));
            
            if (window.gdpHappinessChartInstance) {
                window.gdpHappinessChartInstance.destroy();
            }
            
            window.gdpHappinessChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11, weight: '500' }
                            }
                        },
                        title: {
                            display: true,
                            text: 'GDP per Capita vs Mutluluk Skoru',
                            font: { size: 14, weight: 'bold' },
                            color: '#333',
                            padding: { bottom: 10 }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleFont: { size: 13 },
                            bodyFont: { size: 12 },
                            padding: 10,
                            callbacks: {
                                title: ctx => ctx[0].raw.label,
                                label: ctx => `GDP: ${ctx.raw.x.toFixed(2)}, Score: ${ctx.raw.y.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { 
                                display: true, 
                                text: 'Logged GDP per Capita',
                                font: { weight: 'bold', size: 12 },
                                color: '#333'
                            },
                            grid: { color: 'rgba(0,0,0,0.08)' },
                            ticks: { color: '#666' }
                        },
                        y: { 
                            title: { 
                                display: true, 
                                text: 'Ladder Score (Mutluluk)',
                                font: { weight: 'bold', size: 12 },
                                color: '#333'
                            },
                            grid: { color: 'rgba(0,0,0,0.08)' },
                            ticks: { color: '#666' }
                        }
                    }
                }
            });
        }
        
        // K√ºme Ortalamalarƒ± Tablosu
        function renderClusterMeansTable(clusterMeans, features) {
            const tbody = document.getElementById('cluster-means-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Her √∂zellik i√ßin satƒ±r olu≈ütur
            const featureNames = features || [];
            
            // Cluster'larƒ± label'a g√∂re sƒ±rala
            const sortedClusters = Object.entries(clusterMeans).sort((a, b) => {
                const order = { 'low': 0, 'medium': 1, 'high': 2 };
                return order[a[1].label] - order[b[1].label];
            });
            
            featureNames.forEach(feature => {
                const row = document.createElement('tr');
                
                // √ñzellik adƒ±
                const featureCell = document.createElement('td');
                featureCell.style.cssText = 'padding: 6px 8px; font-weight: 500; border-bottom: 1px solid #ddd;';
                featureCell.textContent = feature.replace('Logged ', '').replace(' to make life choices', '');
                row.appendChild(featureCell);
                
                // Her cluster i√ßin deƒüer
                sortedClusters.forEach(([clusterId, data]) => {
                    const valueCell = document.createElement('td');
                    valueCell.style.cssText = 'padding: 6px 8px; text-align: center; border-bottom: 1px solid #ddd;';
                    const value = data.means[feature];
                    valueCell.textContent = value !== undefined ? value.toFixed(3) : '-';
                    row.appendChild(valueCell);
                });
                
                tbody.appendChild(row);
            });
        }
        
        // Score-Only Clustering Chart
        function renderScoreOnlyChart() {
            const canvas = document.getElementById('score-clustering-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            const clusterGroups = {
                'low': { countries: [], color: '#FF6B6B', label: 'D√º≈ü√ºk Mutluluk' },
                'medium': { countries: [], color: '#FFA500', label: 'Orta Mutluluk' },
                'high': { countries: [], color: '#4CAF50', label: 'Y√ºksek Mutluluk' }
            };
            
            allData.forEach(item => {
                const cluster = item.score_happiness_group || item.happiness_cluster || 'unknown';
                const clusterKey = cluster.replace('_happiness', '');
                if (clusterGroups[clusterKey]) {
                    clusterGroups[clusterKey].countries.push({
                        country: item.country,
                        happiness: item.avg_happiness || 0,
                        index: clusterGroups[clusterKey].countries.length
                    });
                }
            });
            
            // Box plot benzeri g√∂rselle≈ütirme - horizontal bar
            const datasets = Object.keys(clusterGroups).map((key, idx) => ({
                label: clusterGroups[key].label,
                data: clusterGroups[key].countries.map((c, i) => ({
                    x: c.happiness,
                    y: idx + (Math.random() * 0.6 - 0.3),  // Jitter
                    label: c.country
                })),
                backgroundColor: clusterGroups[key].color,
                borderColor: clusterGroups[key].color,
                borderWidth: 1,
                pointRadius: 5
            }));
            
            if (window.scoreChartInstance) {
                window.scoreChartInstance.destroy();
            }
            
            window.scoreChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.raw.label}: ${ctx.raw.x.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Ladder Score (Mutluluk)' },
                            min: 2,
                            max: 8
                        },
                        y: { 
                            title: { display: true, text: 'K√ºme' },
                            ticks: {
                                callback: function(value) {
                                    const labels = ['D√º≈ü√ºk', 'Orta', 'Y√ºksek'];
                                    return labels[Math.round(value)] || '';
                                }
                            },
                            min: -0.5,
                            max: 2.5
                        }
                    }
                }
            });
        }
        
        // Kar≈üƒ±la≈ütƒ±rma tablosu
        function renderComparisonTable() {
            const tbody = document.getElementById('comparison-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const colorMap = {
                'low': '#FF6B6B',
                'medium': '#FFA500', 
                'high': '#4CAF50'
            };
            
            allData.slice(0, 50).forEach(item => {  // ƒ∞lk 50 √ºlke
                const mvGroup = (item.multivar_happiness_group || item.happiness_cluster || '').replace('_happiness', '');
                const scGroup = (item.score_happiness_group || item.happiness_cluster || '').replace('_happiness', '');
                
                const match = mvGroup === scGroup;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 10px;">${item.country || item.iso3}</td>
                    <td style="padding: 10px; text-align: center;">
                        <span style="background: ${colorMap[mvGroup] || '#ccc'}; color: white; padding: 3px 8px; border-radius: 4px;">${mvGroup || '-'}</span>
                    </td>
                    <td style="padding: 10px; text-align: center;">
                        <span style="background: ${colorMap[scGroup] || '#ccc'}; color: white; padding: 3px 8px; border-radius: 4px;">${scGroup || '-'}</span>
                    </td>
                    <td style="padding: 10px; text-align: center;">
                        ${match ? '‚úÖ' : '‚ùå'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Eski runClustering fonksiyonunu kaldƒ±r ve renderClusteringChart'ƒ± g√ºncelle
        function renderClusteringChart() {
            // Eski fonksiyon - geriye uyumluluk i√ßin
            renderMultivariateChart();
        }
        
        function resetAnalysis() {
            document.getElementById('start-year').value = 2013;
            document.getElementById('end-year').value = 2023;
            document.getElementById('happiness-source').value = 'ourworldindata';
            document.getElementById('search').value = '';
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-filter="all"]').classList.add('active');
            showStatus('', '');
            updateInfoBox();
            loadData();
        }
        
        // Veri y√ºkleme (varsayƒ±lan veriler)
        async function loadData() {
            try {
                const data = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', 'data.json', true);
                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            resolve(JSON.parse(xhr.responseText));
                        } else {
                            reject('Veri y√ºklenirken hata olu≈ütu');
                        }
                    };
                    xhr.onerror = () => reject('Aƒü hatasƒ±');
                    xhr.send();
                });
                
                if (data.results && data.results.length > 0) {
                    allData = data.results || [];
                    
                    // √ñzet istatistikleri g√ºncelle
                    document.getElementById('total-countries').textContent = data.summary?.total_countries || 0;
                    document.getElementById('significant-countries').textContent = data.summary?.significant_countries || 0;
                    document.getElementById('year-range').textContent = data.summary?.year_range || '2013-2023';
                    
                    const validData = allData.filter(item => item.pearson_r !== null && !isNaN(item.pearson_r));
                    const avgPearson = validData.length > 0 
                        ? (validData.reduce((sum, item) => sum + item.pearson_r, 0) / validData.length).toFixed(3)
                        : 0;
                    document.getElementById('avg-correlation').textContent = avgPearson;
                    
                    // Model metrikleri y√ºkle
                    if (data.clustering && data.clustering.model_metrics) {
                        const metrics = data.clustering.model_metrics;
                        const metricsPanel = document.getElementById('model-metrics');
                        if (metricsPanel) {
                            document.getElementById('metric-test-r2').textContent = metrics.test_r2?.toFixed(4) || '-';
                            document.getElementById('metric-test-rmse').textContent = metrics.test_rmse?.toFixed(4) || '-';
                            document.getElementById('metric-test-mae').textContent = metrics.test_mae?.toFixed(4) || '-';
                            metricsPanel.style.display = 'block';
                        }
                    }
                    
                    renderTable(allData);
                    attachEventListeners();
                    showStatus('‚úÖ Varsayƒ±lan veriler y√ºklendi', 'success');
                }
            } catch (error) {
                document.getElementById('data-table').innerHTML = 
                    '<tr><td colspan="10" style="text-align: center; padding: 20px;">üìã Hen√ºz veri yok. "Analizi √áalƒ±≈ütƒ±r" butonuna tƒ±klayƒ±n.</td></tr>';
            }
        }
        
        // Tabloyu olu≈ütur
        function renderTable(data) {
            const tbody = document.getElementById('data-table');
            tbody.innerHTML = '';
            
            let rank = 1;
            data.forEach((item, index) => {
                // Sadece korelasyon deƒüeri olan satƒ±rlarƒ± g√∂ster
                if (item.pearson_r === null || isNaN(item.pearson_r)) {
                    return;  // Bu satƒ±rƒ± atla
                }
                
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                
                const isPearsonSignificant = item.pearson_p !== null && item.pearson_p < 0.05;
                if (isPearsonSignificant) {
                    row.classList.add('significant');
                }
                
                const pearsonClass = item.pearson_r >= 0 ? 'positive' : 'negative';
                
                // Status kontrol√º
                const statusBadge = item.status === 'eksik_sonu√ß' 
                    ? '<span style="background-color: #ff9800; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">‚ö†Ô∏è Eksik Sonu√ß</span>'
                    : '<span style="background-color: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">‚úì Tam</span>';
                
                row.innerHTML = `
                    <td>${rank++}</td>
                    <td><strong>${item.iso3 || 'N/A'}</strong></td>
                    <td>${item.country || 'Unknown'}</td>
                    <td>${statusBadge}</td>
                    <td class="${pearsonClass}">${(item.pearson_r !== null ? item.pearson_r.toFixed(4) : 'N/A')}</td>
                    <td>${(item.spearman_r !== null ? item.spearman_r.toFixed(4) : 'N/A')}</td>
                    <td>${(item.kendall_tau !== null ? item.kendall_tau.toFixed(4) : 'N/A')}</td>
                    <td>${item.pearson_p !== null ? item.pearson_p.toExponential(2) : 'N/A'}</td>
                    <td>${item.n}</td>
                    <td>$${(item.avg_gdp || 0).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                    <td>${(item.avg_happiness !== null ? item.avg_happiness.toFixed(2) : 'N/A')}</td>
                    <td><strong>${item.gdp_category || 'N/A'}</strong></td>
                    <td><strong>${item.happiness_category || 'N/A'}</strong></td>
                    <td>${getClusterBadge(item)}</td>
                    <td>${item.relationship_type || 'Unknown'}</td>
                `;
                
                // Tƒ±klama event'i ekle
                row.addEventListener('click', () => showCountryDetail(item));
                
                tbody.appendChild(row);
            });
            
            // Eƒüer hi√ßbir satƒ±r eklenmemi≈üse bo≈ü mesaj g√∂ster
            if (tbody.children.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="15" style="text-align: center; padding: 20px; color: #999;">üìã Bu parametreler i√ßin veri bulunmuyor. Farklƒ± yƒ±llarƒ± deneyin.</td>';
                tbody.appendChild(row);
            }
        }
        
        // Tabloyu filtrele ve sƒ±rala
        function filterTable() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            
            // Verileri filtrelemek i√ßin kopya olu≈ütur
            let filteredData = allData.filter(item => {
                // Arama filtresi
                if (searchTerm) {
                    const iso = (item.iso3 || '').toLowerCase();
                    const country = (item.country || '').toLowerCase();
                    if (!iso.includes(searchTerm) && !country.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Korelasyon filtresi
                let correlationValue;
                if (currentMethod === 'pearson') {
                    correlationValue = item.pearson_r;
                } else if (currentMethod === 'spearman') {
                    correlationValue = item.spearman_r;
                } else if (currentMethod === 'kendall') {
                    correlationValue = item.kendall_tau;
                }
                
                // Rich but Sad ve Poor but Happy filtreleri i√ßin korelasyon deƒüeri zorunlu deƒüil
                // Bu filtreler GDP ve mutluluk kategorilerine g√∂re √ßalƒ±≈üƒ±r
                const isSpecialFilter = ['rich-sad', 'rich-sad-v2', 'poor-happy', 'poor-happy-v2'].includes(currentFilter);
                
                if (!isSpecialFilter && (correlationValue === null || isNaN(correlationValue))) return false;
                
                if (currentFilter === 'positive') {
                    return correlationValue > 0;
                } else if (currentFilter === 'negative') {
                    return correlationValue < 0;
                } else if (currentFilter === 'significant') {
                    let pValue;
                    if (currentMethod === 'pearson') {
                        pValue = item.pearson_p;
                    } else if (currentMethod === 'spearman') {
                        pValue = item.spearman_p;
                    } else if (currentMethod === 'kendall') {
                        pValue = item.kendall_p;
                    }
                    return pValue !== null && pValue < 0.05;
                } else if (currentFilter === 'rich-sad') {
                    // Rich But Sad: Y√ºksek gelirli √ºlkeler + D√º≈ü√ºk Mutluluk
                    // K√ºmeleme yapƒ±ldƒ±ysa K-Means sonu√ßlarƒ±nƒ± kullan
                    const happinessLevel = item.multivar_happiness_group || item.score_happiness_group || null;
                    if (happinessLevel) {
                        return item.gdp_category === "High Income" && happinessLevel === "low";
                    }
                    return item.gdp_category === "High Income" && item.happiness_category === "D√º≈ü√ºk Mutluluk";
                } else if (currentFilter === 'rich-sad-v2') {
                    // Rich But Sad v2: Y√ºksek + Orta-√ºst gelirli, ancak Y√ºksek Mutluluk deƒüil
                    const isRichCategory = item.gdp_category === "High Income" || item.gdp_category === "Upper Middle Income";
                    const happinessLevel = item.multivar_happiness_group || item.score_happiness_group || null;
                    if (happinessLevel) {
                        return isRichCategory && happinessLevel !== "high";
                    }
                    const isNotHighHappy = item.happiness_category !== "Y√ºksek Mutluluk";
                    return isRichCategory && isNotHighHappy;
                } else if (currentFilter === 'poor-happy') {
                    // Poor But Happy: D√º≈ü√ºk/orta gelirli ve Y√ºksek Mutluluk
                    const isPoorCategory = item.gdp_category === "Low Income" || item.gdp_category === "Lower Middle Income";
                    const happinessLevel = item.multivar_happiness_group || item.score_happiness_group || null;
                    if (happinessLevel) {
                        return isPoorCategory && happinessLevel === "high";
                    }
                    const isHighHappy = item.happiness_category === "Y√ºksek Mutluluk";
                    return isPoorCategory && isHighHappy;
                } else if (currentFilter === 'poor-happy-v2') {
                    // Poor But Happy v2: D√º≈ü√ºk/orta gelirli, ancak D√º≈ü√ºk Mutluluk deƒüil
                    const isPoorCategory = item.gdp_category === "Low Income" || item.gdp_category === "Lower Middle Income";
                    const happinessLevel = item.multivar_happiness_group || item.score_happiness_group || null;
                    if (happinessLevel) {
                        return isPoorCategory && happinessLevel !== "low";
                    }
                    const isNotLowUnhappy = item.happiness_category !== "D√º≈ü√ºk Mutluluk";
                    return isPoorCategory && isNotLowUnhappy;
                }
                
                return true;
            });
            
            // Se√ßilen y√∂nteme g√∂re sƒ±rala
            if (currentMethod === 'pearson') {
                filteredData.sort((a, b) => {
                    if (currentFilter === 'negative') {
                        return (a.pearson_r || -Infinity) - (b.pearson_r || -Infinity);
                    }
                    // Rich But Sad ve Poor but Happy (her iki versiyon): en d√º≈ü√ºk korelasyondan ba≈ülasƒ±n
                    if (currentFilter === 'rich-sad' || currentFilter === 'poor-happy' || currentFilter === 'rich-sad-v2' || currentFilter === 'poor-happy-v2') {
                        return (a.pearson_r || -Infinity) - (b.pearson_r || -Infinity);
                    }
                    return (b.pearson_r || -Infinity) - (a.pearson_r || -Infinity);
                });
            } else if (currentMethod === 'spearman') {
                filteredData.sort((a, b) => {
                    if (currentFilter === 'negative') {
                        return (a.spearman_r || -Infinity) - (b.spearman_r || -Infinity);
                    }
                    if (currentFilter === 'rich-sad' || currentFilter === 'poor-happy' || currentFilter === 'rich-sad-v2' || currentFilter === 'poor-happy-v2') {
                        return (a.spearman_r || -Infinity) - (b.spearman_r || -Infinity);
                    }
                    return (b.spearman_r || -Infinity) - (a.spearman_r || -Infinity);
                });
            } else if (currentMethod === 'kendall') {
                filteredData.sort((a, b) => {
                    if (currentFilter === 'negative') {
                        return (a.kendall_tau || -Infinity) - (b.kendall_tau || -Infinity);
                    }
                    if (currentFilter === 'rich-sad' || currentFilter === 'poor-happy' || currentFilter === 'rich-sad-v2' || currentFilter === 'poor-happy-v2') {
                        return (a.kendall_tau || -Infinity) - (b.kendall_tau || -Infinity);
                    }
                    return (b.kendall_tau || -Infinity) - (a.kendall_tau || -Infinity);
                });
            }
            
            // Tabloyu g√ºncelle
            const tbody = document.getElementById('data-table');
            tbody.innerHTML = '';
            
            let rank = 1;
            filteredData.forEach((item) => {
                const row = document.createElement('tr');
                
                let pValue;
                if (currentMethod === 'pearson') {
                    pValue = item.pearson_p;
                } else if (currentMethod === 'spearman') {
                    pValue = item.spearman_p;
                } else if (currentMethod === 'kendall') {
                    pValue = item.kendall_p;
                }
                
                const isSignificant = pValue !== null && pValue < 0.05;
                if (isSignificant) {
                    row.classList.add('significant');
                }
                
                // Se√ßilen y√∂nteme g√∂re renklendir
                let selectedCorrelationClass = 'positive';
                let selectedCorrelationValue = item.pearson_r;
                
                if (currentMethod === 'spearman') {
                    selectedCorrelationValue = item.spearman_r;
                } else if (currentMethod === 'kendall') {
                    selectedCorrelationValue = item.kendall_tau;
                }
                
                if (selectedCorrelationValue < 0) {
                    selectedCorrelationClass = 'negative';
                }
                
                row.innerHTML = `
                    <td>${rank++}</td>
                    <td><strong>${item.iso3 || 'N/A'}</strong></td>
                    <td>${item.country || 'Unknown'}</td>
                    <td>${item.status === 'eksik_sonu√ß' ? '<span style="background-color: #ff9800; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">‚ö†Ô∏è Eksik Sonu√ß</span>' : '<span style="background-color: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">‚úì Tam</span>'}</td>
                    <td class="${currentMethod === 'pearson' ? selectedCorrelationClass : ''}">${(item.pearson_r !== null ? item.pearson_r.toFixed(4) : 'N/A')}</td>
                    <td class="${currentMethod === 'spearman' ? selectedCorrelationClass : ''}">${(item.spearman_r !== null ? item.spearman_r.toFixed(4) : 'N/A')}</td>
                    <td class="${currentMethod === 'kendall' ? selectedCorrelationClass : ''}">${(item.kendall_tau !== null ? item.kendall_tau.toFixed(4) : 'N/A')}</td>
                    <td>${item.pearson_p !== null ? item.pearson_p.toExponential(2) : 'N/A'}</td>
                    <td>${item.n}</td>
                    <td>$${(item.avg_gdp || 0).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                    <td>${(item.avg_happiness !== null ? item.avg_happiness.toFixed(2) : 'N/A')}</td>
                    <td><strong>${item.gdp_category || 'N/A'}</strong></td>
                    <td><strong>${item.happiness_category || 'N/A'}</strong></td>
                    <td>${getClusterBadge(item)}</td>
                    <td>${item.relationship_type || 'Unknown'}</td>
                `;
                
                // Tƒ±klama event'i ekle
                row.addEventListener('click', () => showCountryDetail(item));
                
                tbody.appendChild(row);
            });
        }
        
        // Grafikler
        function renderCharts() {
            // Canvas'larƒ± boyutlandƒ±r - ATTRIBUTE olarak ayarla (Chart.js i√ßin gerekli)
            const canvases = ['distribution-chart', 'top-chart', 'bottom-chart', 'pvalue-chart'];
            canvases.forEach(canvasId => {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    canvas.width = 500;
                    canvas.height = 300;
                }
            });
            
            // Verinin var olduƒüundan emin ol
            let validData = allData.filter(item => item.pearson_r !== null && !isNaN(item.pearson_r));
            
            if (validData.length === 0) {
                const chartElement = document.getElementById('distribution-chart');
                if (chartElement && chartElement.parentElement) {
                    chartElement.parentElement.innerHTML = '<p style="text-align: center;">Grafik i√ßin veri yok</p>';
                }
                return;
            }
            
            // Se√ßilen method'a g√∂re korelasyon s√ºtununu belirle
            let correlationKey;
            let methodLabel;
            if (currentMethod === 'pearson') {
                correlationKey = 'pearson_r';
                methodLabel = 'Pearson r';
            } else if (currentMethod === 'spearman') {
                correlationKey = 'spearman_r';
                methodLabel = 'Spearman œÅ';
                // Spearman sonu√ßlarƒ± i√ßeren veriyi filtrele
                validData = validData.filter(item => item.spearman_r !== null && !isNaN(item.spearman_r));
            } else if (currentMethod === 'kendall') {
                correlationKey = 'kendall_tau';
                methodLabel = 'Kendall œÑ';
                // Kendall sonu√ßlarƒ± i√ßeren veriyi filtrele
                validData = validData.filter(item => item.kendall_tau !== null && !isNaN(item.kendall_tau));
            }
            
            // Mevcut chart instance'larƒ±nƒ± destroy et
            chartInstances.forEach(chart => {
                if (chart) {
                    chart.destroy();
                }
            });
            chartInstances = [];
            
            // Veriye g√∂re sƒ±rala (en y√ºksekten en d√º≈ü√ºƒüe)
            validData.sort((a, b) => {
                return (b[correlationKey] || -Infinity) - (a[correlationKey] || -Infinity);
            });
            
            // Deƒüi≈üken moduna g√∂re ba≈ülƒ±k ve etiket belirle
            let independentVar = currentVariableMode === 'gdp-independent' ? 'GDP' : 'Mutluluk';
            let dependentVar = currentVariableMode === 'gdp-independent' ? 'Mutluluk' : 'GDP';
            
            // Chart container ba≈ülƒ±klarƒ±nƒ± g√ºncelle
            document.querySelectorAll('.chart-container h3').forEach((el, idx) => {
                if (idx === 0) {
                    el.textContent = `${independentVar} ‚Üí ${dependentVar} ${methodLabel} Daƒüƒ±lƒ±mƒ±`;
                } else if (idx === 1) {
                    el.textContent = `Top 10 Pozitif ${methodLabel} Korelasyon (${independentVar} ‚Üí ${dependentVar})`;
                } else if (idx === 2) {
                    el.textContent = `Bottom 10 Negatif ${methodLabel} Korelasyon (${independentVar} ‚Üí ${dependentVar})`;
                } else if (idx === 3) {
                    el.textContent = `${methodLabel} ƒ∞statistiksel Anlamlƒ±lƒ±k Daƒüƒ±lƒ±mƒ±`;
                }
            });
            
            // Legend'i g√ºncelle
            const legend = document.querySelector('.legend');
            if (legend) {
                legend.innerHTML = `
                    <p><strong>${methodLabel} Korelasyon Yorumu (${independentVar} ‚Üí ${dependentVar}):</strong></p>
                    <p>‚Ä¢ <span class="positive">Pozitif:</span> ${independentVar} arttƒ±k√ßa ${dependentVar} da artar</p>
                    <p>‚Ä¢ <span class="negative">Negatif:</span> ${independentVar} arttƒ±k√ßa ${dependentVar} azalƒ±r</p>
                    <p>‚Ä¢ <strong>ƒ∞statistiksel Anlamlƒ±lƒ±k:</strong> p-value < 0.05 ise sonu√ß istatistiksel olarak anlamlƒ±dƒ±r</p>
                    <p>‚Ä¢ <strong>n:</strong> Analiz edilen yƒ±l sayƒ±sƒ± (minimum 5 yƒ±l gerekli)</p>
                `;
            }
            
            // 1. Daƒüƒ±lƒ±m Histogramƒ±
            const bins = [-1, -0.75, -0.5, -0.25, 0, 0.25, 0.5, 0.75, 1];
            const histCounts = Array(bins.length - 1).fill(0);
            validData.forEach(item => {
                const corrValue = item[correlationKey];
                for (let i = 0; i < bins.length - 1; i++) {
                    if (corrValue >= bins[i] && corrValue < bins[i + 1]) {
                        histCounts[i]++;
                        break;
                    }
                    if (corrValue === 1 && i === bins.length - 2) {
                        histCounts[i]++;
                    }
                }
            });
            
            const distributionElement = document.getElementById('distribution-chart');
            
            if (distributionElement) {
                const ctx1 = distributionElement.getContext('2d');
                
                const chart1 = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: bins.slice(0, -1).map((v, i) => `${v} to ${bins[i + 1]}`),
                        datasets: [{
                            label: '√úlke Sayƒ±sƒ±',
                            data: histCounts,
                            backgroundColor: 'rgba(102, 126, 234, 0.7)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
                chartInstances.push(chart1);
            }
            
            // 2. Top 10
            const top10 = validData.slice(0, 10);
            const topElement = document.getElementById('top-chart');
            if (topElement) {
                const ctx2 = topElement.getContext('2d');
                const chart2 = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: top10.map(d => d.country || d.iso3),
                        datasets: [{
                            label: methodLabel,
                            data: top10.map(d => d[correlationKey]),
                            backgroundColor: 'rgba(39, 174, 96, 0.7)',
                            borderColor: 'rgba(39, 174, 96, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: false,
                        maintainAspectRatio: false,
                        scales: {
                            x: { min: -1, max: 1 }
                        }
                    }
                });
                chartInstances.push(chart2);
            }
            
            // 3. Bottom 10
            const bottom10 = validData.slice(-10).reverse();
            const bottomElement = document.getElementById('bottom-chart');
            if (bottomElement) {
                const ctx3 = bottomElement.getContext('2d');
                const chart3 = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: bottom10.map(d => d.country || d.iso3),
                        datasets: [{
                            label: methodLabel,
                            data: bottom10.map(d => d[correlationKey]),
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: false,
                        maintainAspectRatio: false,
                        scales: {
                            x: { min: -1, max: 1 }
                        }
                    }
                });
                chartInstances.push(chart3);
            }
            
            // 4. P-value Daƒüƒ±lƒ±mƒ±
            let pvalueKey;
            if (currentMethod === 'pearson') {
                pvalueKey = 'pearson_p';
            } else if (currentMethod === 'spearman') {
                pvalueKey = 'spearman_p';
            } else if (currentMethod === 'kendall') {
                pvalueKey = 'kendall_p';
            }
            
            const significant = validData.filter(d => d[pvalueKey] && d[pvalueKey] < 0.05).length;
            const notSignificant = validData.length - significant;
            
            const pvalueElement = document.getElementById('pvalue-chart');
            if (pvalueElement) {
                const ctx4 = pvalueElement.getContext('2d');
                const chart4 = new Chart(ctx4, {
                    type: 'doughnut',
                    data: {
                        labels: ['ƒ∞statistiksel Anlamlƒ± (p<0.05)', 'ƒ∞statistiksel Anlamsƒ±z (p‚â•0.05)'],
                        datasets: [{
                            data: [significant, notSignificant],
                            backgroundColor: ['rgba(39, 174, 96, 0.7)', 'rgba(189, 195, 199, 0.7)'],
                            borderColor: ['rgba(39, 174, 96, 1)', 'rgba(189, 195, 199, 1)'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: false,
                        maintainAspectRatio: false
                    }
                });
                chartInstances.push(chart4);
            }
            
            chartsInitialized = true;
        }
        
        // Olay dinleyicileri
        function attachEventListeners() {
            // Null kontrol ile g√ºvenli ≈üekilde event listener'larƒ± ekle
            const safeAddListener = (id, event, handler) => {
                const element = document.getElementById(id);
                if (element) {
                    element.removeEventListener(event, handler);
                    element.addEventListener(event, handler);
                }
            };
            
            safeAddListener('search', 'input', filterTable);
            safeAddListener('start-year', 'change', updateInfoBox);
            safeAddListener('end-year', 'change', updateInfoBox);
            safeAddListener('happiness-source', 'change', updateInfoBox);
            safeAddListener('economic-indicator', 'change', updateInfoBox);
            safeAddListener('run-analysis-btn', 'click', runAnalysis);
            safeAddListener('reset-btn', 'click', resetAnalysis);
            safeAddListener('clustering-btn', 'click', runClustering);
            safeAddListener('save-btn', 'click', saveAnalysis);
            safeAddListener('import-btn', 'click', triggerImport);
            safeAddListener('import-file-input', 'change', handleImportFile);
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.removeEventListener('click', filterBtnClick);
                btn.addEventListener('click', filterBtnClick);
            });
            
            document.querySelectorAll('.method-tab').forEach(btn => {
                btn.removeEventListener('click', methodBtnClick);
                // Variable toggle button'ƒ± hari√ß tut
                if (!btn.hasAttribute('onclick')) {
                    btn.addEventListener('click', methodBtnClick);
                }
            });
        }
        
        function filterBtnClick(e) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            currentFilter = e.target.dataset.filter;
            filterTable();
        }
        
        function methodBtnClick(e) {
            document.querySelectorAll('.method-tab').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            currentMethod = e.target.dataset.method;
            
            // Info box'ƒ± g√ºncelle
            updateInfoBox();
            
            // Tabloyu yeniden sƒ±rala ve filtrele
            filterTable();
            
            // Grafikleri sil ve yeniden olu≈ütur
            if (chartsInitialized) {
                chartInstances.forEach(chart => chart.destroy());
                chartInstances = [];
                renderCharts();
            }
        }
        
        // Baƒüƒ±msƒ±z/baƒüƒ±mlƒ± deƒüi≈ükenleri deƒüi≈ütir
        function toggleVariableMode() {
            currentVariableMode = currentVariableMode === 'gdp-independent' ? 'happiness-independent' : 'gdp-independent';
            
            const btn = document.getElementById('variable-toggle-btn');
            if (currentVariableMode === 'gdp-independent') {
                btn.textContent = 'üìä GDP ‚Üí Mutluluk';
            } else {
                btn.textContent = 'üòä Mutluluk ‚Üí GDP';
            }
            
            // Grafikleri ve info box'ƒ± g√ºncelle
            updateInfoBox();
            filterTable();
            
            // Eƒüer veriler y√ºklenmi≈üse, grafikleri yeniden olu≈ütur
            if (allData.length > 0 && chartsInitialized) {
                // Grafik instance'larƒ±nƒ± sil
                chartInstances.forEach(chart => chart.destroy());
                chartInstances = [];
                
                // Yeni grafikleri olu≈ütur
                renderCharts();
            }
        }
        
        // √úlke detay g√∂ster
        async function showCountryDetail(countryData) {
            const startYear = parseInt(document.getElementById('start-year').value);
            const endYear = parseInt(document.getElementById('end-year').value);
            const happinessSource = document.getElementById('happiness-source').value;
            const economicIndicator = document.getElementById('economic-indicator').value;
            
            try {
                const response = await fetch('/api/country-detail', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        iso3: countryData.iso3,
                        start_year: startYear,
                        end_year: endYear,
                        happiness_source: happinessSource,
                        economic_indicator: economicIndicator
                    })
                });
                
                const data = await response.json();
                if (!data.success) throw new Error(data.error);
                
                displayCountryDetail(data);
                
                // Detay view'ƒ±nƒ± g√∂ster, analiz bilgisini gizle
                document.getElementById('dynamic-info-box').style.display = 'none';
                document.getElementById('categorization-guide-main').style.display = 'none';
                document.getElementById('country-detail-view').classList.add('active');
                
            } catch (error) {
                showStatus(`‚ùå Detay y√ºkleme hatasƒ±: ${error.message}`, 'error');
            }
        }
        
        function hideCountryDetail() {
            document.getElementById('country-detail-view').classList.remove('active');
            document.getElementById('dynamic-info-box').style.display = 'block';
            document.getElementById('categorization-guide-main').style.display = 'block';
            updateInfoBox();
        }
        
        let currentDetailData = null;
        let detailVariableMode = 'gdp-independent'; // 'gdp-independent' or 'happiness-independent'
        
        function displayCountryDetail(data) {
            currentDetailData = data;
            detailVariableMode = 'gdp-independent';
            renderDetailContent();
        }
        
        function toggleDetailVariableMode() {
            detailVariableMode = detailVariableMode === 'gdp-independent' ? 'happiness-independent' : 'gdp-independent';
            renderDetailContent();
        }
        
        function renderDetailContent() {
            const data = currentDetailData;
            const yearly = data.yearly_data;
            const startYear = yearly[0].year;
            const endYear = yearly[yearly.length - 1].year;
            
            document.getElementById('detail-country-name').innerHTML = `üìç ${data.country} (${data.iso3}) - Detaylƒ± Analiz
            <div style="float: right; font-size: 0.9em; margin-top: 5px;">
                <button onclick="toggleDetailVariableMode()" style="padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    ${detailVariableMode === 'gdp-independent' ? 'üìä GDP ‚Üí Mutluluk' : 'üòä Mutluluk ‚Üí GDP'}
                </button>
            </div>`;
            
            let html = '';
            
            // 1Ô∏è‚É£  Veriler tablosu
            html += '<div class="calculation-section">';
            if (detailVariableMode === 'gdp-independent') {
                html += '<h4>1Ô∏è‚É£  Yƒ±llƒ±k Veriler (Baƒüƒ±msƒ±z: GDP, Baƒüƒ±mlƒ±: Mutluluk)</h4>';
            } else {
                html += '<h4>1Ô∏è‚É£  Yƒ±llƒ±k Veriler (Baƒüƒ±msƒ±z: Mutluluk, Baƒüƒ±mlƒ±: GDP)</h4>';
            }
            html += '<table class="data-table"><thead><tr><th>Yƒ±l</th><th>GDP ($)</th><th>Mutluluk</th></tr></thead><tbody>';
            let gdpSum = 0, happinessSum = 0;
            yearly.forEach(d => {
                html += `<tr><td>${d.year}</td><td>$${d.gdp.toLocaleString('en-US', {maximumFractionDigits: 2})}</td><td>${d.happiness.toFixed(4)}</td></tr>`;
                gdpSum += d.gdp;
                happinessSum += d.happiness;
            });
            html += '</tbody></table>';
            html += `<strong>Veri Noktasƒ± Sayƒ±sƒ± (n):</strong> ${yearly.length}<br>`;
            html += '</div>';
            
            // 2Ô∏è‚É£  Ortalama hesaplamasƒ±
            html += '<div class="calculation-section">';
            html += '<h4>2Ô∏è‚É£  Ortalama Hesaplamasƒ±</h4>';
            const avgGdp = gdpSum / yearly.length;
            const avgHappiness = happinessSum / yearly.length;
            html += '<div class="calculation-steps">';
            if (detailVariableMode === 'gdp-independent') {
                html += `<div class="calculation-step">x (GDP) Ortalamasƒ± = ${gdpSum.toFixed(2)} / ${yearly.length}</div>`;
                html += `<div class="formula-result">xÃÑ = $${avgGdp.toLocaleString('en-US', {maximumFractionDigits: 2})}</div>`;
                html += `<br>`;
                html += `<div class="calculation-step">y (Mutluluk) Ortalamasƒ± = ${happinessSum.toFixed(4)} / ${yearly.length}</div>`;
                html += `<div class="formula-result">»≥ = ${avgHappiness.toFixed(4)}</div>`;
            } else {
                html += `<div class="calculation-step">x (Mutluluk) Ortalamasƒ± = ${happinessSum.toFixed(4)} / ${yearly.length}</div>`;
                html += `<div class="formula-result">xÃÑ = ${avgHappiness.toFixed(4)}</div>`;
                html += `<br>`;
                html += `<div class="calculation-step">y (GDP) Ortalamasƒ± = ${gdpSum.toFixed(2)} / ${yearly.length}</div>`;
                html += `<div class="formula-result">»≥ = $${avgGdp.toLocaleString('en-US', {maximumFractionDigits: 2})}</div>`;
            }
            html += '</div>';
            html += '</div>';
            
            // 3Ô∏è‚É£  Korelasyon hesaplamasƒ±
            html += '<div class="calculation-section">';
            html += '<h4>3Ô∏è‚É£  Pearson Korelasyon Hesaplamasƒ±</h4>';
            
            let x, y;
            if (detailVariableMode === 'gdp-independent') {
                x = yearly.map(d => d.gdp);
                y = yearly.map(d => d.happiness);
            } else {
                x = yearly.map(d => d.happiness);
                y = yearly.map(d => d.gdp);
            }
            
            const xMean = x.reduce((a, b) => a + b) / x.length;
            const yMean = y.reduce((a, b) => a + b) / y.length;
            
            let numerator = 0, xVar = 0, yVar = 0;
            for (let i = 0; i < x.length; i++) {
                const xDiff = x[i] - xMean;
                const yDiff = y[i] - yMean;
                numerator += xDiff * yDiff;
                xVar += xDiff * xDiff;
                yVar += yDiff * yDiff;
            }
            
            html += '<strong>r = Œ£(x_i - xÃÑ)(y_i - »≥) / ‚àö[Œ£(x_i - xÃÑ)¬≤ √ó Œ£(y_i - »≥)¬≤]</strong><br>';
            html += '<div class="calculation-steps">';
            html += `<div class="calculation-step">Œ£(x_i - xÃÑ)(y_i - »≥) = ${numerator.toFixed(4)}</div>`;
            html += `<div class="calculation-step">Œ£(x_i - xÃÑ)¬≤ = ${xVar.toFixed(4)}</div>`;
            html += `<div class="calculation-step">Œ£(y_i - »≥)¬≤ = ${yVar.toFixed(4)}</div>`;
            html += `<div class="calculation-step">r = ${numerator.toFixed(4)} / ‚àö(${xVar.toFixed(4)} √ó ${yVar.toFixed(4)})</div>`;
            html += `<div class="formula-result">r = ${data.pearson_r}</div>`;
            html += `<div class="calculation-step" style="color: #666; font-size: 0.9em; margin-top: 10px;">p-value = ${data.pearson_p.toExponential(2)}</div>`;
            html += '</div>';
            html += '</div>';
            
            // Sonu√ß
            html += '<div class="calculation-section">';
            html += '<h4>üìä Sonu√ß ve Yorum</h4>';
            const interpretation = data.pearson_r > 0 ? 'POZƒ∞Tƒ∞F' : 'NEGATƒ∞F';
            const strength = Math.abs(data.pearson_r) > 0.7 ? 'g√º√ßl√º' : Math.abs(data.pearson_r) > 0.4 ? 'orta' : 'zayƒ±f';
            html += `<p><strong>Korelasyon Katsayƒ±sƒ±:</strong> r = ${data.pearson_r} (${interpretation} ${strength})</p>`;
            html += `<p><strong>ƒ∞statistiksel Anlamlƒ±lƒ±k:</strong> p = ${data.pearson_p.toExponential(2)} ${data.pearson_p < 0.05 ? '‚úÖ Anlamlƒ±' : '‚ùå Anlamsƒ±z'}</p>`;
            html += '<p><strong>Yorum:</strong> ';
            if (detailVariableMode === 'gdp-independent') {
                if (data.pearson_r > 0) {
                    html += `GDP arttƒ±k√ßa ${data.country}'nin mutluluk endeksi de artma eƒüilimindedir.`;
                } else {
                    html += `GDP arttƒ±k√ßa ${data.country}'nin mutluluk endeksi azalma eƒüilimindedir.`;
                }
            } else {
                if (data.pearson_r > 0) {
                    html += `Mutluluk arttƒ±k√ßa ${data.country}'nin GDP'si de artma eƒüilimindedir.`;
                } else {
                    html += `Mutluluk arttƒ±k√ßa ${data.country}'nin GDP'si azalma eƒüilimindedir.`;
                }
            }
            html += '</p></div>';
            
            document.getElementById('detail-content').innerHTML = html;
            renderKaTeX();
        }
        
        // TAB MANAGEMENT FUNCTIONS
        function switchTab(tabName) {
            // T√ºm tab button'larƒ± pasif yap
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            // T√ºm tab content'lerini gizle
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Se√ßilen tab button'ƒ±nƒ± aktif yap
            const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
            
            // Se√ßilen tab content'ini g√∂ster
            const tabContent = document.getElementById(`tab-${tabName}`);
            if (tabContent) {
                tabContent.classList.add('active');
                
                // Grafikler sekmesinde grafikleri render et
                if (tabName === 'charts' && allData.length > 0) {
                    setTimeout(() => {
                        renderCharts();
                    }, 300);
                }
                
                // Export sekmesinde bilgileri g√ºncelle
                if (tabName === 'export') {
                    updateExportInfo();
                }
            }
        }
        
        // Tab button event listeners
        function initTabButtons() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tabName = e.target.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }
        
        // ==================== KAYDETME / ƒ∞√áE AKTARMA FONKSƒ∞YONLARI ====================
        
        let lastClusteringResult = null;  // Son k√ºmeleme sonucunu sakla
        
        // GDELT durumunu topla
        function collectGDELTState() {
            return {
                timestamp: new Date().toISOString(),
                dataType: 'gdelt-iptc',
                parameters: {
                    min_docs_threshold: parseInt(document.getElementById('min-docs-threshold')?.value) || 1000,
                    quality_threshold: parseInt(document.getElementById('quality-threshold')?.value) || 50,
                    similarity_threshold: parseFloat(document.getElementById('similarity-threshold')?.value) || 0.30,
                    iptc_filter: document.getElementById('iptc-filter-param')?.value || 'all'
                },
                gdeltData: {
                    totalDocs: totalDocsData || [],
                    monthlyQuality: monthlyQualityData || [],
                    monthlyDetail: monthlyDetailData || []
                },
                iptcMapping: iptcMappingResults || null,
                summary: {
                    totalThemes: totalDocsData ? new Set(totalDocsData.map(d => d.theme_code)).size : 0,
                    totalCountries: totalDocsData ? new Set(totalDocsData.map(d => d.country)).size : 0,
                    totalDocs: totalDocsData ? totalDocsData.reduce((s, d) => s + (d.total_docs || 0), 0) : 0,
                    iptcCategories: iptcMappingResults ? new Set(iptcMappingResults.mappings?.map(m => m.iptc_category)).size : 0
                }
            };
        }
        
        // Eski GDP-Mutluluk durumu (geriye uyumluluk)
        function collectCurrentState() {
            return {
                timestamp: new Date().toISOString(),
                parameters: {
                    start_year: 2022,
                    end_year: 2024
                },
                results: allData,
                summary: {},
                clustering: lastClusteringResult,
                currentMethod: currentMethod,
                currentFilter: currentFilter,
                currentVariableMode: currentVariableMode
            };
        }
        
        // GDELT durumunu uygula
        function applyGDELTState(state) {
            if (!state) return;
            
            // Parametreleri uygula
            if (state.parameters) {
                const minDocsEl = document.getElementById('min-docs-threshold');
                const qualityEl = document.getElementById('quality-threshold');
                const similarityEl = document.getElementById('similarity-threshold');
                const iptcFilterEl = document.getElementById('iptc-filter-param');
                
                if (minDocsEl) minDocsEl.value = state.parameters.min_docs_threshold || 1000;
                if (qualityEl) qualityEl.value = state.parameters.quality_threshold || 50;
                if (similarityEl) similarityEl.value = state.parameters.similarity_threshold || 0.30;
                if (iptcFilterEl) iptcFilterEl.value = state.parameters.iptc_filter || 'all';
            }
            
            // GDELT verilerini uygula
            if (state.gdeltData) {
                if (state.gdeltData.totalDocs && state.gdeltData.totalDocs.length > 0) {
                    totalDocsData = state.gdeltData.totalDocs;
                    updateTotalDocsTable();
                }
                if (state.gdeltData.monthlyQuality && state.gdeltData.monthlyQuality.length > 0) {
                    monthlyQualityData = state.gdeltData.monthlyQuality;
                    updateMonthlyQualityTable();
                }
                if (state.gdeltData.monthlyDetail) {
                    monthlyDetailData = state.gdeltData.monthlyDetail;
                }
            }
            
            // IPTC e≈üle≈ütirme sonu√ßlarƒ±nƒ± uygula
            if (state.iptcMapping) {
                iptcMappingResults = state.iptcMapping;
                displayIPTCMappingResults(iptcMappingResults);
            }
            
            // √ñzet bilgilerini g√∂ster
            if (state.summary) {
                showStatus(`üìä Y√ºklendi: ${state.summary.totalThemes || 0} tema, ${state.summary.totalCountries || 0} √ºlke, ${(state.summary.totalDocs || 0).toLocaleString()} dok√ºman`, 'success');
            }
        }
        
        // Durumu uygula (geriye uyumluluk)
        function applyState(state) {
            if (!state) return;
            
            // GDELT formatƒ± mƒ± kontrol et
            if (state.dataType === 'gdelt-iptc') {
                applyGDELTState(state);
                return;
            }
            
            // Eski format - GDP/Mutluluk (geriye uyumluluk)
            if (state.results && state.results.length > 0) {
                allData = state.results;
            }
            
            // K√ºmeleme sonu√ßlarƒ±nƒ± uygula
            if (state.clustering) {
                lastClusteringResult = state.clustering;
            }
        }
        
        // GDELT Analizi Kaydet
        async function saveGDELTAnalysis() {
            if (!totalDocsData || totalDocsData.length === 0) {
                showStatus('‚ö†Ô∏è Kaydetmek i√ßin √∂nce GDELT verilerini y√ºkleyin!', 'error');
                return;
            }
            
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="loading-spinner"></span>Kaydediliyor...';
            
            try {
                const state = collectGDELTState();
                
                // JSON dosyasƒ± olarak indir (sunucu gerektirmez)
                const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `gdelt_iptc_analiz_${new Date().toISOString().slice(0,10)}.json`;
                link.click();
                
                showStatus('‚úÖ GDELT analizi JSON olarak indirildi!', 'success');
                
            } catch (error) {
                console.error('Kaydetme hatasƒ±:', error);
                showStatus(`‚ùå Kaydetme hatasƒ±: ${error.message}`, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'üíæ Kaydet';
            }
        }
        
        // Eski analizi kaydet (geriye uyumluluk)
        async function saveAnalysis() {
            saveGDELTAnalysis();
        }
        
        // ƒ∞√ße aktarma dialog'unu tetikle
        function triggerImport() {
            document.getElementById('import-file-input').click();
        }
        
        // GDELT dosyasƒ±nƒ± i√ße aktar
        async function handleGDELTImportFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const importBtn = document.getElementById('import-btn');
            importBtn.disabled = true;
            importBtn.innerHTML = '<span class="loading-spinner"></span>Y√ºkleniyor...';
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // Veri tipine g√∂re i≈üle
                if (data.dataType === 'gdelt-iptc') {
                    applyGDELTState(data);
                    showStatus(`‚úÖ GDELT analizi y√ºklendi: ${file.name}`, 'success');
                } else {
                    // Eski format
                    applyState(data);
                    showStatus(`‚úÖ Analiz dosyasƒ± y√ºklendi: ${file.name}`, 'success');
                }
                
            } catch (error) {
                console.error('ƒ∞√ße aktarma hatasƒ±:', error);
                showStatus(`‚ùå ƒ∞√ße aktarma hatasƒ±: ${error.message}`, 'error');
            } finally {
                importBtn.disabled = false;
                importBtn.innerHTML = 'üì• ƒ∞√ße Aktar';
                e.target.value = '';
            }
        }
        
        // Eski i√ße aktarma (geriye uyumluluk)
        async function handleImportFile(e) {
            handleGDELTImportFile(e);
        }
        
        // GDELT Filtreleri Uygula
        function applyGDELTFilters() {
            if (!totalDocsData || totalDocsData.length === 0) {
                showStatus('‚ö†Ô∏è √ñnce GDELT verilerini y√ºkleyin!', 'error');
                return;
            }
            
            const minDocs = parseInt(document.getElementById('min-docs-threshold').value) || 0;
            const minQuality = parseInt(document.getElementById('quality-threshold').value) || 0;
            const iptcFilter = document.getElementById('iptc-filter-param').value;
            
            // Filtrelenmi≈ü sayƒ±larƒ± hesapla
            let filteredDocs = totalDocsData.filter(item => (item.total_docs || 0) >= minDocs);
            
            if (iptcFilter !== 'all') {
                filteredDocs = filteredDocs.filter(item => {
                    const iptc = getIPTCCategory(item.theme_code);
                    return iptc && iptc.toLowerCase() === iptcFilter.toLowerCase();
                });
            }
            
            const totalFiltered = filteredDocs.length;
            const themeCount = new Set(filteredDocs.map(d => d.theme_code)).size;
            const countryCount = new Set(filteredDocs.map(d => d.country)).size;
            
            showStatus(`üîç Filtre uygulandƒ±: ${totalFiltered} kayƒ±t (${themeCount} tema, ${countryCount} √ºlke)`, 'success');
            
            // Tablolarƒ± g√ºncelle
            updateTotalDocsTable();
            updateMonthlyQualityTable();
        }
        
        // Filtreleri Sƒ±fƒ±rla
        function resetGDELTFilters() {
            document.getElementById('min-docs-threshold').value = 1000;
            document.getElementById('quality-threshold').value = 50;
            document.getElementById('similarity-threshold').value = 0.30;
            document.getElementById('iptc-filter-param').value = 'all';
            
            showStatus('üîÑ Filtreler sƒ±fƒ±rlandƒ±', 'info');
            
            // Tablolarƒ± g√ºncelle
            if (totalDocsData && totalDocsData.length > 0) {
                updateTotalDocsTable();
                updateMonthlyQualityTable();
            }
        }
        
        // Otomatik y√ºkleme (sayfa a√ßƒ±lƒ±≈üƒ±nda)
        async function autoLoadLastAnalysis() {
            // LocalStorage'dan son durumu y√ºkle
            try {
                const savedState = localStorage.getItem('gdelt_iptc_last_state');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    if (state.dataType === 'gdelt-iptc' && state.gdeltData) {
                        console.log('üìÇ LocalStorage\'dan son durum y√ºkleniyor...');
                        applyGDELTState(state);
                    }
                }
            } catch (error) {
                console.log('LocalStorage y√ºkleme hatasƒ±:', error.message);
            }
        }
        
        // ==================== KAYDETME / ƒ∞√áE AKTARMA FONKSƒ∞YONLARI SONU ====================
        
        // ==================== DI≈ûARI AKTARMA FONKSƒ∞YONLARI ====================
        
        // S√ºtun se√ßimi yardƒ±mcƒ±larƒ±
        function selectAllExportCols() {
            document.querySelectorAll('.export-col-checkbox').forEach(cb => cb.checked = true);
        }
        
        function deselectAllExportCols() {
            document.querySelectorAll('.export-col-checkbox').forEach(cb => cb.checked = false);
        }
        
        // Se√ßili s√ºtunlarƒ± al
        function getSelectedColumns() {
            const columns = [];
            document.querySelectorAll('.export-col-checkbox:checked').forEach(cb => {
                columns.push(cb.value);
            });
            return columns;
        }
        
        // S√ºtun ba≈ülƒ±klarƒ±nƒ± T√ºrk√ße'ye √ßevir
        function getColumnHeader(col) {
            const headers = {
                'rank': 'Sƒ±ra',
                'iso3': 'ISO',
                'country': '√úlke',
                'pearson_r': 'Pearson r',
                'spearman_r': 'Spearman œÅ',
                'kendall_tau': 'Kendall œÑ',
                'pearson_p': 'P-value',
                'n': 'n',
                'avg_gdp': 'Ort. GDP ($)',
                'avg_happiness': 'Ort. Mutluluk',
                'income_category': 'Gelir Kategorisi',
                'happiness_category': 'Mutluluk Kategorisi',
                'multivar_happiness_group': 'K-Means Cluster'
            };
            return headers[col] || col;
        }
        
        // Export i√ßin filtrelenmi≈ü veriyi al
        function getFilteredDataForExport() {
            const countLimit = parseInt(document.getElementById('export-country-count').value) || 20;
            
            // Export sayfasƒ±ndaki filtre se√ßimini al
            const exportFilterRadio = document.querySelector('input[name="export-filter"]:checked');
            const exportFilter = exportFilterRadio ? exportFilterRadio.value : 'all';
            
            let filteredData = allData.filter(item => {
                // Export filtresi
                if (exportFilter === 'positive') {
                    return item.pearson_r > 0;
                } else if (exportFilter === 'negative') {
                    return item.pearson_r < 0;
                } else if (exportFilter === 'significant') {
                    return item.pearson_p < 0.05;
                } else if (exportFilter === 'rich-sad') {
                    // Rich But Sad: Y√ºksek gelirli + D√º≈ü√ºk Mutluluk
                    const happinessLevel = item.multivar_happiness_group || item.score_happiness_group || null;
                    if (happinessLevel) {
                        return item.gdp_category === 'High Income' && happinessLevel === 'low';
                    }
                    return item.gdp_category === 'High Income' && item.happiness_category === 'D√º≈ü√ºk Mutluluk';
                } else if (exportFilter === 'rich-sad-v2') {
                    // Rich But Sad v2: Y√ºksek + Orta-√ºst gelirli, ancak Y√ºksek Mutluluk deƒüil
                    const isRichCategory = item.gdp_category === 'High Income' || item.gdp_category === 'Upper Middle Income';
                    const happinessLevel = item.multivar_happiness_group || item.score_happiness_group || null;
                    if (happinessLevel) {
                        return isRichCategory && happinessLevel !== 'high';
                    }
                    return isRichCategory && item.happiness_category !== 'Y√ºksek Mutluluk';
                } else if (exportFilter === 'poor-happy') {
                    // Poor But Happy: D√º≈ü√ºk/orta gelirli + Y√ºksek Mutluluk
                    const isPoorCategory = item.gdp_category === 'Low Income' || item.gdp_category === 'Lower Middle Income';
                    const happinessLevel = item.multivar_happiness_group || item.score_happiness_group || null;
                    if (happinessLevel) {
                        return isPoorCategory && happinessLevel === 'high';
                    }
                    return isPoorCategory && item.happiness_category === 'Y√ºksek Mutluluk';
                } else if (exportFilter === 'poor-happy-v2') {
                    // Poor But Happy v2: D√º≈ü√ºk/orta gelirli, ancak D√º≈ü√ºk Mutluluk deƒüil
                    const isPoorCategory = item.gdp_category === 'Low Income' || item.gdp_category === 'Lower Middle Income';
                    const happinessLevel = item.multivar_happiness_group || item.score_happiness_group || null;
                    if (happinessLevel) {
                        return isPoorCategory && happinessLevel !== 'low';
                    }
                    return isPoorCategory && item.happiness_category !== 'D√º≈ü√ºk Mutluluk';
                }
                return true;
            });
            
            // Sƒ±ralama - Rich but Sad ve Poor but Happy filtreleri i√ßin en k√º√ß√ºkten en b√ºy√ºƒüe (negatif korelasyon √∂nce)
            if (exportFilter === 'rich-sad' || exportFilter === 'rich-sad-v2' || 
                exportFilter === 'poor-happy' || exportFilter === 'poor-happy-v2' || 
                exportFilter === 'negative') {
                // Negatif korelasyona g√∂re sƒ±rala (en negatif √∂nce)
                filteredData.sort((a, b) => (a.pearson_r || Infinity) - (b.pearson_r || Infinity));
            } else {
                // Normal sƒ±ralama (en pozitif √∂nce)
                filteredData.sort((a, b) => (b.pearson_r || -Infinity) - (a.pearson_r || -Infinity));
            }
            
            return filteredData.slice(0, countLimit);
        }
        
        // Export filtre deƒüi≈üikliƒüi listener
        function updateExportFilterInfo() {
            const exportFilterRadio = document.querySelector('input[name="export-filter"]:checked');
            const exportFilter = exportFilterRadio ? exportFilterRadio.value : 'all';
            
            const filterNames = {
                'all': 'T√ºm√º',
                'positive': 'Pozitif Korelasyon',
                'negative': 'Negatif Korelasyon',
                'significant': 'ƒ∞statistiksel Anlamlƒ±',
                'rich-sad': 'Rich but Sad',
                'poor-happy': 'Poor but Happy',
                'rich-sad-v2': 'Rich but Sad v2',
                'poor-happy-v2': 'Poor but Happy v2'
            };
            
            // Filtre uygula ve sayƒ±yƒ± hesapla
            let count = 0;
            allData.forEach(item => {
                const happinessLevel = item.multivar_happiness_group || item.score_happiness_group || null;
                const isRichCategory = item.gdp_category === 'High Income' || item.gdp_category === 'Upper Middle Income';
                const isPoorCategory = item.gdp_category === 'Low Income' || item.gdp_category === 'Lower Middle Income';
                
                if (exportFilter === 'positive' && item.pearson_r > 0) count++;
                else if (exportFilter === 'negative' && item.pearson_r < 0) count++;
                else if (exportFilter === 'significant' && item.pearson_p < 0.05) count++;
                else if (exportFilter === 'rich-sad') {
                    if (happinessLevel) {
                        if (item.gdp_category === 'High Income' && happinessLevel === 'low') count++;
                    } else if (item.gdp_category === 'High Income' && item.happiness_category === 'D√º≈ü√ºk Mutluluk') count++;
                }
                else if (exportFilter === 'rich-sad-v2') {
                    if (happinessLevel) {
                        if (isRichCategory && happinessLevel !== 'high') count++;
                    } else if (isRichCategory && item.happiness_category !== 'Y√ºksek Mutluluk') count++;
                }
                else if (exportFilter === 'poor-happy') {
                    if (happinessLevel) {
                        if (isPoorCategory && happinessLevel === 'high') count++;
                    } else if (isPoorCategory && item.happiness_category === 'Y√ºksek Mutluluk') count++;
                }
                else if (exportFilter === 'poor-happy-v2') {
                    if (happinessLevel) {
                        if (isPoorCategory && happinessLevel !== 'low') count++;
                    } else if (isPoorCategory && item.happiness_category !== 'D√º≈ü√ºk Mutluluk') count++;
                }
                else if (exportFilter === 'all') count++;
            });
            
            document.getElementById('export-active-filter').textContent = filterNames[exportFilter] || 'T√ºm√º';
            document.getElementById('export-filtered-count').textContent = count;
            document.getElementById('export-total-available').textContent = allData.length;
        }
        
        // Export filtre event listener'larƒ±nƒ± ba≈ülat
        function initExportFilters() {
            document.querySelectorAll('input[name="export-filter"]').forEach(radio => {
                radio.addEventListener('change', updateExportFilterInfo);
            });
        }
        
        // XLSX Export
        function exportTableXLSX() {
            const columns = getSelectedColumns();
            if (columns.length === 0) {
                showStatus('‚ùå En az bir s√ºtun se√ßmelisiniz!', 'error');
                return;
            }
            
            const data = getFilteredDataForExport();
            if (data.length === 0) {
                showStatus('‚ùå Dƒ±≈üarƒ± aktarƒ±lacak veri yok!', 'error');
                return;
            }
            
            // Veriyi hazƒ±rla
            const exportData = data.map((item, idx) => {
                const row = {};
                columns.forEach(col => {
                    if (col === 'rank') {
                        row[getColumnHeader(col)] = idx + 1;
                    } else if (col === 'avg_gdp') {
                        row[getColumnHeader(col)] = item.avg_gdp ? Math.round(item.avg_gdp).toLocaleString('en-US') : '-';
                    } else if (col === 'pearson_r' || col === 'spearman_r' || col === 'kendall_tau') {
                        row[getColumnHeader(col)] = item[col] !== null ? parseFloat(item[col]).toFixed(4) : '-';
                    } else if (col === 'pearson_p') {
                        row[getColumnHeader(col)] = item[col] !== null ? item[col].toExponential(2) : '-';
                    } else if (col === 'avg_happiness') {
                        row[getColumnHeader(col)] = item[col] !== null ? parseFloat(item[col]).toFixed(3) : '-';
                    } else if (col === 'income_category') {
                        // Gelir kategorisi - gdp_category'den al
                        row[getColumnHeader(col)] = item.gdp_category || '-';
                    } else if (col === 'happiness_category') {
                        // Mutluluk kategorisi
                        row[getColumnHeader(col)] = item.happiness_category || item.multivar_happiness_group || '-';
                    } else {
                        row[getColumnHeader(col)] = item[col] || '-';
                    }
                });
                return row;
            });
            
            // XLSX olu≈ütur
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'GDP-Mutluluk Analizi');
            
            // ƒ∞ndir
            const filename = `gdp_mutluluk_analizi_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showStatus(`‚úÖ ${data.length} √ºlke XLSX olarak indirildi!`, 'success');
        }
        
        // CSV Export
        function exportTableCSV() {
            const columns = getSelectedColumns();
            if (columns.length === 0) {
                showStatus('‚ùå En az bir s√ºtun se√ßmelisiniz!', 'error');
                return;
            }
            
            const data = getFilteredDataForExport();
            if (data.length === 0) {
                showStatus('‚ùå Dƒ±≈üarƒ± aktarƒ±lacak veri yok!', 'error');
                return;
            }
            
            // CSV Header
            let csv = columns.map(col => getColumnHeader(col)).join(',') + '\n';
            
            // CSV Rows
            data.forEach((item, idx) => {
                const row = columns.map(col => {
                    if (col === 'rank') return idx + 1;
                    if (col === 'avg_gdp') return item.avg_gdp ? Math.round(item.avg_gdp) : '';
                    if (col === 'pearson_r' || col === 'spearman_r' || col === 'kendall_tau') {
                        return item[col] !== null ? parseFloat(item[col]).toFixed(4) : '';
                    }
                    if (col === 'pearson_p') return item[col] !== null ? item[col].toExponential(2) : '';
                    if (col === 'avg_happiness') return item[col] !== null ? parseFloat(item[col]).toFixed(3) : '';
                    // Gelir kategorisi - gdp_category'den al
                    if (col === 'income_category') {
                        const val = item.gdp_category || '';
                        return val.toString().includes(',') ? `"${val}"` : val;
                    }
                    // Mutluluk kategorisi
                    if (col === 'happiness_category') {
                        const val = item.happiness_category || item.multivar_happiness_group || '';
                        return val.toString().includes(',') ? `"${val}"` : val;
                    }
                    // Virg√ºl i√ßeren deƒüerleri tƒ±rnak i√ßine al
                    const val = item[col] || '';
                    return val.toString().includes(',') ? `"${val}"` : val;
                }).join(',');
                csv += row + '\n';
            });
            
            // ƒ∞ndir
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `gdp_mutluluk_analizi_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            showStatus(`‚úÖ ${data.length} √ºlke CSV olarak indirildi!`, 'success');
        }
        
        // LaTeX Tablo Kodu
        function showLatexTableCode() {
            const columns = getSelectedColumns();
            if (columns.length === 0) {
                showStatus('‚ùå En az bir s√ºtun se√ßmelisiniz!', 'error');
                return;
            }
            
            const data = getFilteredDataForExport();
            if (data.length === 0) {
                showStatus('‚ùå Dƒ±≈üarƒ± aktarƒ±lacak veri yok!', 'error');
                return;
            }
            
            // LaTeX tablo kodu olu≈ütur
            let latex = '\\begin{table}[htbp]\n';
            latex += '\\centering\n';
            latex += '\\caption{GDP per Capita vs Mutluluk Korelasyon Analizi}\n';
            latex += '\\label{tab:gdp-happiness}\n';
            latex += '\\begin{tabular}{' + columns.map(c => c === 'country' ? 'l' : 'c').join('') + '}\n';
            latex += '\\toprule\n';
            
            // Header
            latex += columns.map(col => getColumnHeader(col).replace('$', '\\$').replace('œÅ', '$\\rho$').replace('œÑ', '$\\tau$')).join(' & ') + ' \\\\\n';
            latex += '\\midrule\n';
            
            // Rows
            data.forEach((item, idx) => {
                const row = columns.map(col => {
                    if (col === 'rank') return idx + 1;
                    if (col === 'avg_gdp') return item.avg_gdp ? Math.round(item.avg_gdp).toLocaleString('en-US').replace(/,/g, '\\,') : '--';
                    if (col === 'pearson_r' || col === 'spearman_r' || col === 'kendall_tau') {
                        return item[col] !== null ? parseFloat(item[col]).toFixed(3) : '--';
                    }
                    if (col === 'pearson_p') {
                        if (item[col] === null) return '--';
                        const exp = item[col].toExponential(1);
                        return '$' + exp.replace('e', ' \\times 10^{').replace('+', '') + '}$';
                    }
                    if (col === 'avg_happiness') return item[col] !== null ? parseFloat(item[col]).toFixed(2) : '--';
                    // Gelir kategorisi - gdp_category'den al
                    if (col === 'income_category') {
                        return (item.gdp_category || '--').toString().replace(/_/g, ' ');
                    }
                    // Mutluluk kategorisi
                    if (col === 'happiness_category') {
                        return (item.happiness_category || item.multivar_happiness_group || '--').toString().replace(/_/g, ' ');
                    }
                    return (item[col] || '--').toString().replace(/_/g, '\\_');
                }).join(' & ');
                latex += row + ' \\\\\n';
            });
            
            latex += '\\bottomrule\n';
            latex += '\\end{tabular}\n';
            latex += '\\end{table}\n';
            
            // G√∂ster
            document.getElementById('latex-table-code').value = latex;
            document.getElementById('latex-table-preview').style.display = 'block';
            
            showStatus('‚úÖ LaTeX tablo kodu olu≈üturuldu!', 'success');
        }
        
        // LaTeX Kodu Kopyala
        function copyLatexTable() {
            const code = document.getElementById('latex-table-code').value;
            navigator.clipboard.writeText(code).then(() => {
                showStatus('‚úÖ LaTeX kodu panoya kopyalandƒ±!', 'success');
            });
        }
        
        // PNG Export
        function exportChartPNG() {
            const chartId = document.getElementById('export-chart-select').value;
            const canvas = document.getElementById(chartId);
            
            if (!canvas) {
                showStatus('‚ùå Grafik bulunamadƒ±! √ñnce ilgili analizi √ßalƒ±≈ütƒ±rƒ±n.', 'error');
                return;
            }
            
            const width = parseInt(document.getElementById('export-chart-width').value) || 800;
            const height = parseInt(document.getElementById('export-chart-height').value) || 600;
            
            // Yeni canvas olu≈ütur ve boyutlandƒ±r
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = width;
            tempCanvas.height = height;
            const ctx = tempCanvas.getContext('2d');
            
            // Beyaz arka plan
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, width, height);
            
            // Orijinal canvas'ƒ± kopyala
            ctx.drawImage(canvas, 0, 0, width, height);
            
            // ƒ∞ndir
            const link = document.createElement('a');
            link.download = `${chartId}_${new Date().toISOString().slice(0,10)}.png`;
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
            
            showStatus('‚úÖ Grafik PNG olarak indirildi!', 'success');
        }
        
        // SVG Export - Ger√ßek Vekt√∂rel SVG
        function exportChartSVG() {
            const chartId = document.getElementById('export-chart-select').value;
            const canvas = document.getElementById(chartId);
            
            if (!canvas) {
                showStatus('‚ùå Grafik bulunamadƒ±! √ñnce ilgili analizi √ßalƒ±≈ütƒ±rƒ±n.', 'error');
                return;
            }
            
            const width = 800;
            const height = 600;
            
            // Chart.js instance'ƒ±nƒ± bul
            let chartInstance = null;
            const chartMap = {
                'pca-scatter-chart': window.pcaChartInstance,
                'gdp-happiness-scatter-chart': window.gdpHappinessChartInstance,
                'distribution-chart': chartInstances[0],
                'top-chart': chartInstances[1],
                'bottom-chart': chartInstances[2],
                'pvalue-chart': chartInstances[3],
                'score-clustering-chart': window.scoreChartInstance,
                'iptc-distribution-chart': gdeltChartInstances[0],
                'country-theme-chart': gdeltChartInstances[1],
                'top-themes-chart': gdeltChartInstances[2],
                'iptc-similarity-chart': gdeltChartInstances[3]
            };
            chartInstance = chartMap[chartId];
            
            // Ger√ßek vekt√∂rel SVG olu≈ütur
            const svg = generateVectorSVG(chartInstance, chartId, width, height);
            
            // ƒ∞ndir
            const blob = new Blob([svg], { type: 'image/svg+xml' });
            const link = document.createElement('a');
            link.download = `${chartId}_${new Date().toISOString().slice(0,10)}.svg`;
            link.href = URL.createObjectURL(blob);
            link.click();
            
            showStatus('‚úÖ Grafik vekt√∂rel SVG olarak indirildi!', 'success');
        }
        
        // Vekt√∂rel SVG olu≈üturma fonksiyonu
        function generateVectorSVG(chartInstance, chartId, width, height) {
            let svg = `<?xml version="1.0" encoding="UTF-8"?>\n`;
            svg += `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">\n`;
            svg += `  <rect width="100%" height="100%" fill="white"/>\n`;
            svg += `  <style>\n`;
            svg += `    .axis-text { font-family: 'Segoe UI', Arial, sans-serif; font-size: 12px; fill: #666; }\n`;
            svg += `    .title-text { font-family: 'Segoe UI', Arial, sans-serif; font-size: 16px; font-weight: bold; fill: #333; }\n`;
            svg += `    .legend-text { font-family: 'Segoe UI', Arial, sans-serif; font-size: 11px; fill: #333; }\n`;
            svg += `    .grid-line { stroke: #e0e0e0; stroke-width: 1; }\n`;
            svg += `  </style>\n`;
            
            const margin = { top: 50, right: 120, bottom: 60, left: 70 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            if (!chartInstance || !chartInstance.data) {
                // Fallback: Canvas'ƒ± PNG olarak g√∂m
                const canvas = document.getElementById(chartId);
                if (canvas) {
                    const dataUrl = canvas.toDataURL('image/png');
                    svg += `  <image href="${dataUrl}" width="${width}" height="${height}"/>\n`;
                }
                svg += `</svg>`;
                return svg;
            }
            
            const chartType = chartInstance.config.type;
            const datasets = chartInstance.data.datasets;
            const labels = chartInstance.data.labels || [];
            
            // Ba≈ülƒ±k
            const titleMap = {
                'pca-scatter-chart': 'PCA 2D Projeksiyon - Mutluluk K√ºmeleri',
                'gdp-happiness-scatter-chart': 'GDP per Capita vs Mutluluk Skoru',
                'distribution-chart': 'Pearson Korelasyon Daƒüƒ±lƒ±mƒ±',
                'top-chart': 'En Y√ºksek 10 Pozitif Korelasyon',
                'bottom-chart': 'En D√º≈ü√ºk 10 Negatif Korelasyon',
                'pvalue-chart': 'ƒ∞statistiksel Anlamlƒ±lƒ±k Daƒüƒ±lƒ±mƒ±',
                'score-clustering-chart': 'Score Tabanlƒ± K√ºmeleme',
                'iptc-distribution-chart': 'IPTC Kategori Daƒüƒ±lƒ±mƒ±',
                'country-theme-chart': '√úlke Bazlƒ± Tema Hacmi',
                'top-themes-chart': 'En Y√ºksek Hacimli GDELT Temalar',
                'iptc-similarity-chart': 'IPTC Benzerlik Skorlarƒ±'
            };
            svg += `  <text x="${width/2}" y="30" text-anchor="middle" class="title-text">${titleMap[chartId] || 'Grafik'}</text>\n`;
            
            // Chart tipine g√∂re SVG elemanlarƒ± olu≈ütur
            if (chartType === 'scatter') {
                svg += generateScatterSVG(datasets, margin, chartWidth, chartHeight, chartInstance);
            } else if (chartType === 'bar') {
                svg += generateBarSVG(datasets, labels, margin, chartWidth, chartHeight, chartInstance);
            } else if (chartType === 'pie' || chartType === 'doughnut') {
                svg += generatePieSVG(datasets, labels, width, height);
            }
            
            // Legend
            svg += generateLegendSVG(datasets, width - margin.right + 10, margin.top);
            
            svg += `</svg>`;
            return svg;
        }
        
        // Scatter Plot SVG
        function generateScatterSVG(datasets, margin, chartWidth, chartHeight, chartInstance) {
            let svg = '';
            
            // T√ºm veri noktalarƒ±ndan min/max bul
            let allX = [], allY = [];
            datasets.forEach(ds => {
                if (ds.data) {
                    ds.data.forEach(point => {
                        if (point && typeof point.x === 'number' && typeof point.y === 'number') {
                            allX.push(point.x);
                            allY.push(point.y);
                        }
                    });
                }
            });
            
            if (allX.length === 0 || allY.length === 0) return svg;
            
            const xMin = Math.min(...allX), xMax = Math.max(...allX);
            const yMin = Math.min(...allY), yMax = Math.max(...allY);
            const xRange = xMax - xMin || 1;
            const yRange = yMax - yMin || 1;
            
            // Grid ve eksenleri √ßiz
            svg += `  <g transform="translate(${margin.left}, ${margin.top})">\n`;
            
            // Grid √ßizgileri
            for (let i = 0; i <= 5; i++) {
                const y = chartHeight * i / 5;
                svg += `    <line x1="0" y1="${y}" x2="${chartWidth}" y2="${y}" class="grid-line"/>\n`;
                const yVal = (yMax - (yRange * i / 5)).toFixed(2);
                svg += `    <text x="-10" y="${y + 4}" text-anchor="end" class="axis-text">${yVal}</text>\n`;
            }
            for (let i = 0; i <= 5; i++) {
                const x = chartWidth * i / 5;
                svg += `    <line x1="${x}" y1="0" x2="${x}" y2="${chartHeight}" class="grid-line"/>\n`;
                const xVal = (xMin + (xRange * i / 5)).toFixed(2);
                svg += `    <text x="${x}" y="${chartHeight + 20}" text-anchor="middle" class="axis-text">${xVal}</text>\n`;
            }
            
            // Eksen √ßizgileri
            svg += `    <line x1="0" y1="${chartHeight}" x2="${chartWidth}" y2="${chartHeight}" stroke="#333" stroke-width="2"/>\n`;
            svg += `    <line x1="0" y1="0" x2="0" y2="${chartHeight}" stroke="#333" stroke-width="2"/>\n`;
            
            // Veri noktalarƒ±
            datasets.forEach((ds, dsIdx) => {
                const color = ds.backgroundColor || ds.borderColor || ['#F47272', '#4CAF50', '#4285F4'][dsIdx % 3];
                const colorStr = typeof color === 'string' ? color : color[0] || '#666';
                
                if (ds.data) {
                    ds.data.forEach((point, idx) => {
                        if (point && typeof point.x === 'number' && typeof point.y === 'number') {
                            const cx = ((point.x - xMin) / xRange) * chartWidth;
                            const cy = chartHeight - ((point.y - yMin) / yRange) * chartHeight;
                            const shape = ds.pointStyle || 'circle';
                            
                            if (shape === 'triangle') {
                                const size = 6;
                                svg += `    <polygon points="${cx},${cy-size} ${cx-size},${cy+size} ${cx+size},${cy+size}" fill="${colorStr}" stroke="${colorStr}" stroke-width="1"/>\n`;
                            } else if (shape === 'rectRot' || shape === 'rect') {
                                svg += `    <rect x="${cx-4}" y="${cy-4}" width="8" height="8" fill="${colorStr}" transform="rotate(45 ${cx} ${cy})"/>\n`;
                            } else {
                                svg += `    <circle cx="${cx}" cy="${cy}" r="5" fill="${colorStr}" stroke="white" stroke-width="1"/>\n`;
                            }
                        }
                    });
                }
            });
            
            svg += `  </g>\n`;
            return svg;
        }
        
        // Bar Chart SVG
        function generateBarSVG(datasets, labels, margin, chartWidth, chartHeight, chartInstance) {
            let svg = '';
            
            if (!datasets[0] || !datasets[0].data) return svg;
            
            const data = datasets[0].data;
            const maxVal = Math.max(...data.filter(d => typeof d === 'number'));
            const minVal = Math.min(...data.filter(d => typeof d === 'number'), 0);
            const range = maxVal - minVal || 1;
            
            svg += `  <g transform="translate(${margin.left}, ${margin.top})">\n`;
            
            // Yatay bar chart i√ßin
            const barHeight = chartHeight / (labels.length || 1) * 0.7;
            const barGap = chartHeight / (labels.length || 1) * 0.3;
            
            data.forEach((val, idx) => {
                if (typeof val !== 'number') return;
                const barWidth = Math.abs(val - minVal) / range * chartWidth * 0.9;
                const y = idx * (barHeight + barGap);
                const color = val >= 0 ? '#4CAF50' : '#F44336';
                
                // Label
                svg += `    <text x="-10" y="${y + barHeight/2 + 4}" text-anchor="end" class="axis-text">${labels[idx] || ''}</text>\n`;
                
                // Bar
                svg += `    <rect x="0" y="${y}" width="${barWidth}" height="${barHeight}" fill="${color}" rx="3"/>\n`;
                
                // Value
                svg += `    <text x="${barWidth + 5}" y="${y + barHeight/2 + 4}" class="axis-text">${val.toFixed(3)}</text>\n`;
            });
            
            svg += `  </g>\n`;
            return svg;
        }
        
        // Pie Chart SVG
        function generatePieSVG(datasets, labels, width, height) {
            let svg = '';
            
            if (!datasets[0] || !datasets[0].data) return svg;
            
            const data = datasets[0].data;
            const colors = datasets[0].backgroundColor || ['#4CAF50', '#F44336', '#2196F3', '#FF9800'];
            const total = data.reduce((a, b) => a + b, 0);
            const cx = width / 2;
            const cy = height / 2;
            const radius = Math.min(width, height) / 3;
            
            let startAngle = -Math.PI / 2;
            
            data.forEach((val, idx) => {
                const sliceAngle = (val / total) * 2 * Math.PI;
                const endAngle = startAngle + sliceAngle;
                
                const x1 = cx + radius * Math.cos(startAngle);
                const y1 = cy + radius * Math.sin(startAngle);
                const x2 = cx + radius * Math.cos(endAngle);
                const y2 = cy + radius * Math.sin(endAngle);
                
                const largeArc = sliceAngle > Math.PI ? 1 : 0;
                const color = colors[idx % colors.length];
                
                svg += `  <path d="M ${cx} ${cy} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z" fill="${color}" stroke="white" stroke-width="2"/>\n`;
                
                // Label
                const midAngle = startAngle + sliceAngle / 2;
                const labelX = cx + (radius * 0.7) * Math.cos(midAngle);
                const labelY = cy + (radius * 0.7) * Math.sin(midAngle);
                const pct = ((val / total) * 100).toFixed(1);
                svg += `  <text x="${labelX}" y="${labelY}" text-anchor="middle" class="legend-text" fill="white">${pct}%</text>\n`;
                
                startAngle = endAngle;
            });
            
            return svg;
        }
        
        // Legend SVG
        function generateLegendSVG(datasets, x, y) {
            let svg = `  <g transform="translate(${x}, ${y})">\n`;
            
            datasets.forEach((ds, idx) => {
                const color = ds.backgroundColor || ds.borderColor || '#666';
                const colorStr = typeof color === 'string' ? color : (Array.isArray(color) ? color[0] : '#666');
                const label = ds.label || `Seri ${idx + 1}`;
                
                svg += `    <rect x="0" y="${idx * 20}" width="12" height="12" fill="${colorStr}" rx="2"/>\n`;
                svg += `    <text x="18" y="${idx * 20 + 10}" class="legend-text">${label}</text>\n`;
            });
            
            svg += `  </g>\n`;
            return svg;
        }
        
        // LaTeX/PGFPlots Grafik Kodu
        function showLatexChartCode() {
            const chartId = document.getElementById('export-chart-select').value;
            
            let latex = '';
            
            if (chartId === 'pca-scatter-chart' || chartId === 'gdp-happiness-scatter-chart') {
                // Scatter plot i√ßin PGFPlots kodu
                latex = generateScatterPlotLatex(chartId);
            } else if (chartId === 'distribution-chart') {
                // Histogram i√ßin
                latex = generateHistogramLatex();
            } else if (chartId === 'pvalue-chart') {
                // Pie chart i√ßin
                latex = generatePieChartLatex();
            } else {
                // Bar chart i√ßin
                latex = generateBarChartLatex(chartId);
            }
            
            document.getElementById('latex-chart-code').value = latex;
            document.getElementById('latex-chart-preview').style.display = 'block';
            
            showStatus('‚úÖ LaTeX grafik kodu olu≈üturuldu!', 'success');
        }
        
        // Scatter Plot LaTeX - Ger√ßek veriyle
        function generateScatterPlotLatex(chartId) {
            let latex = '% Gerekli paketler: \\usepackage{pgfplots}, \\pgfplotsset{compat=1.18}\n\n';
            latex += '\\begin{figure}[htbp]\n';
            latex += '\\centering\n';
            latex += '\\begin{tikzpicture}\n';
            latex += '\\begin{axis}[\n';
            
            if (chartId === 'pca-scatter-chart') {
                latex += '    xlabel={Dim1 (PCA)},\n';
                latex += '    ylabel={Dim2 (PCA)},\n';
                latex += '    title={PCA 2D Projeksiyon - Mutluluk K√ºmeleri},\n';
            } else {
                latex += '    xlabel={Log GDP per Capita},\n';
                latex += '    ylabel={Ladder Score},\n';
                latex += '    title={GDP vs Mutluluk Scatter Plot},\n';
            }
            
            latex += '    legend pos=outer north east,\n';
            latex += '    legend style={font=\\small},\n';
            latex += '    grid=major,\n';
            latex += '    width=14cm,\n';
            latex += '    height=10cm,\n';
            latex += '    mark size=1.5pt\n';
            latex += ']\n\n';
            
            // Ger√ßek veriyi al
            if (chartId === 'pca-scatter-chart' && lastClusteringResult && lastClusteringResult.pipelines && lastClusteringResult.pipelines.multivariate) {
                const pcaData = lastClusteringResult.pipelines.multivariate.pca_data || [];
                
                // K√ºmelere g√∂re grupla
                const clusters = { 'low': [], 'medium': [], 'high': [] };
                pcaData.forEach(item => {
                    const group = item.happiness_group || 'medium';
                    if (clusters[group]) {
                        clusters[group].push({ x: item.dim1, y: item.dim2, country: item.country || item.iso3 });
                    }
                });
                
                // D√º≈ü√ºk Mutluluk (Kƒ±rmƒ±zƒ±)
                latex += '% D√º≈ü√ºk Mutluluk K√ºmesi (Kƒ±rmƒ±zƒ±) - ' + clusters.low.length + ' √ºlke\n';
                latex += '\\addplot[only marks, mark=*, color=red!80!black, mark size=2pt] coordinates {\n';
                clusters.low.forEach(p => {
                    latex += `    (${p.x.toFixed(3)}, ${p.y.toFixed(3)}) % ${p.country}\n`;
                });
                latex += '};\n';
                latex += '\\addlegendentry{D√º≈ü√ºk Mutluluk (' + clusters.low.length + ')}\n\n';
                
                // Orta Mutluluk (Ye≈üil)
                latex += '% Orta Mutluluk K√ºmesi (Ye≈üil) - ' + clusters.medium.length + ' √ºlke\n';
                latex += '\\addplot[only marks, mark=triangle*, color=green!60!black, mark size=2pt] coordinates {\n';
                clusters.medium.forEach(p => {
                    latex += `    (${p.x.toFixed(3)}, ${p.y.toFixed(3)}) % ${p.country}\n`;
                });
                latex += '};\n';
                latex += '\\addlegendentry{Orta Mutluluk (' + clusters.medium.length + ')}\n\n';
                
                // Y√ºksek Mutluluk (Mavi)
                latex += '% Y√ºksek Mutluluk K√ºmesi (Mavi) - ' + clusters.high.length + ' √ºlke\n';
                latex += '\\addplot[only marks, mark=square*, color=blue!80!black, mark size=2pt] coordinates {\n';
                clusters.high.forEach(p => {
                    latex += `    (${p.x.toFixed(3)}, ${p.y.toFixed(3)}) % ${p.country}\n`;
                });
                latex += '};\n';
                latex += '\\addlegendentry{Y√ºksek Mutluluk (' + clusters.high.length + ')}\n\n';
                
            } else if (chartId === 'gdp-happiness-scatter-chart' && lastClusteringResult && lastClusteringResult.pipelines && lastClusteringResult.pipelines.multivariate) {
                const scatterData = lastClusteringResult.pipelines.multivariate.scatter_data || [];
                
                // K√ºmelere g√∂re grupla
                const clusters = { 'low': [], 'medium': [], 'high': [] };
                scatterData.forEach(item => {
                    const group = item.happiness_group || 'medium';
                    if (clusters[group]) {
                        clusters[group].push({ x: item.gdp, y: item.happiness, country: item.country || item.iso3 });
                    }
                });
                
                // D√º≈ü√ºk Mutluluk (Kƒ±rmƒ±zƒ±)
                latex += '% D√º≈ü√ºk Mutluluk K√ºmesi (Kƒ±rmƒ±zƒ±) - ' + clusters.low.length + ' √ºlke\n';
                latex += '\\addplot[only marks, mark=*, color=red!80!black, mark size=2pt] coordinates {\n';
                clusters.low.forEach(p => {
                    latex += `    (${p.x.toFixed(3)}, ${p.y.toFixed(3)}) % ${p.country}\n`;
                });
                latex += '};\n';
                latex += '\\addlegendentry{D√º≈ü√ºk Mutluluk (' + clusters.low.length + ')}\n\n';
                
                // Orta Mutluluk (Ye≈üil)
                latex += '% Orta Mutluluk K√ºmesi (Ye≈üil) - ' + clusters.medium.length + ' √ºlke\n';
                latex += '\\addplot[only marks, mark=triangle*, color=green!60!black, mark size=2pt] coordinates {\n';
                clusters.medium.forEach(p => {
                    latex += `    (${p.x.toFixed(3)}, ${p.y.toFixed(3)}) % ${p.country}\n`;
                });
                latex += '};\n';
                latex += '\\addlegendentry{Orta Mutluluk (' + clusters.medium.length + ')}\n\n';
                
                // Y√ºksek Mutluluk (Mavi)
                latex += '% Y√ºksek Mutluluk K√ºmesi (Mavi) - ' + clusters.high.length + ' √ºlke\n';
                latex += '\\addplot[only marks, mark=square*, color=blue!80!black, mark size=2pt] coordinates {\n';
                clusters.high.forEach(p => {
                    latex += `    (${p.x.toFixed(3)}, ${p.y.toFixed(3)}) % ${p.country}\n`;
                });
                latex += '};\n';
                latex += '\\addlegendentry{Y√ºksek Mutluluk (' + clusters.high.length + ')}\n\n';
                
            } else {
                // Veri yoksa uyarƒ±
                latex += '% UYARI: K√ºmeleme verisi bulunamadƒ±!\n';
                latex += '% √ñnce "K√ºmeleme" sekmesinden k√ºmelemeyi √ßalƒ±≈ütƒ±rƒ±n.\n';
                latex += '% √ñrnek koordinatlar:\n';
                latex += '\\addplot[only marks, mark=*, color=red] coordinates {(0,0)};\n';
                latex += '\\addlegendentry{Veri Yok}\n\n';
            }
            
            latex += '\\end{axis}\n';
            latex += '\\end{tikzpicture}\n';
            latex += '\\caption{' + (chartId === 'pca-scatter-chart' ? 'PCA 2D Projeksiyon - K-Means K√ºmeleme Sonu√ßlarƒ±' : 'GDP per Capita vs Mutluluk Skoru') + '}\n';
            latex += '\\label{fig:' + chartId.replace(/-/g, '_') + '}\n';
            latex += '\\end{figure}\n';
            
            return latex;
        }
        
        // Histogram LaTeX - Ger√ßek veriyle
        function generateHistogramLatex() {
            // Ger√ßek veriyi hesapla
            const bins = [-1, -0.75, -0.5, -0.25, 0, 0.25, 0.5, 0.75, 1];
            const binLabels = ['[-1,-0.75)', '[-0.75,-0.5)', '[-0.5,-0.25)', '[-0.25,0)', '[0,0.25)', '[0.25,0.5)', '[0.5,0.75)', '[0.75,1]'];
            const histCounts = Array(bins.length - 1).fill(0);
            
            const validData = allData.filter(item => item.pearson_r !== null && !isNaN(item.pearson_r));
            validData.forEach(item => {
                const r = item.pearson_r;
                for (let i = 0; i < bins.length - 1; i++) {
                    if (r >= bins[i] && r < bins[i + 1]) {
                        histCounts[i]++;
                        break;
                    }
                }
                if (r >= bins[bins.length - 1]) histCounts[histCounts.length - 1]++;
            });
            
            let latex = '% Gerekli paketler: \\usepackage{pgfplots}, \\pgfplotsset{compat=1.18}\n\n';
            latex += '\\begin{figure}[htbp]\n';
            latex += '\\centering\n';
            latex += '\\begin{tikzpicture}\n';
            latex += '\\begin{axis}[\n';
            latex += '    ybar,\n';
            latex += '    xlabel={Korelasyon Aralƒ±ƒüƒ±},\n';
            latex += '    ylabel={√úlke Sayƒ±sƒ±},\n';
            latex += '    title={Pearson Korelasyon Daƒüƒ±lƒ±mƒ± (n=' + validData.length + ')},\n';
            latex += '    symbolic x coords={' + binLabels.join(', ') + '},\n';
            latex += '    xtick=data,\n';
            latex += '    x tick label style={rotate=45, anchor=east, font=\\small},\n';
            latex += '    nodes near coords,\n';
            latex += '    nodes near coords style={font=\\small},\n';
            latex += '    width=14cm,\n';
            latex += '    height=8cm,\n';
            latex += '    bar width=15pt,\n';
            latex += '    ymin=0\n';
            latex += ']\n';
            latex += '\\addplot[fill=blue!60] coordinates {\n';
            
            for (let i = 0; i < binLabels.length; i++) {
                latex += `    ({${binLabels[i]}}, ${histCounts[i]})\n`;
            }
            
            latex += '};\n';
            latex += '\\end{axis}\n';
            latex += '\\end{tikzpicture}\n';
            latex += '\\caption{GDP-Mutluluk Pearson Korelasyon Daƒüƒ±lƒ±mƒ±}\n';
            latex += '\\label{fig:correlation_distribution}\n';
            latex += '\\end{figure}\n';
            
            return latex;
        }
        
        // Pie Chart LaTeX - Ger√ßek veriyle
        function generatePieChartLatex() {
            // Ger√ßek veriyi hesapla
            const validData = allData.filter(item => item.pearson_p !== null && !isNaN(item.pearson_p));
            const significant = validData.filter(d => d.pearson_p < 0.05).length;
            const notSignificant = validData.length - significant;
            const sigPct = validData.length > 0 ? ((significant / validData.length) * 100).toFixed(1) : 0;
            const notSigPct = validData.length > 0 ? ((notSignificant / validData.length) * 100).toFixed(1) : 0;
            
            let latex = '% Gerekli paketler: \\usepackage{pgf-pie}\n\n';
            latex += '\\begin{figure}[htbp]\n';
            latex += '\\centering\n';
            latex += '\\begin{tikzpicture}\n';
            latex += `\\pie[text=legend, radius=3, color={green!60, red!40}]{\n`;
            latex += `    ${sigPct}/ƒ∞statistiksel Anlamlƒ± p<0.05 (n=${significant}),\n`;
            latex += `    ${notSigPct}/Anlamsƒ±z p>=0.05 (n=${notSignificant})\n`;
            latex += '}\n';
            latex += '\\end{tikzpicture}\n';
            latex += '\\caption{ƒ∞statistiksel Anlamlƒ±lƒ±k Daƒüƒ±lƒ±mƒ± (Toplam n=' + validData.length + ')}\n';
            latex += '\\label{fig:significance_pie}\n';
            latex += '\\end{figure}\n';
            
            return latex;
        }
        
        // Bar Chart LaTeX - Ger√ßek veriyle
        function generateBarChartLatex(chartId) {
            const isTop = chartId === 'top-chart';
            
            // Ger√ßek veriyi al ve sƒ±rala
            let sortedData = allData
                .filter(item => item.pearson_r !== null && !isNaN(item.pearson_r))
                .sort((a, b) => isTop ? (b.pearson_r - a.pearson_r) : (a.pearson_r - b.pearson_r));
            
            // ƒ∞lk veya son 10'u al
            const data10 = sortedData.slice(0, 10);
            
            let latex = '% Gerekli paketler: \\usepackage{pgfplots}, \\pgfplotsset{compat=1.18}\n\n';
            latex += '\\begin{figure}[htbp]\n';
            latex += '\\centering\n';
            latex += '\\begin{tikzpicture}\n';
            latex += '\\begin{axis}[\n';
            latex += '    xbar,\n';
            latex += '    xlabel={Pearson r},\n';
            latex += '    title={' + (isTop ? 'En Y√ºksek 10 Pozitif Korelasyon' : 'En D√º≈ü√ºk 10 Negatif Korelasyon') + '},\n';
            
            // √úlke isimlerini symbolic y coords olarak ekle (ters sƒ±rada)
            const countries = data10.map(d => d.country.replace(/[_&%$#{}]/g, ' ')).reverse();
            latex += '    symbolic y coords={' + countries.join(', ') + '},\n';
            latex += '    ytick=data,\n';
            latex += '    y tick label style={font=\\small},\n';
            latex += '    nodes near coords,\n';
            latex += '    nodes near coords style={font=\\small},\n';
            latex += '    nodes near coords align={horizontal},\n';
            latex += '    width=12cm,\n';
            latex += '    height=10cm,\n';
            latex += '    bar width=10pt,\n';
            latex += '    enlarge y limits=0.08,\n';
            latex += '    xmin=' + (isTop ? '0' : '-1') + ',\n';
            latex += '    xmax=' + (isTop ? '1' : '0') + '\n';
            latex += ']\n';
            latex += '\\addplot[fill=' + (isTop ? 'green!60' : 'red!60') + '] coordinates {\n';
            
            // Veriyi ters sƒ±rada ekle (grafik i√ßin)
            data10.reverse().forEach(item => {
                const countryName = item.country.replace(/[_&%$#{}]/g, ' ');
                latex += `    (${item.pearson_r.toFixed(4)}, {${countryName}})\n`;
            });
            
            latex += '};\n';
            latex += '\\end{axis}\n';
            latex += '\\end{tikzpicture}\n';
            latex += '\\caption{' + (isTop ? 'En G√º√ßl√º Pozitif Korelasyonlu 10 √úlke' : 'En G√º√ßl√º Negatif Korelasyonlu 10 √úlke') + '}\n';
            latex += '\\label{fig:' + chartId.replace(/-/g, '_') + '}\n';
            latex += '\\end{figure}\n';
            
            return latex;
        }
        
        // LaTeX Chart Kodu Kopyala
        function copyLatexChart() {
            const code = document.getElementById('latex-chart-code').value;
            navigator.clipboard.writeText(code).then(() => {
                showStatus('‚úÖ LaTeX grafik kodu panoya kopyalandƒ±!', 'success');
            });
        }
        
        // T√ºm Verileri ƒ∞ndir (XLSX)
        function exportAllData() {
            if (allData.length === 0) {
                showStatus('‚ùå Dƒ±≈üarƒ± aktarƒ±lacak veri yok! √ñnce analiz √ßalƒ±≈ütƒ±rƒ±n.', 'error');
                return;
            }
            
            // T√ºm s√ºtunlarla veri hazƒ±rla
            const columns = ['rank', 'iso3', 'country', 'pearson_r', 'spearman_r', 'kendall_tau', 
                           'pearson_p', 'n', 'avg_gdp', 'avg_happiness', 'income_category', 
                           'happiness_category', 'multivar_happiness_group'];
            
            const exportData = allData.map((item, idx) => {
                const row = {};
                columns.forEach(col => {
                    if (col === 'rank') {
                        row[getColumnHeader(col)] = idx + 1;
                    } else if (col === 'avg_gdp') {
                        row[getColumnHeader(col)] = item.avg_gdp ? Math.round(item.avg_gdp) : '';
                    } else if (col === 'pearson_r' || col === 'spearman_r' || col === 'kendall_tau') {
                        row[getColumnHeader(col)] = item[col] !== null ? parseFloat(item[col]) : '';
                    } else if (col === 'pearson_p') {
                        row[getColumnHeader(col)] = item[col] !== null ? item[col] : '';
                    } else if (col === 'avg_happiness') {
                        row[getColumnHeader(col)] = item[col] !== null ? parseFloat(item[col]) : '';
                    } else {
                        row[getColumnHeader(col)] = item[col] || '';
                    }
                });
                return row;
            });
            
            // XLSX olu≈ütur
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'T√ºm Veriler');
            
            // ƒ∞ndir
            const filename = `gdp_mutluluk_tam_veri_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showStatus(`‚úÖ ${allData.length} √ºlke verisi XLSX olarak indirildi!`, 'success');
        }
        
        // T√ºm Grafikleri PNG olarak ƒ∞ndir
        async function exportAllChartsPNG() {
            const chartIds = ['distribution-chart', 'top-chart', 'bottom-chart', 'pvalue-chart', 
                            'pca-scatter-chart', 'gdp-happiness-scatter-chart', 'score-clustering-chart'];
            
            let exportedCount = 0;
            
            for (const chartId of chartIds) {
                const canvas = document.getElementById(chartId);
                if (canvas) {
                    const link = document.createElement('a');
                    link.download = `${chartId}_${new Date().toISOString().slice(0,10)}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    exportedCount++;
                    
                    // Tarayƒ±cƒ±nƒ±n indirmeleri i≈ülemesi i√ßin kƒ±sa bekleme
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
            }
            
            showStatus(`‚úÖ ${exportedCount} grafik PNG olarak indirildi!`, 'success');
        }
        
        // Tam LaTeX Raporu
        function exportFullLatexReport() {
            if (allData.length === 0) {
                showStatus('‚ùå Dƒ±≈üarƒ± aktarƒ±lacak veri yok! √ñnce analiz √ßalƒ±≈ütƒ±rƒ±n.', 'error');
                return;
            }
            
            let latex = '% ============================================\n';
            latex += '% GDP per Capita vs Mutluluk Korelasyon Raporu\n';
            latex += '% Otomatik Olu≈üturulma Tarihi: ' + new Date().toLocaleDateString('tr-TR') + '\n';
            latex += '% ============================================\n\n';
            
            latex += '\\documentclass[12pt,a4paper]{article}\n';
            latex += '\\usepackage[utf8]{inputenc}\n';
            latex += '\\usepackage[turkish]{babel}\n';
            latex += '\\usepackage{booktabs}\n';
            latex += '\\usepackage{pgfplots}\n';
            latex += '\\pgfplotsset{compat=1.18}\n';
            latex += '\\usepackage{pgf-pie}\n';
            latex += '\\usepackage{geometry}\n';
            latex += '\\geometry{margin=2.5cm}\n\n';
            
            latex += '\\title{GDP per Capita ve Mutluluk Endeksi Korelasyon Analizi}\n';
            latex += '\\author{Otomatik Rapor}\n';
            latex += '\\date{\\today}\n\n';
            
            latex += '\\begin{document}\n';
            latex += '\\maketitle\n\n';
            
            latex += '\\section{√ñzet ƒ∞statistikler}\n';
            latex += '\\begin{itemize}\n';
            latex += '    \\item Toplam √úlke Sayƒ±sƒ±: ' + allData.length + '\n';
            latex += '    \\item ƒ∞statistiksel Anlamlƒ± (p<0.05): ' + allData.filter(d => d.pearson_p < 0.05).length + '\n';
            
            const validData = allData.filter(d => d.pearson_r !== null);
            const avgCorr = validData.length > 0 ? (validData.reduce((s, d) => s + d.pearson_r, 0) / validData.length).toFixed(3) : 'N/A';
            latex += '    \\item Ortalama Pearson r: ' + avgCorr + '\n';
            latex += '\\end{itemize}\n\n';
            
            // Top 10 tablo
            latex += '\\section{En Y√ºksek Korelasyonlu 10 √úlke}\n';
            latex += generateTop10LatexTable();
            
            // Grafik ≈üablonlarƒ±
            latex += '\n\\section{Grafikler}\n';
            latex += '% A≈üaƒüƒ±daki grafik kodlarƒ±nƒ± verilerinize g√∂re g√ºncelleyin\n\n';
            latex += generateHistogramLatex();
            latex += '\n';
            latex += generatePieChartLatex();
            
            latex += '\n\\end{document}\n';
            
            // ƒ∞ndir
            const blob = new Blob([latex], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.download = `gdp_mutluluk_rapor_${new Date().toISOString().slice(0,10)}.tex`;
            link.href = URL.createObjectURL(blob);
            link.click();
            
            showStatus('‚úÖ Tam LaTeX raporu indirildi!', 'success');
        }
        
        // Top 10 LaTeX Tablosu
        function generateTop10LatexTable() {
            const top10 = allData.filter(d => d.pearson_r !== null).sort((a, b) => b.pearson_r - a.pearson_r).slice(0, 10);
            
            let latex = '\\begin{table}[htbp]\n';
            latex += '\\centering\n';
            latex += '\\caption{En Y√ºksek Pozitif Korelasyonlu 10 √úlke}\n';
            latex += '\\label{tab:top10}\n';
            latex += '\\begin{tabular}{clccc}\n';
            latex += '\\toprule\n';
            latex += 'Sƒ±ra & √úlke & Pearson r & p-value & n \\\\\n';
            latex += '\\midrule\n';
            
            top10.forEach((item, idx) => {
                const pval = item.pearson_p !== null ? '$' + item.pearson_p.toExponential(1).replace('e', ' \\times 10^{').replace('+', '') + '}$' : '--';
                latex += `${idx + 1} & ${item.country || '--'} & ${item.pearson_r?.toFixed(3) || '--'} & ${pval} & ${item.n || '--'} \\\\\n`;
            });
            
            latex += '\\bottomrule\n';
            latex += '\\end{tabular}\n';
            latex += '\\end{table}\n';
            
            return latex;
        }
        
        // Export sekmesi a√ßƒ±ldƒ±ƒüƒ±nda bilgileri g√ºncelle
        function updateExportInfo() {
            const totalEl = document.getElementById('export-total-available');
            const filterEl = document.getElementById('export-active-filter');
            
            if (totalEl) {
                totalEl.textContent = allData.length;
            }
            
            if (filterEl) {
                const filterNames = {
                    'all': 'T√ºm√º',
                    'positive': 'Pozitif',
                    'negative': 'Negatif',
                    'significant': 'ƒ∞statistiksel Anlamlƒ±',
                    'rich-sad': 'Rich but Sad',
                    'poor-happy': 'Poor but Happy',
                    'rich-sad-v2': 'Rich but Sad v2',
                    'poor-happy-v2': 'Poor but Happy v2'
                };
                filterEl.textContent = filterNames[currentFilter] || currentFilter;
            }
        }
        
        // ==================== GDELT DI≈ûARI AKTARMA FONKSƒ∞YONLARI ====================
        
        // GDELT Veri Export - XLSX
        function exportGDELTDataXLSX() {
            if (!totalDocsData || totalDocsData.length === 0) {
                showStatus('‚ùå Dƒ±≈üarƒ± aktarƒ±lacak GDELT verisi yok! √ñnce CSV y√ºkleyin.', 'error');
                return;
            }
            
            const columns = getSelectedGDELTColumns();
            if (columns.length === 0) {
                showStatus('‚ùå En az bir s√ºtun se√ßmelisiniz!', 'error');
                return;
            }
            
            const iptcFilter = document.getElementById('export-iptc-filter').value;
            let filteredData = totalDocsData;
            
            if (iptcFilter !== 'all') {
                filteredData = totalDocsData.filter(item => {
                    const iptcCat = getIPTCCategory(item.theme_code);
                    return iptcCat && iptcCat.toLowerCase() === iptcFilter.toLowerCase();
                });
            }
            
            if (filteredData.length === 0) {
                showStatus('‚ùå Filtreye uyan veri yok!', 'error');
                return;
            }
            
            // Veriyi hazƒ±rla
            const exportData = filteredData.map(item => {
                const row = {};
                const iptcCat = getIPTCCategory(item.theme_code);
                
                columns.forEach(col => {
                    if (col === 'country') row['√úlke'] = item.country || '-';
                    else if (col === 'theme_code') row['Tema Kodu'] = item.theme_code || '-';
                    else if (col === 'total_docs') row['Toplam Dok√ºman'] = item.total_docs || 0;
                    else if (col === 'iptc_category') row['IPTC Kategorisi'] = iptcCat || '-';
                    else if (col === 'months_ok') row['Uygun Ay Sayƒ±sƒ±'] = item.months_ok || 0;
                    else if (col === 'months_total') row['Toplam Ay'] = item.months_total || 0;
                    else if (col === 'quality_ratio') {
                        const ratio = item.months_total > 0 ? (item.months_ok / item.months_total * 100).toFixed(1) : 0;
                        row['Kalite Oranƒ± (%)'] = ratio;
                    }
                    else if (col === 'median_docs') row['Median Dok√ºman'] = item.median_monthly_docs || 0;
                });
                return row;
            });
            
            // XLSX olu≈ütur
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'GDELT Tema Verileri');
            
            // ƒ∞ndir
            const filename = `gdelt_tema_verileri_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showStatus(`‚úÖ ${filteredData.length} satƒ±r GDELT verisi XLSX olarak indirildi!`, 'success');
        }
        
        // GDELT Veri Export - CSV
        function exportGDELTDataCSV() {
            if (!totalDocsData || totalDocsData.length === 0) {
                showStatus('‚ùå Dƒ±≈üarƒ± aktarƒ±lacak GDELT verisi yok! √ñnce CSV y√ºkleyin.', 'error');
                return;
            }
            
            const columns = getSelectedGDELTColumns();
            if (columns.length === 0) {
                showStatus('‚ùå En az bir s√ºtun se√ßmelisiniz!', 'error');
                return;
            }
            
            const iptcFilter = document.getElementById('export-iptc-filter').value;
            let filteredData = totalDocsData;
            
            if (iptcFilter !== 'all') {
                filteredData = totalDocsData.filter(item => {
                    const iptcCat = getIPTCCategory(item.theme_code);
                    return iptcCat && iptcCat.toLowerCase() === iptcFilter.toLowerCase();
                });
            }
            
            if (filteredData.length === 0) {
                showStatus('‚ùå Filtreye uyan veri yok!', 'error');
                return;
            }
            
            // Column headers
            const headers = {
                'country': '√úlke',
                'theme_code': 'Tema Kodu',
                'total_docs': 'Toplam Dok√ºman',
                'iptc_category': 'IPTC Kategorisi',
                'months_ok': 'Uygun Ay Sayƒ±sƒ±',
                'months_total': 'Toplam Ay',
                'quality_ratio': 'Kalite Oranƒ± (%)',
                'median_docs': 'Median Dok√ºman'
            };
            
            let csv = columns.map(col => headers[col] || col).join(',') + '\n';
            
            filteredData.forEach(item => {
                const iptcCat = getIPTCCategory(item.theme_code);
                const row = columns.map(col => {
                    if (col === 'country') return `"${item.country || ''}"`;
                    if (col === 'theme_code') return item.theme_code || '';
                    if (col === 'total_docs') return item.total_docs || 0;
                    if (col === 'iptc_category') return `"${iptcCat || ''}"`;
                    if (col === 'months_ok') return item.months_ok || 0;
                    if (col === 'months_total') return item.months_total || 0;
                    if (col === 'quality_ratio') {
                        return item.months_total > 0 ? (item.months_ok / item.months_total * 100).toFixed(1) : 0;
                    }
                    if (col === 'median_docs') return item.median_monthly_docs || 0;
                    return '';
                }).join(',');
                csv += row + '\n';
            });
            
            // ƒ∞ndir
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `gdelt_tema_verileri_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            showStatus(`‚úÖ ${filteredData.length} satƒ±r GDELT verisi CSV olarak indirildi!`, 'success');
        }
        
        // GDELT LaTeX Tablosu
        function showGDELTLatexTable() {
            if (!totalDocsData || totalDocsData.length === 0) {
                showStatus('‚ùå GDELT verisi yok! √ñnce CSV y√ºkleyin.', 'error');
                return;
            }
            
            const columns = getSelectedGDELTColumns();
            
            // IPTC kategorilerine g√∂re grupla
            const iptcGroups = {};
            totalDocsData.forEach(item => {
                const iptcCat = getIPTCCategory(item.theme_code);
                if (iptcCat) {
                    if (!iptcGroups[iptcCat]) iptcGroups[iptcCat] = [];
                    iptcGroups[iptcCat].push(item);
                }
            });
            
            // Top 15 IPTC grupla
            const sortedIPTC = Object.entries(iptcGroups)
                .map(([cat, items]) => ({
                    category: cat,
                    totalDocs: items.reduce((sum, i) => sum + (i.total_docs || 0), 0),
                    themeCount: new Set(items.map(i => i.theme_code)).size
                }))
                .sort((a, b) => b.totalDocs - a.totalDocs)
                .slice(0, 10);
            
            let latex = '\\begin{table}[htbp]\n';
            latex += '\\centering\n';
            latex += '\\caption{GDELT Tema - IPTC Media Topics E≈üle≈ütirme √ñzeti}\n';
            latex += '\\label{tab:gdelt-iptc}\n';
            latex += '\\begin{tabular}{lrr}\n';
            latex += '\\toprule\n';
            latex += 'IPTC Kategori & Tema Sayƒ±sƒ± & Toplam Dok√ºman \\\\\n';
            latex += '\\midrule\n';
            
            sortedIPTC.forEach(item => {
                const catName = item.category.replace(/&/g, '\\&').replace(/_/g, '\\_');
                latex += `${catName} & ${item.themeCount} & ${item.totalDocs.toLocaleString()} \\\\\n`;
            });
            
            latex += '\\bottomrule\n';
            latex += '\\end{tabular}\n';
            latex += '\\end{table}\n';
            
            document.getElementById('latex-table-code').value = latex;
            document.getElementById('latex-table-preview').style.display = 'block';
            
            showStatus('‚úÖ LaTeX tablo kodu olu≈üturuldu!', 'success');
        }
        
        // Se√ßili GDELT s√ºtunlarƒ±nƒ± al
        function getSelectedGDELTColumns() {
            const checkboxes = document.querySelectorAll('.export-col-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        // IPTC Mapping JSON Export
        function exportIPTCMappingJSON() {
            if (!iptcMappingResults) {
                showStatus('‚ùå IPTC e≈üle≈ütirme sonucu yok! √ñnce K√ºmeleme sekmesinden IPTC e≈üle≈ütirmesini √ßalƒ±≈ütƒ±rƒ±n.', 'error');
                return;
            }
            
            const includeThemes = document.getElementById('export-iptc-themes').checked;
            const includeSummary = document.getElementById('export-iptc-summary').checked;
            
            const exportData = {};
            
            if (includeThemes && iptcMappingResults.mappings) {
                exportData.mappings = iptcMappingResults.mappings;
            }
            
            if (includeSummary) {
                // IPTC √∂zeti olu≈ütur
                const summary = {};
                if (iptcMappingResults.mappings) {
                    iptcMappingResults.mappings.forEach(m => {
                        const cat = m.iptc_category;
                        if (!summary[cat]) {
                            summary[cat] = { count: 0, themes: [], avgSimilarity: 0 };
                        }
                        summary[cat].count++;
                        summary[cat].themes.push(m.theme_code);
                        summary[cat].avgSimilarity += m.similarity;
                    });
                    
                    Object.keys(summary).forEach(cat => {
                        summary[cat].avgSimilarity /= summary[cat].count;
                        summary[cat].avgSimilarity = summary[cat].avgSimilarity.toFixed(4);
                    });
                }
                exportData.summary = summary;
            }
            
            exportData.exportDate = new Date().toISOString();
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `iptc_mapping_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            
            showStatus('‚úÖ IPTC e≈üle≈ütirme JSON olarak indirildi!', 'success');
        }
        
        // IPTC Mapping CSV Export
        function exportIPTCMappingCSV() {
            if (!iptcMappingResults || !iptcMappingResults.mappings) {
                showStatus('‚ùå IPTC e≈üle≈ütirme sonucu yok! √ñnce K√ºmeleme sekmesinden IPTC e≈üle≈ütirmesini √ßalƒ±≈ütƒ±rƒ±n.', 'error');
                return;
            }
            
            let csv = 'theme_code,theme_label,iptc_category,similarity\n';
            
            iptcMappingResults.mappings.forEach(m => {
                csv += `"${m.theme_code}","${m.theme_label || ''}","${m.iptc_category}",${m.similarity}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `iptc_mapping_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            showStatus('‚úÖ IPTC e≈üle≈ütirme CSV olarak indirildi!', 'success');
        }
        
        // T√ºm GDELT Verilerini Export
        function exportAllGDELTData() {
            if (!totalDocsData || totalDocsData.length === 0) {
                showStatus('‚ùå Dƒ±≈üarƒ± aktarƒ±lacak veri yok! √ñnce CSV y√ºkleyin.', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Total Docs
            const totalDocsExport = totalDocsData.map(item => ({
                '√úlke': item.country,
                'Tema Kodu': item.theme_code,
                'IPTC Kategorisi': getIPTCCategory(item.theme_code) || '-',
                'Toplam Dok√ºman': item.total_docs
            }));
            const ws1 = XLSX.utils.json_to_sheet(totalDocsExport);
            XLSX.utils.book_append_sheet(wb, ws1, 'Tema Toplam');
            
            // Sheet 2: Monthly Quality (if exists)
            if (monthlyQualityData && monthlyQualityData.length > 0) {
                const qualityExport = monthlyQualityData.map(item => ({
                    '√úlke': item.country,
                    'Tema Kodu': item.theme_code,
                    'IPTC Kategorisi': getIPTCCategory(item.theme_code) || '-',
                    'Uygun Ay': item.months_ok,
                    'Toplam Ay': item.months_total,
                    'Oran (%)': item.months_total > 0 ? (item.months_ok / item.months_total * 100).toFixed(1) : 0
                }));
                const ws2 = XLSX.utils.json_to_sheet(qualityExport);
                XLSX.utils.book_append_sheet(wb, ws2, 'Aylƒ±k Kalite');
            }
            
            // Sheet 3: IPTC Summary
            const iptcSummary = {};
            totalDocsData.forEach(item => {
                const iptc = getIPTCCategory(item.theme_code);
                if (iptc) {
                    if (!iptcSummary[iptc]) {
                        iptcSummary[iptc] = { totalDocs: 0, themeCount: new Set(), countryCount: new Set() };
                    }
                    iptcSummary[iptc].totalDocs += item.total_docs || 0;
                    iptcSummary[iptc].themeCount.add(item.theme_code);
                    iptcSummary[iptc].countryCount.add(item.country);
                }
            });
            
            const iptcExport = Object.entries(iptcSummary).map(([cat, data]) => ({
                'IPTC Kategori': cat,
                'Toplam Dok√ºman': data.totalDocs,
                'Tema Sayƒ±sƒ±': data.themeCount.size,
                '√úlke Sayƒ±sƒ±': data.countryCount.size
            })).sort((a, b) => b['Toplam Dok√ºman'] - a['Toplam Dok√ºman']);
            
            const ws3 = XLSX.utils.json_to_sheet(iptcExport);
            XLSX.utils.book_append_sheet(wb, ws3, 'IPTC √ñzet');
            
            // ƒ∞ndir
            const filename = `gdelt_iptc_tam_veri_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showStatus('‚úÖ T√ºm GDELT verileri √ßoklu sayfa XLSX olarak indirildi!', 'success');
        }
        
        // Tam Rapor (ZIP)
        async function exportFullReport() {
            showStatus('üì¶ Tam rapor hazƒ±rlanƒ±yor...', 'info');
            
            // JSZip kontrol√º
            if (typeof JSZip === 'undefined') {
                showStatus('‚ö†Ô∏è ZIP desteƒüi i√ßin JSZip k√ºt√ºphanesi gerekli. Tek tek dosyalarƒ± indirin.', 'error');
                return;
            }
            
            const zip = new JSZip();
            
            // CSV Verileri
            if (totalDocsData && totalDocsData.length > 0) {
                let csv = 'country,theme_code,iptc_category,total_docs\n';
                totalDocsData.forEach(item => {
                    csv += `"${item.country}","${item.theme_code}","${getIPTCCategory(item.theme_code) || ''}",${item.total_docs}\n`;
                });
                zip.file('gdelt_tema_verileri.csv', csv);
            }
            
            // IPTC Mapping JSON
            if (iptcMappingResults) {
                zip.file('iptc_mapping.json', JSON.stringify(iptcMappingResults, null, 2));
            }
            
            // README
            const readme = `# GDELT & IPTC Media Topics Raporu
Olu≈üturulma Tarihi: ${new Date().toLocaleString('tr-TR')}

## Dosyalar
- gdelt_tema_verileri.csv: GDELT tema verileri
- iptc_mapping.json: IPTC e≈üle≈ütirme sonu√ßlarƒ±

## IPTC Kategorileri
${Object.keys(IPTC_CATEGORIES).map(c => `- ${c}`).join('\n')}
`;
            zip.file('README.md', readme);
            
            // ZIP olu≈ütur ve indir
            const blob = await zip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `gdelt_iptc_rapor_${new Date().toISOString().slice(0,10)}.zip`;
            link.click();
            
            showStatus('‚úÖ Tam rapor ZIP olarak indirildi!', 'success');
        }
        
        // ==================== DI≈ûARI AKTARMA FONKSƒ∞YONLARI SONU ====================
        
        // ==================== GDELT TEMA K√úMELEMESƒ∞ FONKSƒ∞YONLARI ====================
        
        let iptcMappingResults = null;
        
        // IPTC e≈üle≈ütirmesini √ßalƒ±≈ütƒ±r
        async function runIPTCMapping() {
            const btn = document.getElementById('iptc-mapping-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>E≈üle≈ütiriliyor...';
            
            showIPTCMappingStatus('üöÄ Python script √ßalƒ±≈ütƒ±rƒ±lƒ±yor (gdelt_iptc_mapping.py)...', 'info');
            
            try {
                // Python script'i √ßalƒ±≈ütƒ±r API √ºzerinden
                const response = await fetch('/api/run-iptc-mapping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    // Fallback: mevcut JSON dosyasƒ±nƒ± y√ºkle
                    showIPTCMappingStatus('‚ö†Ô∏è API kullanƒ±lamƒ±yor. Terminalde ≈üu komutu √ßalƒ±≈ütƒ±rƒ±n: python gdelt_iptc_mapping.py', 'info');
                    loadIPTCMappingResults();
                    return;
                }
                
                const data = await response.json();
                iptcMappingResults = data;
                
                // Sonu√ßlarƒ± g√∂ster
                displayIPTCMappingResults(data);
                
                showIPTCMappingStatus(
                    `‚úÖ IPTC e≈üle≈ütirme tamamlandƒ±! ${data.metadata.total_themes} tema ‚Üí ${data.metadata.iptc_categories} IPTC kategorisi`,
                    'success'
                );
            } catch (error) {
                console.log('Fallback: loading from file...');
                loadIPTCMappingResults();
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ IPTC E≈üle≈ütirme √áalƒ±≈ütƒ±r';
            }
        }
        
        // IPTC sonu√ßlarƒ±nƒ± dosyadan y√ºkle
        async function loadIPTCMappingResults() {
            try {
                const response = await fetch('gdelt_iptc_mapping.json');
                if (!response.ok) throw new Error('File not found');
                const data = await response.json();
                iptcMappingResults = data;
                displayIPTCMappingResults(data);
                showIPTCMappingStatus('‚úÖ IPTC e≈üle≈ütirme sonu√ßlarƒ± y√ºklendi', 'success');
            } catch (error) {
                showIPTCMappingStatus(
                    '‚ùå Sonu√ßlar y√ºklenemedi. √ñnce terminalde √ßalƒ±≈ütƒ±rƒ±n: python gdelt_iptc_mapping.py',
                    'error'
                );
            }
        }
        
        // IPTC e≈üle≈ütirme sonu√ßlarƒ±nƒ± g√∂ster
        function displayIPTCMappingResults(results) {
            if (!results || !results.iptc_categories) {
                showIPTCMappingStatus('‚ùå Ge√ßersiz veri formatƒ±', 'error');
                return;
            }
            
            // IPTC kategorileri i√ßin renk haritasƒ± (17 kategori)
            const iptcColors = {
                'arts, culture, entertainment and media': '#E91E63',
                'crime, law and justice': '#9C27B0',
                'disaster, accident and emergency incident': '#F44336',
                'economy, business and finance': '#FF9800',
                'education': '#3F51B5',
                'environment': '#4CAF50',
                'health': '#00BCD4',
                'human interest': '#FF5722',
                'labour': '#795548',
                'lifestyle and leisure': '#E91E63',
                'politics and government': '#2196F3',
                'religion': '#673AB7',
                'science and technology': '#009688',
                'society': '#607D8B',
                'sport': '#8BC34A',
                'conflict, war and peace': '#F44336',
                'weather': '#03A9F4'
            };
            
            // IPTC kategori kartlarƒ±nƒ± olu≈ütur
            const grid = document.getElementById('iptc-categories-grid');
            grid.innerHTML = '';
            
            // Kategorileri tema sayƒ±sƒ±na g√∂re sƒ±rala
            const sortedCategories = Object.entries(results.iptc_categories)
                .sort((a, b) => b[1].theme_count - a[1].theme_count);
            
            for (const [categoryLabel, info] of sortedCategories) {
                const color = iptcColors[categoryLabel] || '#667eea';
                
                const card = document.createElement('div');
                card.style.cssText = `
                    background: white;
                    border-left: 5px solid ${color};
                    padding: 15px;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    text-align: left;
                `;
                
                const themesList = info.themes.slice(0, 4).map(t => 
                    `<span style="background: ${color}15; color: ${color}; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 500;">${t}</span>`
                ).join('');
                
                const avgSim = info.avg_similarity ? (info.avg_similarity * 100).toFixed(1) : '-';
                
                card.innerHTML = `
                    <h4 style="color: ${color}; margin: 0 0 8px 0; font-size: 1em; text-transform: capitalize;">
                        ${categoryLabel}
                    </h4>
                    <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                        <span style="background: ${color}20; color: ${color}; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">
                            ${info.theme_count} tema
                        </span>
                        <span style="background: #e3f2fd; color: #2196F3; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">
                            %${avgSim} benzerlik
                        </span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px;">
                        ${themesList}
                        ${info.themes.length > 4 ? `<span style="color: #999; font-size: 0.8em;">+${info.themes.length - 4} daha</span>` : ''}
                    </div>
                `;
                
                grid.appendChild(card);
            }
            
            // Temalarƒ± tabloya ekle
            displayIPTCThemesTable(results.themes);
        }
        
        // T√ºm temalarƒ± IPTC tablosuyla g√∂ster
        function displayIPTCThemesTable(themes) {
            const tbody = document.getElementById('iptc-themes-tbody');
            tbody.innerHTML = '';
            
            // Benzerlik skoruna g√∂re sƒ±rala (y√ºksekten d√º≈ü√ºƒüe)
            const sortedThemes = [...themes].sort((a, b) => (b.similarity || 0) - (a.similarity || 0));
            
            sortedThemes.forEach(theme => {
                const similarity = theme.similarity ? (theme.similarity * 100).toFixed(1) : '-';
                const confidence = theme.confidence ? (theme.confidence * 100).toFixed(1) : '-';
                
                // G√ºven skoru rengini belirle
                let confidenceColor = '#4CAF50'; // ye≈üil (y√ºksek g√ºven)
                if (theme.confidence < 0.1) confidenceColor = '#F44336'; // kƒ±rmƒ±zƒ± (d√º≈ü√ºk g√ºven)
                else if (theme.confidence < 0.2) confidenceColor = '#FF9800'; // turuncu (orta g√ºven)
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 8px; border-bottom: 1px solid #eee; font-family: monospace; font-weight: 600; font-size: 0.9em;">${theme.theme_code}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-transform: capitalize;">
                        <span style="background: #e8f5e9; color: #4CAF50; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">
                            ${theme.iptc_label || '-'}
                        </span>
                    </td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">
                        <span style="background: #e3f2fd; color: #2196F3; padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                            %${similarity}
                        </span>
                    </td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">
                        <span style="background: ${confidenceColor}20; color: ${confidenceColor}; padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                            %${confidence}
                        </span>
                    </td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; color: #999; font-size: 0.85em; text-transform: capitalize;">
                        ${theme.iptc_label_2nd || '-'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // IPTC Status mesajƒ± g√∂ster
        function showIPTCMappingStatus(message, type = 'info') {
            const el = document.getElementById('iptc-mapping-status');
            el.textContent = message;
            el.className = `status-message ${type}`;
            el.style.display = 'block';
        }
        
        // ==================== GDELT CHARTS FONKSƒ∞YONLARI ====================
        
        let gdeltChartInstances = [];
        
        // GDELT & IPTC Grafikleri Olu≈ütur
        function generateGDELTCharts() {
            if (!totalDocsData || totalDocsData.length === 0) {
                showStatus('‚ùå Grafik olu≈üturmak i√ßin √∂nce GDELT CSV verilerini y√ºkleyin!', 'error');
                return;
            }
            
            // Mevcut chart'larƒ± temizle
            gdeltChartInstances.forEach(chart => {
                if (chart) chart.destroy();
            });
            gdeltChartInstances = [];
            
            showStatus('üìä GDELT grafikleri olu≈üturuluyor...', 'info');
            
            // 1. IPTC Kategori Daƒüƒ±lƒ±mƒ±
            createIPTCDistributionChart();
            
            // 2. √úlke Bazlƒ± Tema Hacmi
            createCountryThemeChart();
            
            // 3. En Y√ºksek Hacimli Temalar
            createTopThemesChart();
            
            // 4. IPTC Benzerlik Skorlarƒ±
            createIPTCSimilarityChart();
            
            showStatus('‚úÖ GDELT grafikleri olu≈üturuldu!', 'success');
        }
        
        // IPTC Kategori Daƒüƒ±lƒ±mƒ± (Bar Chart)
        function createIPTCDistributionChart() {
            const canvas = document.getElementById('iptc-distribution-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // IPTC kategorilerine g√∂re toplam dok√ºman hesapla
            const iptcTotals = {};
            totalDocsData.forEach(item => {
                const iptc = getIPTCCategory(item.theme_code);
                if (iptc) {
                    iptcTotals[iptc] = (iptcTotals[iptc] || 0) + (item.total_docs || 0);
                }
            });
            
            // Sƒ±rala ve en y√ºksek 10'u al
            const sorted = Object.entries(iptcTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const labels = sorted.map(([cat]) => cat.split(',')[0].trim()); // Kƒ±sa isim
            const data = sorted.map(([, val]) => val);
            const colors = sorted.map(([cat]) => iptcColors[cat] || '#999');
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Toplam Dok√ºman Sayƒ±sƒ±',
                        data: data,
                        backgroundColor: colors.map(c => c + 'CC'),
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'IPTC Kategori Bazlƒ± Dok√ºman Daƒüƒ±lƒ±mƒ±',
                            font: { size: 16 }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Dok√ºman Sayƒ±sƒ±' } },
                        x: { 
                            ticks: { maxRotation: 45, minRotation: 45 },
                            title: { display: true, text: 'IPTC Kategorisi' }
                        }
                    }
                }
            });
            gdeltChartInstances.push(chart);
        }
        
        // √úlke Bazlƒ± Tema Hacmi (Grouped Bar)
        function createCountryThemeChart() {
            const canvas = document.getElementById('country-theme-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // √úlkelere g√∂re grupla
            const countryTotals = {};
            totalDocsData.forEach(item => {
                const country = item.country || 'Unknown';
                countryTotals[country] = (countryTotals[country] || 0) + (item.total_docs || 0);
            });
            
            // En y√ºksek 15 √ºlkeyi al
            const sorted = Object.entries(countryTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);
            
            const labels = sorted.map(([country]) => country);
            const data = sorted.map(([, val]) => val);
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Toplam Dok√ºman',
                        data: data,
                        backgroundColor: 'rgba(33, 150, 243, 0.7)',
                        borderColor: 'rgba(33, 150, 243, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'En Y√ºksek Tema Hacimli 15 √úlke',
                            font: { size: 16 }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: 'Toplam Dok√ºman' } },
                        y: { title: { display: true, text: '√úlke' } }
                    }
                }
            });
            gdeltChartInstances.push(chart);
        }
        
        // En Y√ºksek Hacimli Temalar (Horizontal Bar)
        function createTopThemesChart() {
            const canvas = document.getElementById('top-themes-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Temalara g√∂re grupla
            const themeTotals = {};
            totalDocsData.forEach(item => {
                const theme = item.theme_code || 'Unknown';
                themeTotals[theme] = (themeTotals[theme] || 0) + (item.total_docs || 0);
            });
            
            // En y√ºksek 15 temayƒ± al
            const sorted = Object.entries(themeTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);
            
            const labels = sorted.map(([theme]) => theme);
            const data = sorted.map(([, val]) => val);
            
            // Her tema i√ßin IPTC rengini bul
            const colors = labels.map(theme => {
                const iptc = getIPTCCategory(theme);
                return iptc ? (iptcColors[iptc] || '#666') : '#999';
            });
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Toplam Dok√ºman',
                        data: data,
                        backgroundColor: colors.map(c => c + 'BB'),
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'En Y√ºksek Hacimli 15 GDELT Tema',
                            font: { size: 16 }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: 'Toplam Dok√ºman' } },
                        y: { title: { display: true, text: 'GDELT Tema Kodu' } }
                    }
                }
            });
            gdeltChartInstances.push(chart);
        }
        
        // IPTC Benzerlik Skorlarƒ± (Radar veya Bar)
        function createIPTCSimilarityChart() {
            const canvas = document.getElementById('iptc-similarity-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // IPTC e≈üle≈ütirme sonu√ßlarƒ±ndan benzerlik skorlarƒ±nƒ± al
            let similarities = [];
            
            if (iptcMappingResults && iptcMappingResults.mappings) {
                // E≈üle≈ütirme varsa benzerlik skorlarƒ±nƒ± kullan
                const iptcAvg = {};
                iptcMappingResults.mappings.forEach(m => {
                    const cat = m.iptc_category;
                    if (!iptcAvg[cat]) iptcAvg[cat] = { sum: 0, count: 0 };
                    iptcAvg[cat].sum += m.similarity;
                    iptcAvg[cat].count++;
                });
                
                similarities = Object.entries(iptcAvg)
                    .map(([cat, data]) => ({
                        category: cat,
                        similarity: data.sum / data.count
                    }))
                    .sort((a, b) => b.similarity - a.similarity);
            } else {
                // E≈üle≈ütirme yoksa tema sayƒ±sƒ±na g√∂re g√∂ster
                const iptcCounts = {};
                totalDocsData.forEach(item => {
                    const iptc = getIPTCCategory(item.theme_code);
                    if (iptc) {
                        if (!iptcCounts[iptc]) iptcCounts[iptc] = new Set();
                        iptcCounts[iptc].add(item.theme_code);
                    }
                });
                
                similarities = Object.entries(iptcCounts)
                    .map(([cat, themes]) => ({
                        category: cat,
                        similarity: themes.size // Tema sayƒ±sƒ± olarak
                    }))
                    .sort((a, b) => b.similarity - a.similarity);
            }
            
            if (similarities.length === 0) {
                return;
            }
            
            const labels = similarities.slice(0, 10).map(s => s.category.split(',')[0].trim());
            const data = similarities.slice(0, 10).map(s => 
                iptcMappingResults ? (s.similarity * 100).toFixed(1) : s.similarity
            );
            const colors = similarities.slice(0, 10).map(s => iptcColors[s.category] || '#999');
            
            const chartTitle = iptcMappingResults 
                ? 'IPTC Kategorileri - Ortalama Benzerlik Skoru (%)'
                : 'IPTC Kategorileri - E≈üle≈üen Tema Sayƒ±sƒ±';
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: iptcMappingResults ? 'Benzerlik (%)' : 'Tema Sayƒ±sƒ±',
                        data: data,
                        backgroundColor: colors.map(c => c + 'AA'),
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: chartTitle,
                            font: { size: 16 }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: iptcMappingResults ? 'Benzerlik (%)' : 'Tema Sayƒ±sƒ±' },
                            max: iptcMappingResults ? 100 : undefined
                        },
                        x: { 
                            ticks: { maxRotation: 45, minRotation: 45 },
                            title: { display: true, text: 'IPTC Kategorisi' }
                        }
                    }
                }
            });
            gdeltChartInstances.push(chart);
        }
        
        // ==================== IPTC MAPPING FONKSƒ∞YONLARI SONU ====================
        
        // ==================== GDELT TEMA ANALƒ∞Zƒ∞ FONKSƒ∞YONLARI ====================
        
        let gdeltTotalDocs = [];      // bquxjob_645c6baa... (country, theme_code, total_docs)
        let gdeltMonthlyQuality = []; // bquxjob_4750d984... (country, theme_code, months_total, months_ok, median_docs)
        let gdeltMonthlyDetail = [];  // bquxjob_5c135702... (ym, country, theme_code, n_docs)
        let gdeltDataLoaded = false;
        
        // IPTC Media Topics - Resmi 17 √úst D√ºzey Kategori
        const IPTC_CATEGORIES = {
            'arts, culture, entertainment and media': ['MEDIA', 'CULTURE'],
            'conflict, war and peace': ['CRISISLEX', 'ARMEDCONFLICT', 'KILL', 'TERROR', 'SECURITY', 'MILITARY'],
            'crime, law and justice': ['CRIME', 'JUSTICE', 'LAW'],
            'disaster, accident and emergency incident': ['MANMADE', 'DISASTER', 'NATURAL'],
            'economy, business and finance': ['ECON', 'EPU', 'EPU_ECONOMY', 'TAX', 'AGRICULTURE'],
            'education': ['EDUCATION'],
            'environment': ['ENV', 'CLIMATE'],
            'health': ['HEALTH', 'MEDICAL', 'GENERAL_HEALTH'],
            'human interest': ['AFFECT', 'GENERAL'],
            'labour': ['LABOR', 'EMPLOYMENT', 'WORKFORCE'],
            'lifestyle and leisure': ['TOURISM', 'TRAVEL', 'LEISURE'],
            'politics and government': ['LEADER', 'ELECTION', 'DEMOCRACY', 'LEGISLATION', 'GOVERNMENT', 'GENERAL_GOVERNMENT', 'GOV', 'UNGP'],
            'religion': ['RELIGION'],
            'science and technology': ['SCIENCE', 'TECHNOLOGY', 'RESEARCH'],
            'society': ['SOC', 'SOCIAL', 'COMMUNITY'],
            'sport': ['SPORT', 'SPORTS'],
            'weather': ['WEATHER', 'CLIMATE_WEATHER']
        };
        
        // T√ºm kullanƒ±labilir GDELT temalarƒ±
        const USABLE_CATEGORIES = [
            // economy, business and finance
            'ECON', 'EPU', 'EPU_ECONOMY', 'TAX', 'AGRICULTURE',
            // conflict, war and peace
            'CRISISLEX', 'ARMEDCONFLICT', 'KILL', 'TERROR', 'SECURITY', 'MILITARY',
            // politics and government
            'LEADER', 'ELECTION', 'DEMOCRACY', 'LEGISLATION', 'GOVERNMENT', 'GENERAL_GOVERNMENT', 'GOV', 'UNGP',
            // health
            'HEALTH', 'MEDICAL', 'GENERAL_HEALTH',
            // education
            'EDUCATION',
            // lifestyle and leisure
            'TOURISM', 'TRAVEL', 'LEISURE',
            // disaster, accident
            'MANMADE', 'DISASTER', 'NATURAL',
            // environment
            'ENV', 'CLIMATE',
            // arts, culture, entertainment
            'MEDIA', 'CULTURE',
            // society
            'SOC', 'SOCIAL',
            // human interest
            'AFFECT', 'GENERAL',
            // religion
            'RELIGION',
            // science and technology
            'SCIENCE', 'TECHNOLOGY'
        ];
        
        const METADATA_PREFIXES = ['TAX_', 'WB_', 'USPEC_', 'UNGP_', 'SOC_', 'SLFID_'];
        
        // Tema i√ßin IPTC kategorisi bul
        function getIPTCCategory(themeCode) {
            for (const [iptcLabel, themes] of Object.entries(IPTC_CATEGORIES)) {
                if (themes.includes(themeCode)) {
                    return iptcLabel;
                }
            }
            return null;
        }
        
        // Tema tipini belirle (IPTC kategorili veya metadata)
        function getThemeType(themeCode) {
            // Metadata kontrol√º (prefix ile ba≈ülayanlar)
            for (const prefix of METADATA_PREFIXES) {
                if (themeCode.startsWith(prefix)) {
                    return 'metadata';
                }
            }
            // IPTC kategorisinde mi?
            const iptc = getIPTCCategory(themeCode);
            if (iptc) {
                return 'iptc';  // IPTC e≈üle≈ümi≈ü kategori
            }
            // Kullanƒ±labilir kategori listesinde mi?
            if (USABLE_CATEGORIES.includes(themeCode)) {
                return 'category';
            }
            // Varsayƒ±lan: Diƒüer
            return 'other';
        }
        
        // CSV parse (basit)
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((h, idx) => {
                    let val = (values[idx] || '').trim();
                    // Sayƒ±sal deƒüerleri d√∂n√º≈üt√ºr
                    if (['total_docs', 'months_total', 'months_ok', 'min_docs', 'median_docs', 'n_docs'].includes(h)) {
                        row[h] = parseInt(val) || 0;
                    } else {
                        row[h] = val;
                    }
                });
                data.push(row);
            }
            return data;
        }
        
        // GDELT Status mesajƒ±
        function showGDELTStatus(message, type = 'info') {
            const el = document.getElementById('gdelt-status');
            el.textContent = message;
            el.className = `status-message ${type}`;
            el.style.display = 'block';
        }
        
        // CSV verilerini y√ºkle
        async function loadGDELTData() {
            const btn = document.getElementById('load-gdelt-data-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>Y√ºkleniyor...';
            
            showGDELTStatus('üì• CSV dosyalarƒ± y√ºkleniyor...', 'info');
            
            try {
                // Tablo-1: total_docs
                const resp1 = await fetch('bquxjob_645c6baa_19b43fe1bcd.csv');
                if (!resp1.ok) throw new Error('total_docs CSV bulunamadƒ±');
                const text1 = await resp1.text();
                gdeltTotalDocs = parseCSV(text1);
                
                // Tablo-2: monthly quality
                const resp2 = await fetch('bquxjob_4750d984_19b43fefa20.csv');
                if (!resp2.ok) throw new Error('monthly quality CSV bulunamadƒ±');
                const text2 = await resp2.text();
                gdeltMonthlyQuality = parseCSV(text2);
                
                // Aylƒ±k detay (opsiyonel)
                try {
                    const resp3 = await fetch('bquxjob_5c135702_19b43f3f270.csv');
                    if (resp3.ok) {
                        const text3 = await resp3.text();
                        gdeltMonthlyDetail = parseCSV(text3);
                    }
                } catch (e) {
                    console.log('Aylƒ±k detay dosyasƒ± y√ºklenemedi (opsiyonel)');
                }
                
                gdeltDataLoaded = true;
                
                // Tablolarƒ± g√ºncelle
                updateTotalDocsTable();
                updateMonthlyQualityTable();
                
                // Butonlarƒ± aktif et
                document.getElementById('analyze-themes-btn').disabled = false;
                document.getElementById('generate-matrix-btn').disabled = false;
                document.getElementById('export-gdelt-btn').disabled = false;
                
                showGDELTStatus(`‚úÖ Veriler y√ºklendi! Toplam Docs: ${gdeltTotalDocs.length} satƒ±r, Aylƒ±k Kalite: ${gdeltMonthlyQuality.length} satƒ±r`, 'success');
                
            } catch (error) {
                showGDELTStatus(`‚ùå Y√ºkleme hatasƒ±: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üì• CSV Verilerini Y√ºkle';
            }
        }
        
        // Tablo-1'i g√ºncelle (total_docs)
        function updateTotalDocsTable() {
            const tbody = document.getElementById('total-docs-tbody');
            const countryFilter = document.getElementById('gdelt-country-select').value;
            
            if (!gdeltDataLoaded || gdeltTotalDocs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">CSV y√ºklenmedi.</td></tr>';
                return;
            }
            
            // Filtrele
            let filtered = gdeltTotalDocs;
            if (countryFilter !== 'ALL') {
                filtered = gdeltTotalDocs.filter(d => d.country === countryFilter);
            }
            
            // Sƒ±rala (total_docs'a g√∂re azalan)
            filtered.sort((a, b) => b.total_docs - a.total_docs);
            
            // ƒ∞lk 100 satƒ±r
            const toShow = filtered.slice(0, 100);
            
            // IPTC renk haritasƒ±
            const iptcColors = {
                'economy, business and finance': '#FF9800',
                'conflict, war and peace': '#F44336',
                'politics and government': '#2196F3',
                'health': '#4CAF50',
                'education': '#9C27B0',
                'lifestyle and leisure': '#00BCD4',
                'disaster, accident and emergency incident': '#E91E63',
                'environment': '#8BC34A',
                'arts, culture, entertainment and media': '#673AB7',
                'society': '#607D8B',
                'human interest': '#FF5722',
                'religion': '#795548',
                'science and technology': '#009688',
                'crime, law and justice': '#3F51B5',
                'labour': '#FFC107',
                'sport': '#CDDC39',
                'weather': '#03A9F4'
            };
            
            tbody.innerHTML = '';
            toShow.forEach(row => {
                const iptcCategory = getIPTCCategory(row.theme_code);
                let iptcBadge = '';
                
                if (iptcCategory) {
                    const color = iptcColors[iptcCategory] || '#667eea';
                    const shortLabel = iptcCategory.split(',')[0]; // ƒ∞lk kƒ±smƒ± al
                    iptcBadge = `<span style="background: ${color}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; text-transform: capitalize;">${shortLabel}</span>`;
                } else {
                    iptcBadge = '<span style="background: #9e9e9e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em;">Diƒüer</span>';
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${row.country}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; font-family: monospace; font-weight: 600;">${row.theme_code}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;">${row.total_docs.toLocaleString()}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${iptcBadge}</td>
                `;
                tbody.appendChild(tr);
            });
            
            if (toShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #999;">Veri bulunamadƒ±</td></tr>';
            }
        }
        
        // Tablo-2'yi g√ºncelle (monthly quality)
        function updateMonthlyQualityTable() {
            const tbody = document.getElementById('monthly-quality-tbody');
            const qualityFilter = document.getElementById('gdelt-quality-filter').value;
            
            if (!gdeltDataLoaded || gdeltMonthlyQuality.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">CSV y√ºklenmedi.</td></tr>';
                return;
            }
            
            // IPTC renk haritasƒ±
            const iptcColors = {
                'economy, business and finance': '#FF9800',
                'conflict, war and peace': '#F44336',
                'politics and government': '#2196F3',
                'health': '#4CAF50',
                'education': '#9C27B0',
                'lifestyle and leisure': '#00BCD4',
                'disaster, accident and emergency incident': '#E91E63',
                'environment': '#8BC34A',
                'arts, culture, entertainment and media': '#673AB7',
                'society': '#607D8B',
                'human interest': '#FF5722',
                'religion': '#795548',
                'science and technology': '#009688',
                'crime, law and justice': '#3F51B5',
                'labour': '#FFC107',
                'sport': '#CDDC39',
                'weather': '#03A9F4'
            };
            
            // Oran hesapla ve filtrele
            let filtered = gdeltMonthlyQuality.map(row => {
                const ratio = row.months_total > 0 ? row.months_ok / row.months_total : 0;
                let decision = '';
                let decisionColor = '';
                
                if (ratio >= 0.7) {
                    decision = '‚úÖ Aylƒ±k';
                    decisionColor = '#4CAF50';
                } else if (ratio >= 0.4) {
                    decision = '‚ö†Ô∏è Quarterly';
                    decisionColor = '#FF9800';
                } else {
                    decision = '‚ùå √áƒ±kar';
                    decisionColor = '#f44336';
                }
                
                return { ...row, ratio, decision, decisionColor };
            });
            
            // Kalite filtresi
            if (qualityFilter === 'good') {
                filtered = filtered.filter(d => d.ratio >= 0.7);
            } else if (qualityFilter === 'marginal') {
                filtered = filtered.filter(d => d.ratio >= 0.4 && d.ratio < 0.7);
            } else if (qualityFilter === 'poor') {
                filtered = filtered.filter(d => d.ratio < 0.4);
            }
            
            // Sadece IPTC kategorisine sahip temalarƒ± g√∂ster
            filtered = filtered.filter(d => getIPTCCategory(d.theme_code) !== null);
            
            // Sƒ±rala (ratio'ya g√∂re azalan)
            filtered.sort((a, b) => b.ratio - a.ratio || b.median_docs - a.median_docs);
            
            // ƒ∞lk 100
            const toShow = filtered.slice(0, 100);
            
            tbody.innerHTML = '';
            toShow.forEach(row => {
                const iptcCategory = getIPTCCategory(row.theme_code);
                const color = iptcColors[iptcCategory] || '#667eea';
                const shortLabel = iptcCategory ? iptcCategory.split(',')[0] : 'Diƒüer';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${row.country}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; font-family: monospace; font-weight: 600;">${row.theme_code}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">
                        <span style="background: ${color}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; text-transform: capitalize;">${shortLabel}</span>
                    </td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">${row.months_ok}/${row.months_total}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center; font-weight: 600;">${(row.ratio * 100).toFixed(0)}%</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center; color: ${row.decisionColor}; font-weight: 600;">${row.decision}</td>
                `;
                tbody.appendChild(tr);
            });
            
            if (toShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">Filtreye uygun veri yok</td></tr>';
            }
        }
        
        // Tema analizi yap
        function analyzeThemes() {
            if (!gdeltDataLoaded) {
                showGDELTStatus('‚ùå √ñnce CSV verilerini y√ºkleyin!', 'error');
                return;
            }
            
            showGDELTStatus('üîç Tema analizi yapƒ±lƒ±yor...', 'info');
            
            // T√ºm √ºlkelerde ortak olan ve y√ºksek hacimli temalarƒ± bul
            const countries = ['CE', 'HO', 'HR', 'KG', 'LO', 'SA'];
            const themeCountByCountry = {};
            
            // Her tema i√ßin hangi √ºlkelerde var?
            gdeltTotalDocs.forEach(row => {
                if (!themeCountByCountry[row.theme_code]) {
                    themeCountByCountry[row.theme_code] = { countries: new Set(), totalDocs: 0 };
                }
                themeCountByCountry[row.theme_code].countries.add(row.country);
                themeCountByCountry[row.theme_code].totalDocs += row.total_docs;
            });
            
            // T√ºm 6 √ºlkede bulunan temalar
            const commonThemes = [];
            for (const [theme, data] of Object.entries(themeCountByCountry)) {
                if (data.countries.size === 6 && getThemeType(theme) === 'category') {
                    commonThemes.push({ theme, totalDocs: data.totalDocs });
                }
            }
            
            // Toplam docs'a g√∂re sƒ±rala
            commonThemes.sort((a, b) => b.totalDocs - a.totalDocs);
            
            // Listeyi g√ºncelle
            const listEl = document.getElementById('common-themes-list');
            if (commonThemes.length > 0) {
                listEl.innerHTML = commonThemes.slice(0, 20).map(t => 
                    `<div style="margin-bottom: 4px;"><code style="background: #e8f5e9; padding: 2px 6px; border-radius: 3px;">${t.theme}</code> <span style="color: #666;">(${(t.totalDocs/1000000).toFixed(2)}M docs)</span></div>`
                ).join('');
            } else {
                listEl.innerHTML = '<span style="color: #f44336;">Hi√ßbir tema 6 √ºlkede ortak deƒüil!</span>';
            }
            
            showGDELTStatus(`‚úÖ Analiz tamamlandƒ±! ${commonThemes.length} ortak tema bulundu.`, 'success');
        }
        
        // √úlke-Kategori matrisi olu≈ütur
        function generateCountryThemeMatrix() {
            if (!gdeltDataLoaded) {
                showGDELTStatus('‚ùå √ñnce CSV verilerini y√ºkleyin!', 'error');
                return;
            }
            
            showGDELTStatus('üìä Matris olu≈üturuluyor...', 'info');
            
            const countries = ['CE', 'HO', 'HR', 'KG', 'LO', 'SA'];
            const categoryGroups = {
                'Economy': ['ECON', 'EPU_ECONOMY', 'EPU'],
                'Government': ['GENERAL_GOVERNMENT', 'GENERAL', 'GOV', 'LEADER'],
                'Security': ['CRISISLEX', 'ARMEDCONFLICT', 'TERROR', 'SECURITY'],
                'Health': ['HEALTH', 'MEDICAL'],
                'Education': ['EDUCATION'],
                'Tourism': ['TOURISM']
            };
            
            // Her √ºlke-kategori i√ßin ratio hesapla
            const matrix = {};
            countries.forEach(country => {
                matrix[country] = {};
                
                for (const [catName, themeCodes] of Object.entries(categoryGroups)) {
                    // Bu kategorideki temalarƒ±n kalitesini kontrol et
                    let bestRatio = 0;
                    let bestDecision = '‚úñ';
                    let bestColor = '#f44336';
                    
                    for (const themeCode of themeCodes) {
                        const qualityRow = gdeltMonthlyQuality.find(
                            r => r.country === country && r.theme_code === themeCode
                        );
                        
                        if (qualityRow) {
                            const ratio = qualityRow.months_total > 0 ? qualityRow.months_ok / qualityRow.months_total : 0;
                            if (ratio > bestRatio) {
                                bestRatio = ratio;
                                if (ratio >= 0.7) {
                                    bestDecision = '‚úî';
                                    bestColor = '#4CAF50';
                                } else if (ratio >= 0.4) {
                                    bestDecision = '‚ö†';
                                    bestColor = '#FF9800';
                                } else {
                                    bestDecision = '‚úñ';
                                    bestColor = '#f44336';
                                }
                            }
                        }
                    }
                    
                    matrix[country][catName] = { ratio: bestRatio, decision: bestDecision, color: bestColor };
                }
            });
            
            // Tabloyu render et
            const tbody = document.getElementById('matrix-tbody');
            tbody.innerHTML = '';
            
            countries.forEach(country => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding: 12px; font-weight: 600; border-bottom: 1px solid #eee;">${country}</td>
                    ${Object.keys(categoryGroups).map(cat => {
                        const cell = matrix[country][cat];
                        return `<td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee; color: ${cell.color}; font-weight: 600; font-size: 1.2em;" title="${(cell.ratio * 100).toFixed(0)}%">${cell.decision}</td>`;
                    }).join('')}
                `;
                tbody.appendChild(tr);
            });
            
            showGDELTStatus('‚úÖ Matris olu≈üturuldu!', 'success');
        }
        
        // GDELT analizini CSV olarak dƒ±≈üa aktar
        function exportGDELTAnalysis() {
            if (!gdeltDataLoaded) {
                showGDELTStatus('‚ùå √ñnce CSV verilerini y√ºkleyin!', 'error');
                return;
            }
            
            // Aylƒ±k kalite verilerini dƒ±≈üa aktar
            let csv = 'country,theme_code,theme_type,months_total,months_ok,ratio,median_docs,decision\n';
            
            gdeltMonthlyQuality.forEach(row => {
                const themeType = getThemeType(row.theme_code);
                if (themeType !== 'category') return; // Sadece kategorileri
                
                const ratio = row.months_total > 0 ? (row.months_ok / row.months_total) : 0;
                let decision = ratio >= 0.7 ? 'monthly' : (ratio >= 0.4 ? 'quarterly' : 'exclude');
                
                csv += `${row.country},${row.theme_code},${themeType},${row.months_total},${row.months_ok},${ratio.toFixed(3)},${row.median_docs},${decision}\n`;
            });
            
            // ƒ∞ndir
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `gdelt_theme_analysis_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            showGDELTStatus('‚úÖ Analiz sonu√ßlarƒ± CSV olarak indirildi!', 'success');
        }
        
        // ==================== GDELT TEMA ANALƒ∞Zƒ∞ FONKSƒ∞YONLARI SONU ====================
        
        // Sayfa y√ºklendiƒüinde
        window.addEventListener('DOMContentLoaded', () => {
            initTabButtons();
            initPipelineButtons();  // Pipeline se√ßim butonlarƒ±nƒ± ba≈ülat
            initExportFilters();    // Export filtre event listener'larƒ±nƒ± ba≈ülat
            attachEventListeners();
            updateInfoBox();
            
            // √ñnce otomatik y√ºkleme dene, yoksa varsayƒ±lan veriyi y√ºkle
            autoLoadLastAnalysis().then(() => {
                // Eƒüer veri y√ºklenmediyse varsayƒ±lan veriyi y√ºkle
                if (allData.length === 0) {
                    loadData();
                }
                // Export filtre bilgisini g√ºncelle
                updateExportFilterInfo();
            });
        });
        
        // Debug: GDELT Clustering otomatik y√ºkleme (sayfa y√ºklendiƒüinde test i√ßin)
        document.addEventListener('DOMContentLoaded', () => {
            // Clustering sekmesine ge√ßilirse otomatik olarak sonu√ßlarƒ± y√ºklemeye √ßalƒ±≈ü
            const loadResultsBtn = document.getElementById('gdelt-load-results-btn');
            if (loadResultsBtn) {
                // Buton etkinle≈ütir ve tƒ±kla
                loadResultsBtn.disabled = false;
                // Sayfa y√ºklendikten 2 saniye sonra otomatik y√ºkleme dene
                setTimeout(() => {
                    loadGDELTClusteringResults().catch(e => console.warn('Auto-load failed:', e));
                }, 2000);
            }
        });
    </script>
</body>
</html>
