<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDELT Theme ‚Üí IPTC Media Topics Mapping Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .config-panel {
            background: #e8eaf6;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .config-group {
            display: flex;
            flex-direction: column;
        }
        
        .config-group label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .config-group input,
        .config-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .config-buttons {
            display: flex;
            gap: 10px;
        }
        
        .run-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .run-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .run-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            padding: 10px 15px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .methodology {
            font-size: 0.95em;
            opacity: 0.85;
            margin-top: 10px;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .stat-card h3 {
            color: #667eea;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .filter-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .method-tabs {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        
        .method-tab {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .method-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .charts-section {
            padding: 30px;
            background: #f8f9fa;
        }
        
        #tab-charts .charts-section {
            padding: 20px;
            background: transparent;
        }
        
        .method-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-box {
            background: #e8eaf6;
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        
        .info-box h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .info-box p {
            font-size: 0.9em;
            color: #555;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .formula-container {
            background: white;
            padding: 20px;
            border-radius: 5px;
            margin: 15px 0;
            text-align: center;
            border: 1px solid #d0d0e8;
        }
        
        .formula-title {
            font-size: 0.85em;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .katex {
            font-size: 1.1em;
        }
        
        .parameters-list {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #d0d0e8;
            margin-top: 10px;
        }
        
        .parameters-list h5 {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .param-item {
            font-size: 0.85em;
            color: #555;
            line-height: 1.6;
            margin-bottom: 6px;
            padding-left: 10px;
            border-left: 2px solid #667eea;
        }
        
        .param-item strong {
            color: #667eea;
        }
        
        .country-detail-view {
            display: none;
        }
        
        .country-detail-view.active {
            display: block;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        
        .detail-header h3 {
            color: #667eea;
            font-size: 1.5em;
            margin: 0;
        }
        
        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .back-button:hover {
            background: #5a6268;
        }
        
        .calculation-section {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .calculation-section h4 {
            color: #667eea;
            margin-top: 0;
            font-size: 1.05em;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .data-table th, .data-table td {
            padding: 8px;
            text-align: right;
            border: 1px solid #ddd;
        }
        
        .data-table th {
            background: #f0f0f5;
            color: #667eea;
            font-weight: 600;
        }
        
        .data-table tr:hover {
            background: #f9f9fc;
        }
        
        .calculation-steps {
            background: #f9f9fc;
            padding: 12px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        .calculation-step {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-left: 3px solid #667eea;
            padding-left: 12px;
        }
        
        .formula-result {
            background: #e8eaf6;
            padding: 12px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: 600;
            color: #667eea;
            text-align: center;
            font-size: 1.1em;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .chart-container h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #667eea;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            background: rgba(255,255,255,0.1);
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .positive {
            color: #27ae60;
            font-weight: bold;
        }
        
        .negative {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .significant {
            background: #ecf0f1;
            font-weight: 500;
        }
        
        .table-wrapper {
            padding: 30px;
            overflow-x: auto;
        }
        
        .legend {
            padding: 20px;
            background: #f8f9fa;
            margin-top: 20px;
            border-radius: 8px;
            font-size: 0.95em;
        }
        
        .legend p {
            margin-bottom: 8px;
        }
        
        /* TAB STYLING */
        .tabs-container {
            display: flex;
            gap: 5px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 12px 24px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s;
            color: #666;
        }
        
        .tab-button:hover {
            background: #f0f0f0;
            border-color: #667eea;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .tab-content {
            display: none;
            width: 100%;
            animation: fadeIn 0.3s ease-in;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåê GDELT Theme ‚Üí IPTC Media Topics Mapping</h1>
            <p>Semantic Embedding Analysis with Sentence-Transformers (all-MiniLM-L6-v2)</p>
            <p class="methodology">Cosine Similarity ‚Ä¢ IPTC NewsCodes (17 Categories) ‚Ä¢ Supervised Mapping</p>
        </header>
        
        <div class="config-panel">
            <h3 style="color: #0f3460; margin-bottom: 15px;">‚öôÔ∏è GDELT & IPTC Analiz Parametreleri</h3>
            <div class="config-grid">
                <div class="config-group">
                    <label for="min-docs-threshold">Min. Dok√ºman E≈üiƒüi:</label>
                    <input type="number" id="min-docs-threshold" min="0" max="100000" value="1000" title="Minimum toplam dok√ºman sayƒ±sƒ± filtresi">
                </div>
                <div class="config-group">
                    <label for="quality-threshold">Min. Kalite Oranƒ± (%):</label>
                    <input type="number" id="quality-threshold" min="0" max="100" value="50" title="Minimum aylƒ±k kalite oranƒ±">
                </div>
                <div class="config-group">
                    <label for="similarity-threshold">Min. Benzerlik Skoru:</label>
                    <input type="number" id="similarity-threshold" min="0" max="1" step="0.01" value="0.30" title="IPTC e≈üle≈ütirme minimum benzerlik">
                </div>
                <div class="config-group">
                    <label for="iptc-filter-param">IPTC Kategori Filtresi:</label>
                    <select id="iptc-filter-param">
                        <option value="all">T√ºm Kategoriler (17)</option>
                        <option value="economy, business and finance">üí∞ Economy</option>
                        <option value="conflict, war and peace">‚öîÔ∏è Conflict</option>
                        <option value="politics and government">üèõÔ∏è Politics</option>
                        <option value="health">üè• Health</option>
                        <option value="education">üìö Education</option>
                        <option value="disaster, accident and emergency incident">üö® Disaster</option>
                        <option value="environment">üåç Environment</option>
                    </select>
                </div>
            </div>
            <div class="config-buttons">
                <button class="run-btn" id="run-analysis-btn" onclick="applyGDELTFilters()">üîç Filtreleri Uygula</button>
                <button class="run-btn" style="background: #6c757d;" id="reset-btn" onclick="resetGDELTFilters()">üîÑ Sƒ±fƒ±rla</button>
                <span style="margin: 0 10px; color: #999;">|</span>
                <button class="run-btn" style="background: #28a745;" id="save-btn" title="Mevcut analizi kaydet" onclick="saveGDELTAnalysis()">üíæ Kaydet</button>
                <button class="run-btn" style="background: #17a2b8;" id="import-btn" title="Dosyadan i√ße aktar" onclick="triggerImport()">üì• ƒ∞√ße Aktar</button>
                <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="handleGDELTImportFile(event)">
            </div>
            <div class="status-message" id="status-message"></div>
        </div>
        
        <!-- TAB BUTTONS -->
        <div class="tabs-container">
            <button class="tab-button active" data-tab="gdelt">üì∞ GDELT Tema</button>
            <button class="tab-button" data-tab="charts">üìà Grafikler</button>
            <button class="tab-button" data-tab="clustering">ü§ñ K√ºmeleme</button>
            <button class="tab-button" data-tab="export">üì§ Dƒ±≈üarƒ± Aktar</button>
        </div>
        
        <!-- TAB 2: CHARTS - GDELT/IPTC Grafikleri -->
        <div class="tab-content" id="tab-charts">
            <div class="charts-section">
                <h3 style="color: #0f3460; margin-bottom: 20px; text-align: center;">üìà GDELT Tema & IPTC Kategori Grafikleri</h3>
                <p style="text-align: center; color: #666; margin-bottom: 25px;">
                    GDELT tema daƒüƒ±lƒ±mlarƒ± ve IPTC kategori bazlƒ± g√∂rselle≈ütirmeler
                </p>
                
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>üìä IPTC Kategori Daƒüƒ±lƒ±mƒ±</h3>
                        <div class="chart-wrapper">
                            <canvas id="iptc-distribution-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>üåç √úlke Bazlƒ± Tema Hacmi</h3>
                        <div class="chart-wrapper">
                            <canvas id="country-theme-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>üìà En Y√ºksek Hacimli Temalar</h3>
                        <div class="chart-wrapper">
                            <canvas id="top-themes-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>üéØ IPTC Benzerlik Skorlarƒ±</h3>
                        <div class="chart-wrapper">
                            <canvas id="iptc-similarity-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Grafik Olu≈ütur Butonu -->
                <div style="text-align: center; margin-top: 20px;">
                    <button class="run-btn" onclick="generateGDELTCharts()">üîÑ Grafikleri Olu≈ütur</button>
                    <p style="font-size: 0.85em; color: #888; margin-top: 10px;">
                        Not: √ñnce GDELT Tema sekmesinden CSV verilerini y√ºkleyin
                    </p>
                </div>
            </div>
        </div>
        
        <!-- TAB 3: CLUSTERING -->
        <div class="tab-content" id="tab-clustering">
            <!-- GDELT Theme ‚Üí IPTC Media Topics Mapping -->
            <div class="charts-section" style="text-align: center; padding: 20px;">
                <h3 style="color: #667eea; margin-bottom: 20px;">üéØ GDELT Tema ‚Üí IPTC Media Topics E≈üle≈ütirme</h3>
                <p style="text-align: center; color: #666; margin-bottom: 15px;">
                    Sentence-Transformer embedding + Cosine Similarity ‚Üí IPTC NewsCodes (17 √ºst d√ºzey kategori)
                </p>
                <p style="text-align: center; color: #888; font-size: 0.85em; margin-bottom: 20px;">
                    <em>Referans: Kuzman & Ljube≈°iƒá (2024), Vargo & Guo (2017), Tarekegn (2024)</em>
                </p>
                
                <!-- Algoritma Se√ßimi -->
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; max-width: 700px; margin: 0 auto 25px;">
                    <h4 style="color: #333; margin-bottom: 15px;">Algoritma Secimi</h4>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 20px; border: 2px solid #667eea; border-radius: 8px; background: white; transition: all 0.3s;" class="algo-option">
                            <input type="radio" name="iptc-algorithm" value="v2" checked style="width: 18px; height: 18px;">
                            <div style="text-align: left;">
                                <strong style="color: #667eea;">V2: ƒ∞ki Katmanlƒ± Fusion</strong>
                                <div style="font-size: 0.8em; color: #666;">Kural tabanlƒ± + Embedding NN (√ñnerilen)</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 20px; border: 2px solid #ddd; border-radius: 8px; background: white; transition: all 0.3s;" class="algo-option">
                            <input type="radio" name="iptc-algorithm" value="v1" style="width: 18px; height: 18px;">
                            <div style="text-align: left;">
                                <strong style="color: #666;">V1: Sadece Embedding</strong>
                                <div style="font-size: 0.8em; color: #999;">Cosine similarity NN</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Progress Gostergesi -->
                <div id="iptc-progress-container" style="display: none; max-width: 600px; margin: 0 auto 25px; background: #f0f4f8; border-radius: 10px; padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div class="loading-spinner" style="width: 24px; height: 24px;"></div>
                        <span id="iptc-progress-text" style="font-weight: 600; color: #333;">Baslatiliyor...</span>
                    </div>
                    <div style="background: #e0e0e0; border-radius: 5px; height: 8px; overflow: hidden;">
                        <div id="iptc-progress-bar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                    <div id="iptc-progress-steps" style="margin-top: 15px; text-align: left; font-size: 0.85em;">
                        <div class="progress-step" data-step="1" style="padding: 8px 0; color: #666; display: flex; align-items: center; gap: 10px;">
                            <span class="step-icon" style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #6b7280; color: white; font-size: 12px; font-weight: bold;">1</span>
                            <span class="step-text">Katman 1: Kural tabanli mapping (prefix + Vargo)</span>
                        </div>
                        <div class="progress-step" data-step="2" style="padding: 8px 0; color: #666; display: flex; align-items: center; gap: 10px;">
                            <span class="step-icon" style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #6b7280; color: white; font-size: 12px; font-weight: bold;">2</span>
                            <span class="step-text">Katman 2: Sentence-BERT embedding hesaplama</span>
                        </div>
                        <div class="progress-step" data-step="3" style="padding: 8px 0; color: #666; display: flex; align-items: center; gap: 10px;">
                            <span class="step-icon" style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #6b7280; color: white; font-size: 12px; font-weight: bold;">3</span>
                            <span class="step-text">Cosine similarity NN atama</span>
                        </div>
                        <div class="progress-step" data-step="4" style="padding: 8px 0; color: #666; display: flex; align-items: center; gap: 10px;">
                            <span class="step-icon" style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #6b7280; color: white; font-size: 12px; font-weight: bold;">4</span>
                            <span class="step-text">Fusion: Kural + Embedding birlestirme</span>
                        </div>
                        <div class="progress-step" data-step="5" style="padding: 8px 0; color: #666; display: flex; align-items: center; gap: 10px;">
                            <span class="step-icon" style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #6b7280; color: white; font-size: 12px; font-weight: bold;">5</span>
                            <span class="step-text">Sonuclari kaydetme</span>
                        </div>
                    </div>
                </div>
                
                <!-- Kontrol Paneli -->
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; justify-content: center;">
                    <button class="run-btn" id="iptc-mapping-btn" onclick="runIPTCMapping()">üöÄ IPTC E≈üle≈ütirme √áalƒ±≈ütƒ±r</button>
                    <button class="run-btn" style="background: #4CAF50;" id="iptc-load-results-btn" onclick="loadIPTCMappingResults()">üì• Sonu√ßlarƒ± Y√ºkle</button>
                </div>
                <div id="iptc-mapping-status" class="status-message" style="max-width: 800px; margin: 0 auto 20px;"></div>
                
                <!-- IPTC Kategori Kartlarƒ± Grid -->
                <div id="iptc-categories-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px auto; max-width: 1000px;">
                    <!-- Dinamik olarak doldurulacak -->
                </div>
                
                <!-- Tema-IPTC E≈üle≈ütirme Tablosu -->
                <div class="chart-container" style="margin-top: 25px; max-width: 900px; margin-left: auto; margin-right: auto;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">üìä T√ºm Temalar ve IPTC E≈üle≈ütirmeleri</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table id="iptc-themes-table" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                            <thead style="position: sticky; top: 0; background: #e3f2fd;">
                                <tr>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #2196F3;">Tema Kodu</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #2196F3;">IPTC Kategori</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #2196F3;">Benzerlik</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #2196F3;">G√ºven</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #2196F3;">2. En Yakƒ±n</th>
                                </tr>
                            </thead>
                            <tbody id="iptc-themes-tbody">
                                <tr><td colspan="5" style="text-align: center; padding: 30px; color: #999;">IPTC e≈üle≈ütirme sonu√ßlarƒ± y√ºklenmedi</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB 1: GDELT TEMA ANALƒ∞Zƒ∞ -->
        <div class="tab-content active" id="tab-gdelt">
            <div class="charts-section">
                <h3 style="color: #0f3460; margin-bottom: 20px; text-align: center;">üì∞ GDELT Tema ‚Üí IPTC Media Topics Analizi</h3>
                <p style="text-align: center; color: #666; margin-bottom: 25px;">
                    GDELT GKG temalarƒ±nƒ±n IPTC NewsCodes (17 √ºst d√ºzey kategori) ile semantic e≈üle≈ütirmesi
                </p>
                
                <!-- Kontrol Paneli -->
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; justify-content: center;">
                    <button class="run-btn" id="load-gdelt-data-btn" onclick="loadGDELTData()">üì• CSV Verilerini Y√ºkle</button>
                    <button class="run-btn" style="background: #4CAF50;" id="analyze-themes-btn" onclick="analyzeThemes()" disabled>üîç Tema Analizi Yap</button>
                    <button class="run-btn" style="background: #FF9800;" id="generate-matrix-btn" onclick="generateCountryThemeMatrix()" disabled>üìä Matris Olu≈ütur</button>
                </div>
                
                <div id="gdelt-status" class="status-message" style="max-width: 600px; margin: 0 auto 20px;"></div>
                
                <!-- Ana ƒ∞√ßerik Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                    
                    <!-- SOL PANEL: Tablo-1 (total_docs) -->
                    <div class="chart-container" style="border-left: 4px solid #2196F3;">
                        <h4 style="color: #2196F3; margin-bottom: 10px;">üìã Tablo-1: Toplam Haber Hacmi</h4>
                        <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">
                            Her √ºlke-tema i√ßin 2022-2024 toplam dok√ºman sayƒ±sƒ± (Hocanƒ±n 2. maddesi i√ßin)
                        </p>
                        
                        <!-- √úlke Se√ßimi -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: 600; font-size: 0.9em;">√úlke Se√ß:</label>
                            <select id="gdelt-country-select" onchange="updateTotalDocsTable()" style="padding: 8px 12px; border-radius: 5px; border: 1px solid #ddd; margin-left: 10px;">
                                <option value="ALL">üåç T√ºm √úlkeler</option>
                                <option value="CE">CE - Sri Lanka</option>
                                <option value="HO">HO - Honduras</option>
                                <option value="HR">HR - Croatia</option>
                                <option value="KG">KG - Kyrgyzstan</option>
                                <option value="LO">LO - Slovakia</option>
                                <option value="SA">SA - Saudi Arabia</option>
                            </select>
                        </div>
                        
                        <!-- Tablo -->
                        <div style="max-height: 450px; overflow-y: auto;">
                            <table id="total-docs-table" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                                <thead style="position: sticky; top: 0; background: #e3f2fd;">
                                    <tr>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #2196F3;">√úlke</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #2196F3;">Tema Kodu</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #2196F3;">Toplam Dok√ºman</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #2196F3;">IPTC Kategorisi</th>
                                    </tr>
                                </thead>
                                <tbody id="total-docs-tbody">
                                    <tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">CSV y√ºklenmedi. Yukarƒ±daki butona tƒ±klayƒ±n.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- A√ßƒ±klama -->
                        <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 5px; font-size: 0.85em;">
                            <strong>üéØ IPTC Media Topics (17 Kategori):</strong><br>
                            üí∞ <span style="color: #FF9800;">Economy</span>: ECON, EPU, EPU_ECONOMY |
                            ‚öîÔ∏è <span style="color: #F44336;">Conflict</span>: CRISISLEX, ARMEDCONFLICT |
                            üèõÔ∏è <span style="color: #2196F3;">Politics</span>: LEADER, GOV, ELECTION<br>
                            üè• <span style="color: #4CAF50;">Health</span>: HEALTH, MEDICAL |
                            üìö <span style="color: #9C27B0;">Education</span>: EDUCATION |
                            ‚úàÔ∏è <span style="color: #00BCD4;">Lifestyle</span>: TOURISM
                        </div>
                    </div>
                    
                    <!-- SAƒû PANEL: Tablo-2 (months_ok, median_docs) -->
                    <div class="chart-container" style="border-left: 4px solid #4CAF50;">
                        <h4 style="color: #4CAF50; margin-bottom: 10px;">üìã Tablo-2: Aylƒ±k Veri Kalitesi</h4>
                        <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">
                            Her √ºlke-tema i√ßin aylƒ±k haber yeterliliƒüi (Hocanƒ±n 3. maddesi i√ßin)
                        </p>
                        
                        <!-- Filtre -->
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <label style="font-weight: 600; font-size: 0.9em;">Kalite Filtresi:</label>
                            <select id="gdelt-quality-filter" onchange="updateMonthlyQualityTable()" style="padding: 8px 12px; border-radius: 5px; border: 1px solid #ddd;">
                                <option value="all">T√ºm√º</option>
                                <option value="good">‚úÖ ƒ∞yi (‚â•70%)</option>
                                <option value="marginal">‚ö†Ô∏è Sƒ±nƒ±rda (40-70%)</option>
                                <option value="poor">‚ùå Yetersiz (<40%)</option>
                            </select>
                        </div>
                        
                        <!-- Tablo -->
                        <div style="max-height: 450px; overflow-y: auto;">
                            <table id="monthly-quality-table" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                                <thead style="position: sticky; top: 0; background: #e8f5e9;">
                                    <tr>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #4CAF50;">√úlke</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #4CAF50;">Tema</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #4CAF50;">IPTC Kategorisi</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #4CAF50;">Ay</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #4CAF50;">Oran</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #4CAF50;">Karar</th>
                                    </tr>
                                </thead>
                                <tbody id="monthly-quality-tbody">
                                    <tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">CSV y√ºklenmedi. Yukarƒ±daki butona tƒ±klayƒ±n.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Karar Kurallarƒ± -->
                        <div style="margin-top: 15px; padding: 12px; background: #e8f5e9; border-radius: 5px; font-size: 0.85em;">
                            <strong>üìå Karar Kurallarƒ± (Aylƒ±k Sentiment i√ßin):</strong><br>
                            ‚úÖ <span style="color: #4CAF50;">months_ok/total ‚â• 0.7</span> ‚Üí Kullan (aylƒ±k)<br>
                            ‚ö†Ô∏è <span style="color: #FF9800;">0.4 ‚Äì 0.7</span> ‚Üí Quarterly aggregation<br>
                            ‚ùå <span style="color: #f44336;">< 0.4</span> ‚Üí O kategoriyi √ßƒ±kar
                        </div>
                    </div>
                </div>
                
                <!-- √ñZET PANEL: Se√ßilen Kategoriler & Matris -->
                <div class="chart-container" style="margin-top: 25px; border-left: 4px solid #9C27B0;">
                    <h4 style="color: #9C27B0; margin-bottom: 15px;">üéØ Adƒ±m A: Ana Kategori Se√ßimi (5-6 Kategori)</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <!-- √ñnerilen Kategoriler (IPTC 17 Kategori) -->
                        <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                            <h5 style="color: #9C27B0; margin-bottom: 10px;">üéØ IPTC Media Topics (17 Kategori)</h5>
                            <div id="suggested-categories" style="font-size: 0.85em; line-height: 1.7; max-height: 280px; overflow-y: auto;">
                                <div>üé® <strong>Arts/Media:</strong> <code>MEDIA</code>, <code>CULTURE</code></div>
                                <div>‚öîÔ∏è <strong>Conflict:</strong> <code>CRISISLEX</code>, <code>ARMEDCONFLICT</code>, <code>TERROR</code></div>
                                <div>üëÆ <strong>Crime/Justice:</strong> <code>CRIME</code>, <code>LAW</code></div>
                                <div>üö® <strong>Disaster:</strong> <code>MANMADE</code>, <code>DISASTER</code>, <code>NATURAL</code></div>
                                <div>üí∞ <strong>Economy:</strong> <code>ECON</code>, <code>EPU</code>, <code>EPU_ECONOMY</code></div>
                                <div>üìö <strong>Education:</strong> <code>EDUCATION</code></div>
                                <div>üåç <strong>Environment:</strong> <code>ENV</code>, <code>CLIMATE</code></div>
                                <div>üè• <strong>Health:</strong> <code>HEALTH</code>, <code>MEDICAL</code></div>
                                <div>‚ù§Ô∏è <strong>Human Interest:</strong> <code>AFFECT</code>, <code>GENERAL</code></div>
                                <div>üíº <strong>Labour:</strong> <code>LABOR</code>, <code>EMPLOYMENT</code></div>
                                <div>‚úàÔ∏è <strong>Lifestyle:</strong> <code>TOURISM</code>, <code>TRAVEL</code></div>
                                <div>üèõÔ∏è <strong>Politics:</strong> <code>LEADER</code>, <code>ELECTION</code>, <code>GOV</code></div>
                                <div>üïå <strong>Religion:</strong> <code>RELIGION</code></div>
                                <div>üî¨ <strong>Science/Tech:</strong> <code>SCIENCE</code>, <code>TECHNOLOGY</code></div>
                                <div>üë• <strong>Society:</strong> <code>SOC</code>, <code>SOCIAL</code></div>
                                <div>‚öΩ <strong>Sport:</strong> <code>SPORT</code></div>
                                <div>üå§Ô∏è <strong>Weather:</strong> <code>WEATHER</code></div>
                            </div>
                        </div>
                        
                        <!-- T√ºm √úlkelerde Ortak Temalar -->
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                            <h5 style="color: #4CAF50; margin-bottom: 10px;">‚úÖ T√ºm √úlkelerde Y√ºksek Hacimli Ortak Temalar</h5>
                            <div id="common-themes-list" style="font-size: 0.9em; line-height: 1.6; max-height: 200px; overflow-y: auto;">
                                <span style="color: #999;">Analiz sonrasƒ± doldurulacak...</span>
                            </div>
                        </div>
                        
                        <!-- Rapor C√ºmleleri -->
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                            <h5 style="color: #FF9800; margin-bottom: 10px;">üìù Rapor i√ßin Hazƒ±r C√ºmleler</h5>
                            <div style="font-size: 0.85em; line-height: 1.6;">
                                <p style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px;">
                                    <em>"We identified the most frequent GDELT theme families for each country and retained those that consistently appeared across all six countries and corresponded to meaningful news topics."</em>
                                </p>
                                <p style="padding: 8px; background: white; border-radius: 4px;">
                                    <em>"To ensure robust sentiment aggregation, we required at least 50 distinct news records per country‚Äìtheme‚Äìmonth. Categories failing this criterion were either excluded or aggregated quarterly."</em>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Adƒ±m B: √úlke-Kategori Matrisi -->
                    <h4 style="color: #E91E63; margin: 25px 0 15px;">üìä Adƒ±m B: √úlke-Kategori Kullanƒ±labilirlik Matrisi</h4>
                    <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">
                        ‚úî = Aylƒ±k sentiment i√ßin uygun (‚â•70%) | ‚ö† = Quarterly gerekli (40-70%) | ‚úñ = Yetersiz (<40%)
                    </p>
                    
                    <div style="overflow-x: auto;">
                        <table id="country-theme-matrix" style="width: 100%; border-collapse: collapse; font-size: 0.9em; text-align: center;">
                            <thead style="background: linear-gradient(135deg, #E91E63 0%, #9C27B0 100%); color: white;">
                                <tr>
                                    <th style="padding: 12px;">√úlke</th>
                                    <th style="padding: 12px;">Economy</th>
                                    <th style="padding: 12px;">Government</th>
                                    <th style="padding: 12px;">Security</th>
                                    <th style="padding: 12px;">Health</th>
                                    <th style="padding: 12px;">Education</th>
                                    <th style="padding: 12px;">Tourism</th>
                                </tr>
                            </thead>
                            <tbody id="matrix-tbody">
                                <tr><td colspan="7" style="text-align: center; padding: 30px; color: #999;">"Matris Olu≈ütur" butonuna tƒ±klayƒ±n</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Export Butonu -->
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="run-btn" style="background: #9C27B0;" onclick="exportGDELTAnalysis()" disabled id="export-gdelt-btn">üì§ Analiz Sonu√ßlarƒ±nƒ± CSV Olarak ƒ∞ndir</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB 5: EXPORT - GDELT/IPTC Export -->
        <div class="tab-content" id="tab-export">
            <div class="charts-section">
                <h3 style="color: #0f3460; margin-bottom: 20px; text-align: center;">üì§ GDELT & IPTC Veri Dƒ±≈üarƒ± Aktarma</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px;">
                    
                    <!-- GDELT TEMA EXPORT -->
                    <div class="chart-container" style="border-left: 4px solid #4CAF50;">
                        <h4 style="color: #4CAF50; margin-bottom: 15px;">üìã GDELT Tema Verileri</h4>
                        
                        <!-- S√ºtun Se√ßimi -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: 600; color: #333; display: block; margin-bottom: 8px;">S√ºtunlar:</label>
                            <div id="export-columns-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; background: #f8f9fa; padding: 12px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="country" checked> √úlke
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="theme_code" checked> Tema Kodu
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="total_docs" checked> Toplam Dok√ºman
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="iptc_category" checked> IPTC Kategorisi
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="months_ok"> Uygun Ay Sayƒ±sƒ±
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="months_total"> Toplam Ay
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="quality_ratio"> Kalite Oranƒ±
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" class="export-col-checkbox" value="median_docs"> Median Dok√ºman
                                </label>
                            </div>
                            <div style="margin-top: 8px;">
                                <button onclick="selectAllExportCols()" style="padding: 5px 10px; font-size: 0.85em; cursor: pointer; margin-right: 5px;">T√ºm√ºn√º Se√ß</button>
                                <button onclick="deselectAllExportCols()" style="padding: 5px 10px; font-size: 0.85em; cursor: pointer;">T√ºm√ºn√º Kaldƒ±r</button>
                            </div>
                        </div>
                        
                        <!-- IPTC Filtre Se√ßimi -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: 600; color: #333; display: block; margin-bottom: 8px;">IPTC Kategori Filtresi:</label>
                            <select id="export-iptc-filter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="all">T√ºm Kategoriler</option>
                                <option value="economy, business and finance">üí∞ Economy</option>
                                <option value="conflict, war and peace">‚öîÔ∏è Conflict</option>
                                <option value="politics and government">üèõÔ∏è Politics</option>
                                <option value="health">üè• Health</option>
                                <option value="education">üìö Education</option>
                                <option value="lifestyle and leisure">‚úàÔ∏è Lifestyle</option>
                                <option value="disaster, accident and emergency incident">üö® Disaster</option>
                                <option value="environment">üåç Environment</option>
                                <option value="arts, culture, entertainment and media">üé® Arts/Media</option>
                                <option value="society">üë• Society</option>
                            </select>
                        </div>
                        
                        <!-- Export Butonlarƒ± -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="run-btn" style="background: #4CAF50;" onclick="exportGDELTDataXLSX()">
                                üìä XLSX ƒ∞ndir
                            </button>
                            <button class="run-btn" style="background: #2196F3;" onclick="exportGDELTDataCSV()">
                                üìÑ CSV ƒ∞ndir
                            </button>
                            <button class="run-btn" style="background: #9C27B0;" onclick="showGDELTLatexTable()">
                                üìù LaTeX Kodu
                            </button>
                        </div>
                        
                        <!-- LaTeX √ñnizleme -->
                        <div id="latex-table-preview" style="display: none; margin-top: 15px;">
                            <label style="font-weight: 600; color: #9C27B0; display: block; margin-bottom: 8px;">LaTeX Tablo Kodu:</label>
                            <textarea id="latex-table-code" readonly style="width: 100%; height: 200px; font-family: monospace; font-size: 0.85em; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f5f5f5;"></textarea>
                            <button onclick="copyLatexTable()" style="margin-top: 8px; padding: 8px 15px; cursor: pointer;">üìã Kopyala</button>
                        </div>
                    </div>
                    
                    <!-- IPTC MAPPING EXPORT -->
                    <div class="chart-container" style="border-left: 4px solid #FF9800;">
                        <h4 style="color: #FF9800; margin-bottom: 15px;">üéØ IPTC E≈üle≈ütirme Sonu√ßlarƒ±</h4>
                        
                        <!-- IPTC Mapping Export Se√ßenekleri -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: 600; color: #333; display: block; margin-bottom: 8px;">Export ƒ∞√ßeriƒüi:</label>
                            <div style="display: flex; flex-direction: column; gap: 8px; background: #f8f9fa; padding: 12px; border-radius: 5px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" id="export-iptc-themes" checked> Tema-IPTC E≈üle≈ütirmeleri
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" id="export-iptc-summary" checked> IPTC Kategori √ñzeti
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" id="export-iptc-similarity"> Benzerlik Matrisi
                                </label>
                            </div>
                        </div>
                        
                        <!-- Export Butonlarƒ± -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="run-btn" style="background: #FF9800;" onclick="exportIPTCMappingJSON()">
                                üìã JSON ƒ∞ndir
                            </button>
                            <button class="run-btn" style="background: #E91E63;" onclick="exportIPTCMappingCSV()">
                                üìÑ CSV ƒ∞ndir
                            </button>
                        </div>
                        
                        <!-- Grafik Export -->
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                            <h5 style="color: #FF9800; margin-bottom: 10px;">üìà Grafik Export</h5>
                            <div style="margin-bottom: 10px;">
                                <label style="font-weight: 600; color: #333; display: block; margin-bottom: 8px;">Grafik Se√ßin:</label>
                                <select id="export-chart-select" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em;">
                                    <option value="iptc-distribution-chart">üìä IPTC Kategori Daƒüƒ±lƒ±mƒ±</option>
                                    <option value="country-theme-chart">üåç √úlke Bazlƒ± Tema Hacmi</option>
                                    <option value="top-themes-chart">üìà En Y√ºksek Hacimli Temalar</option>
                                    <option value="iptc-similarity-chart">üéØ IPTC Benzerlik Skorlarƒ±</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="run-btn" style="background: #9C27B0;" onclick="exportChartPNG()">
                                    üñºÔ∏è PNG ƒ∞ndir
                                </button>
                                <button class="run-btn" style="background: #673AB7;" onclick="exportChartSVG()">
                                    üìê SVG ƒ∞ndir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- TOPLU EXPORT B√ñL√úM√ú -->
                <div class="chart-container" style="margin-top: 20px; border-left: 4px solid #0f3460;">
                    <h4 style="color: #0f3460; margin-bottom: 15px;">üì¶ Toplu Dƒ±≈üarƒ± Aktarma</h4>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">T√ºm GDELT tema verilerini ve IPTC e≈üle≈ütirmelerini tek seferde dƒ±≈üarƒ± aktarƒ±n.</p>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="run-btn" style="background: #0f3460;" onclick="exportAllGDELTData()">
                            üìä T√ºm Verileri ƒ∞ndir (XLSX)
                        </button>
                        <button class="run-btn" style="background: #00BCD4;" onclick="exportAllChartsPNG()">
                            üñºÔ∏è T√ºm Grafikleri ƒ∞ndir (PNG)
                        </button>
                        <button class="run-btn" style="background: #795548;" onclick="exportFullReport()">
                            üìë Tam Rapor (ZIP)
                        </button>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 5px;">
                        <p style="font-size: 0.85em; color: #666; margin: 0;">
                            <strong>üí° ƒ∞pucu:</strong> Toplu export, GDELT tema analizi ve IPTC e≈üle≈ütirme sonu√ßlarƒ±nƒ± i√ßerir. 
                            √ñnce GDELT Tema sekmesinden CSV y√ºkleyin ve K√ºmeleme sekmesinden IPTC e≈üle≈ütirmesini √ßalƒ±≈ütƒ±rƒ±n.
                        </p>
                    </div>
                </div>
            </div>
        </div>
                            üñºÔ∏è T√ºm Grafikleri ƒ∞ndir (PNG)
                        </button>
                        <button class="run-btn" style="background: #795548;" onclick="exportFullLatexReport()">
                            üìÑ Tam LaTeX Raporu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // GDELT-IPTC Dashboard global degiskenler
        let allData = [];
        let chartsInitialized = false;
        let chartInstances = [];
        
        // Eski fonksiyonlar icin stub'lar (runtime error onleme)
        function renderKaTeX() { }
        function updateInfoBox() { }
        
        // Durum mesaji goster
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
        }
        
        // TAB MANAGEMENT
        function switchTab(tabName) {
            // T√ºm tab button'larƒ± pasif yap
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            // T√ºm tab content'lerini gizle
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Se√ßilen tab button'ƒ±nƒ± aktif yap
            const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
            
            // Se√ßilen tab content'ini g√∂ster
            const tabContent = document.getElementById(`tab-${tabName}`);
            if (tabContent) {
                tabContent.classList.add('active');
                
                // Grafikler sekmesinde grafikleri render et
                if (tabName === 'charts' && allData.length > 0) {
                    setTimeout(() => {
                        renderCharts();
                    }, 300);
                }
                
                // Export sekmesinde bilgileri g√ºncelle
                if (tabName === 'export') {
                    updateExportInfo();
                }
            }
        }
        
        // Tab button event listeners
        function initTabButtons() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tabName = e.target.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }
        
        // ==================== KAYDETME / ƒ∞√áE AKTARMA FONKSƒ∞YONLARI ====================
        
        let lastClusteringResult = null;  // Son k√ºmeleme sonucunu sakla
        
        // GDELT durumunu topla
        function collectGDELTState() {
            return {
                timestamp: new Date().toISOString(),
                dataType: 'gdelt-iptc',
                parameters: {
                    min_docs_threshold: parseInt(document.getElementById('min-docs-threshold')?.value) || 1000,
                    quality_threshold: parseInt(document.getElementById('quality-threshold')?.value) || 50,
                    similarity_threshold: parseFloat(document.getElementById('similarity-threshold')?.value) || 0.30,
                    iptc_filter: document.getElementById('iptc-filter-param')?.value || 'all'
                },
                gdeltData: {
                    totalDocs: totalDocsData || [],
                    monthlyQuality: monthlyQualityData || [],
                    monthlyDetail: monthlyDetailData || []
                },
                iptcMapping: iptcMappingResults || null,
                summary: {
                    totalThemes: totalDocsData ? new Set(totalDocsData.map(d => d.theme_code)).size : 0,
                    totalCountries: totalDocsData ? new Set(totalDocsData.map(d => d.country)).size : 0,
                    totalDocs: totalDocsData ? totalDocsData.reduce((s, d) => s + (d.total_docs || 0), 0) : 0,
                    iptcCategories: iptcMappingResults ? new Set(iptcMappingResults.mappings?.map(m => m.iptc_category)).size : 0
                }
            };
        }
        
        // Eski GDP-Mutluluk durumu (geriye uyumluluk)
        function collectCurrentState() {
            return {
                timestamp: new Date().toISOString(),
                parameters: {
                    start_year: 2022,
                    end_year: 2024
                },
                results: allData,
                summary: {},
                clustering: lastClusteringResult,
                currentMethod: currentMethod,
                currentFilter: currentFilter,
                currentVariableMode: currentVariableMode
            };
        }
        
        // GDELT durumunu uygula
        function applyGDELTState(state) {
            if (!state) return;
            
            // Parametreleri uygula
            if (state.parameters) {
                const minDocsEl = document.getElementById('min-docs-threshold');
                const qualityEl = document.getElementById('quality-threshold');
                const similarityEl = document.getElementById('similarity-threshold');
                const iptcFilterEl = document.getElementById('iptc-filter-param');
                
                if (minDocsEl) minDocsEl.value = state.parameters.min_docs_threshold || 1000;
                if (qualityEl) qualityEl.value = state.parameters.quality_threshold || 50;
                if (similarityEl) similarityEl.value = state.parameters.similarity_threshold || 0.30;
                if (iptcFilterEl) iptcFilterEl.value = state.parameters.iptc_filter || 'all';
            }
            
            // GDELT verilerini uygula
            if (state.gdeltData) {
                if (state.gdeltData.totalDocs && state.gdeltData.totalDocs.length > 0) {
                    totalDocsData = state.gdeltData.totalDocs;
                    updateTotalDocsTable();
                }
                if (state.gdeltData.monthlyQuality && state.gdeltData.monthlyQuality.length > 0) {
                    monthlyQualityData = state.gdeltData.monthlyQuality;
                    updateMonthlyQualityTable();
                }
                if (state.gdeltData.monthlyDetail) {
                    monthlyDetailData = state.gdeltData.monthlyDetail;
                }
            }
            
            // IPTC e≈üle≈ütirme sonu√ßlarƒ±nƒ± uygula
            if (state.iptcMapping) {
                iptcMappingResults = state.iptcMapping;
                displayIPTCMappingResults(iptcMappingResults);
            }
            
            // √ñzet bilgilerini g√∂ster
            if (state.summary) {
                showStatus(`üìä Y√ºklendi: ${state.summary.totalThemes || 0} tema, ${state.summary.totalCountries || 0} √ºlke, ${(state.summary.totalDocs || 0).toLocaleString()} dok√ºman`, 'success');
            }
        }
        
        // Durumu uygula (geriye uyumluluk)
        function applyState(state) {
            if (!state) return;
            
            // GDELT formatƒ± mƒ± kontrol et
            if (state.dataType === 'gdelt-iptc') {
                applyGDELTState(state);
                return;
            }
            
            // Eski format - GDP/Mutluluk (geriye uyumluluk)
            if (state.results && state.results.length > 0) {
                allData = state.results;
            }
            
            // K√ºmeleme sonu√ßlarƒ±nƒ± uygula
            if (state.clustering) {
                lastClusteringResult = state.clustering;
            }
        }
        
        // GDELT Analizi Kaydet
        async function saveGDELTAnalysis() {
            if (!totalDocsData || totalDocsData.length === 0) {
                showStatus('‚ö†Ô∏è Kaydetmek i√ßin √∂nce GDELT verilerini y√ºkleyin!', 'error');
                return;
            }
            
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="loading-spinner"></span>Kaydediliyor...';
            
            try {
                const state = collectGDELTState();
                
                // JSON dosyasƒ± olarak indir (sunucu gerektirmez)
                const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `gdelt_iptc_analiz_${new Date().toISOString().slice(0,10)}.json`;
                link.click();
                
                showStatus('‚úÖ GDELT analizi JSON olarak indirildi!', 'success');
                
            } catch (error) {
                console.error('Kaydetme hatasƒ±:', error);
                showStatus(`‚ùå Kaydetme hatasƒ±: ${error.message}`, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'üíæ Kaydet';
            }
        }
        
        // Eski analizi kaydet (geriye uyumluluk)
        async function saveAnalysis() {
            saveGDELTAnalysis();
        }
        
        // ƒ∞√ße aktarma dialog'unu tetikle
        function triggerImport() {
            document.getElementById('import-file-input').click();
        }
        
        // GDELT dosyasƒ±nƒ± i√ße aktar
        async function handleGDELTImportFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const importBtn = document.getElementById('import-btn');
            importBtn.disabled = true;
            importBtn.innerHTML = '<span class="loading-spinner"></span>Y√ºkleniyor...';
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // Veri tipine g√∂re i≈üle
                if (data.dataType === 'gdelt-iptc') {
                    applyGDELTState(data);
                    showStatus(`‚úÖ GDELT analizi y√ºklendi: ${file.name}`, 'success');
                } else {
                    // Eski format
                    applyState(data);
                    showStatus(`‚úÖ Analiz dosyasƒ± y√ºklendi: ${file.name}`, 'success');
                }
                
            } catch (error) {
                console.error('ƒ∞√ße aktarma hatasƒ±:', error);
                showStatus(`‚ùå ƒ∞√ße aktarma hatasƒ±: ${error.message}`, 'error');
            } finally {
                importBtn.disabled = false;
                importBtn.innerHTML = 'üì• ƒ∞√ße Aktar';
                e.target.value = '';
            }
        }
        
        // Eski i√ße aktarma (geriye uyumluluk)
        async function handleImportFile(e) {
            handleGDELTImportFile(e);
        }
        
        // GDELT Filtreleri Uygula
        function applyGDELTFilters() {
            if (!totalDocsData || totalDocsData.length === 0) {
                showStatus('‚ö†Ô∏è √ñnce GDELT verilerini y√ºkleyin!', 'error');
                return;
            }
            
            const minDocs = parseInt(document.getElementById('min-docs-threshold').value) || 0;
            const minQuality = parseInt(document.getElementById('quality-threshold').value) || 0;
            const iptcFilter = document.getElementById('iptc-filter-param').value;
            
            // Filtrelenmi≈ü sayƒ±larƒ± hesapla
            let filteredDocs = totalDocsData.filter(item => (item.total_docs || 0) >= minDocs);
            
            if (iptcFilter !== 'all') {
                filteredDocs = filteredDocs.filter(item => {
                    const iptc = getIPTCCategory(item.theme_code);
                    return iptc && iptc.toLowerCase() === iptcFilter.toLowerCase();
                });
            }
            
            const totalFiltered = filteredDocs.length;
            const themeCount = new Set(filteredDocs.map(d => d.theme_code)).size;
            const countryCount = new Set(filteredDocs.map(d => d.country)).size;
            
            showStatus(`üîç Filtre uygulandƒ±: ${totalFiltered} kayƒ±t (${themeCount} tema, ${countryCount} √ºlke)`, 'success');
            
            // Tablolarƒ± g√ºncelle
            updateTotalDocsTable();
            updateMonthlyQualityTable();
        }
        
        // Filtreleri Sƒ±fƒ±rla
        function resetGDELTFilters() {
            document.getElementById('min-docs-threshold').value = 1000;
            document.getElementById('quality-threshold').value = 50;
            document.getElementById('similarity-threshold').value = 0.30;
            document.getElementById('iptc-filter-param').value = 'all';
            
            showStatus('üîÑ Filtreler sƒ±fƒ±rlandƒ±', 'info');
            
            // Tablolarƒ± g√ºncelle
            if (totalDocsData && totalDocsData.length > 0) {
                updateTotalDocsTable();
                updateMonthlyQualityTable();
            }
        }
        
        // Otomatik y√ºkleme (sayfa a√ßƒ±lƒ±≈üƒ±nda)
        async function autoLoadLastAnalysis() {
            // LocalStorage'dan son durumu y√ºkle
            try {
                const savedState = localStorage.getItem('gdelt_iptc_last_state');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    if (state.dataType === 'gdelt-iptc' && state.gdeltData) {
                        console.log('üìÇ LocalStorage\'dan son durum y√ºkleniyor...');
                        applyGDELTState(state);
                    }
                }
            } catch (error) {
                console.log('LocalStorage y√ºkleme hatasƒ±:', error.message);
            }
        }
        
        // ==================== KAYDETME / ƒ∞√áE AKTARMA FONKSƒ∞YONLARI SONU ====================
        
        // ==================== GDELT DI≈ûARI AKTARMA FONKSƒ∞YONLARI ====================
        
        // GDELT Veri Export - XLSX
        function exportGDELTDataXLSX() {
            if (!totalDocsData || totalDocsData.length === 0) {
                showStatus('‚ùå Dƒ±≈üarƒ± aktarƒ±lacak GDELT verisi yok! √ñnce CSV y√ºkleyin.', 'error');
                return;
            }
            
            const columns = getSelectedGDELTColumns();
            if (columns.length === 0) {
                showStatus('‚ùå En az bir s√ºtun se√ßmelisiniz!', 'error');
                return;
            }
            
            const iptcFilter = document.getElementById('export-iptc-filter').value;
            let filteredData = totalDocsData;
            
            if (iptcFilter !== 'all') {
                filteredData = totalDocsData.filter(item => {
                    const iptcCat = getIPTCCategory(item.theme_code);
                    return iptcCat && iptcCat.toLowerCase() === iptcFilter.toLowerCase();
                });
            }
            
            if (filteredData.length === 0) {
                showStatus('‚ùå Filtreye uyan veri yok!', 'error');
                return;
            }
            
            // Veriyi hazƒ±rla
            const exportData = filteredData.map(item => {
                const row = {};
                const iptcCat = getIPTCCategory(item.theme_code);
                
                columns.forEach(col => {
                    if (col === 'country') row['√úlke'] = item.country || '-';
                    else if (col === 'theme_code') row['Tema Kodu'] = item.theme_code || '-';
                    else if (col === 'total_docs') row['Toplam Dok√ºman'] = item.total_docs || 0;
                    else if (col === 'iptc_category') row['IPTC Kategorisi'] = iptcCat || '-';
                    else if (col === 'months_ok') row['Uygun Ay Sayƒ±sƒ±'] = item.months_ok || 0;
                    else if (col === 'months_total') row['Toplam Ay'] = item.months_total || 0;
                    else if (col === 'quality_ratio') {
                        const ratio = item.months_total > 0 ? (item.months_ok / item.months_total * 100).toFixed(1) : 0;
                        row['Kalite Oranƒ± (%)'] = ratio;
                    }
                    else if (col === 'median_docs') row['Median Dok√ºman'] = item.median_monthly_docs || 0;
                });
                return row;
            });
            
            // XLSX olu≈ütur
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'GDELT Tema Verileri');
            
            // ƒ∞ndir
            const filename = `gdelt_tema_verileri_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showStatus(`‚úÖ ${filteredData.length} satƒ±r GDELT verisi XLSX olarak indirildi!`, 'success');
        }
        
        // GDELT Veri Export - CSV
        function exportGDELTDataCSV() {
            if (!totalDocsData || totalDocsData.length === 0) {
                showStatus('‚ùå Dƒ±≈üarƒ± aktarƒ±lacak GDELT verisi yok! √ñnce CSV y√ºkleyin.', 'error');
                return;
            }
            
            const columns = getSelectedGDELTColumns();
            if (columns.length === 0) {
                showStatus('‚ùå En az bir s√ºtun se√ßmelisiniz!', 'error');
                return;
            }
            
            const iptcFilter = document.getElementById('export-iptc-filter').value;
            let filteredData = totalDocsData;
            
            if (iptcFilter !== 'all') {
                filteredData = totalDocsData.filter(item => {
                    const iptcCat = getIPTCCategory(item.theme_code);
                    return iptcCat && iptcCat.toLowerCase() === iptcFilter.toLowerCase();
                });
            }
            
            if (filteredData.length === 0) {
                showStatus('‚ùå Filtreye uyan veri yok!', 'error');
                return;
            }
            
            // Column headers
            const headers = {
                'country': '√úlke',
                'theme_code': 'Tema Kodu',
                'total_docs': 'Toplam Dok√ºman',
                'iptc_category': 'IPTC Kategorisi',
                'months_ok': 'Uygun Ay Sayƒ±sƒ±',
                'months_total': 'Toplam Ay',
                'quality_ratio': 'Kalite Oranƒ± (%)',
                'median_docs': 'Median Dok√ºman'
            };
            
            let csv = columns.map(col => headers[col] || col).join(',') + '\n';
            
            filteredData.forEach(item => {
                const iptcCat = getIPTCCategory(item.theme_code);
                const row = columns.map(col => {
                    if (col === 'country') return `"${item.country || ''}"`;
                    if (col === 'theme_code') return item.theme_code || '';
                    if (col === 'total_docs') return item.total_docs || 0;
                    if (col === 'iptc_category') return `"${iptcCat || ''}"`;
                    if (col === 'months_ok') return item.months_ok || 0;
                    if (col === 'months_total') return item.months_total || 0;
                    if (col === 'quality_ratio') {
                        return item.months_total > 0 ? (item.months_ok / item.months_total * 100).toFixed(1) : 0;
                    }
                    if (col === 'median_docs') return item.median_monthly_docs || 0;
                    return '';
                }).join(',');
                csv += row + '\n';
            });
            
            // ƒ∞ndir
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `gdelt_tema_verileri_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            showStatus(`‚úÖ ${filteredData.length} satƒ±r GDELT verisi CSV olarak indirildi!`, 'success');
        }
        
        // GDELT LaTeX Tablosu
        function showGDELTLatexTable() {
            if (!totalDocsData || totalDocsData.length === 0) {
                showStatus('‚ùå GDELT verisi yok! √ñnce CSV y√ºkleyin.', 'error');
                return;
            }
            
            const columns = getSelectedGDELTColumns();
            
            // IPTC kategorilerine g√∂re grupla
            const iptcGroups = {};
            totalDocsData.forEach(item => {
                const iptcCat = getIPTCCategory(item.theme_code);
                if (iptcCat) {
                    if (!iptcGroups[iptcCat]) iptcGroups[iptcCat] = [];
                    iptcGroups[iptcCat].push(item);
                }
            });
            
            // Top 15 IPTC grupla
            const sortedIPTC = Object.entries(iptcGroups)
                .map(([cat, items]) => ({
                    category: cat,
                    totalDocs: items.reduce((sum, i) => sum + (i.total_docs || 0), 0),
                    themeCount: new Set(items.map(i => i.theme_code)).size
                }))
                .sort((a, b) => b.totalDocs - a.totalDocs)
                .slice(0, 10);
            
            let latex = '\\begin{table}[htbp]\n';
            latex += '\\centering\n';
            latex += '\\caption{GDELT Tema - IPTC Media Topics E≈üle≈ütirme √ñzeti}\n';
            latex += '\\label{tab:gdelt-iptc}\n';
            latex += '\\begin{tabular}{lrr}\n';
            latex += '\\toprule\n';
            latex += 'IPTC Kategori & Tema Sayƒ±sƒ± & Toplam Dok√ºman \\\\\n';
            latex += '\\midrule\n';
            
            sortedIPTC.forEach(item => {
                const catName = item.category.replace(/&/g, '\\&').replace(/_/g, '\\_');
                latex += `${catName} & ${item.themeCount} & ${item.totalDocs.toLocaleString()} \\\\\n`;
            });
            
            latex += '\\bottomrule\n';
            latex += '\\end{tabular}\n';
            latex += '\\end{table}\n';
            
            document.getElementById('latex-table-code').value = latex;
            document.getElementById('latex-table-preview').style.display = 'block';
            
            showStatus('‚úÖ LaTeX tablo kodu olu≈üturuldu!', 'success');
        }
        
        // Se√ßili GDELT s√ºtunlarƒ±nƒ± al
        function getSelectedGDELTColumns() {
            const checkboxes = document.querySelectorAll('.export-col-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        // IPTC Mapping JSON Export
        function exportIPTCMappingJSON() {
            if (!iptcMappingResults) {
                showStatus('‚ùå IPTC e≈üle≈ütirme sonucu yok! √ñnce K√ºmeleme sekmesinden IPTC e≈üle≈ütirmesini √ßalƒ±≈ütƒ±rƒ±n.', 'error');
                return;
            }
            
            const includeThemes = document.getElementById('export-iptc-themes').checked;
            const includeSummary = document.getElementById('export-iptc-summary').checked;
            
            const exportData = {};
            
            if (includeThemes && iptcMappingResults.mappings) {
                exportData.mappings = iptcMappingResults.mappings;
            }
            
            if (includeSummary) {
                // IPTC √∂zeti olu≈ütur
                const summary = {};
                if (iptcMappingResults.mappings) {
                    iptcMappingResults.mappings.forEach(m => {
                        const cat = m.iptc_category;
                        if (!summary[cat]) {
                            summary[cat] = { count: 0, themes: [], avgSimilarity: 0 };
                        }
                        summary[cat].count++;
                        summary[cat].themes.push(m.theme_code);
                        summary[cat].avgSimilarity += m.similarity;
                    });
                    
                    Object.keys(summary).forEach(cat => {
                        summary[cat].avgSimilarity /= summary[cat].count;
                        summary[cat].avgSimilarity = summary[cat].avgSimilarity.toFixed(4);
                    });
                }
                exportData.summary = summary;
            }
            
            exportData.exportDate = new Date().toISOString();
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `iptc_mapping_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            
            showStatus('‚úÖ IPTC e≈üle≈ütirme JSON olarak indirildi!', 'success');
        }
        
        // IPTC Mapping CSV Export
        function exportIPTCMappingCSV() {
            if (!iptcMappingResults || !iptcMappingResults.mappings) {
                showStatus('‚ùå IPTC e≈üle≈ütirme sonucu yok! √ñnce K√ºmeleme sekmesinden IPTC e≈üle≈ütirmesini √ßalƒ±≈ütƒ±rƒ±n.', 'error');
                return;
            }
            
            let csv = 'theme_code,theme_label,iptc_category,similarity\n';
            
            iptcMappingResults.mappings.forEach(m => {
                csv += `"${m.theme_code}","${m.theme_label || ''}","${m.iptc_category}",${m.similarity}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `iptc_mapping_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            showStatus('‚úÖ IPTC e≈üle≈ütirme CSV olarak indirildi!', 'success');
        }
        
        // T√ºm GDELT Verilerini Export
        function exportAllGDELTData() {
            if (!totalDocsData || totalDocsData.length === 0) {
                showStatus('‚ùå Dƒ±≈üarƒ± aktarƒ±lacak veri yok! √ñnce CSV y√ºkleyin.', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Total Docs
            const totalDocsExport = totalDocsData.map(item => ({
                '√úlke': item.country,
                'Tema Kodu': item.theme_code,
                'IPTC Kategorisi': getIPTCCategory(item.theme_code) || '-',
                'Toplam Dok√ºman': item.total_docs
            }));
            const ws1 = XLSX.utils.json_to_sheet(totalDocsExport);
            XLSX.utils.book_append_sheet(wb, ws1, 'Tema Toplam');
            
            // Sheet 2: Monthly Quality (if exists)
            if (monthlyQualityData && monthlyQualityData.length > 0) {
                const qualityExport = monthlyQualityData.map(item => ({
                    '√úlke': item.country,
                    'Tema Kodu': item.theme_code,
                    'IPTC Kategorisi': getIPTCCategory(item.theme_code) || '-',
                    'Uygun Ay': item.months_ok,
                    'Toplam Ay': item.months_total,
                    'Oran (%)': item.months_total > 0 ? (item.months_ok / item.months_total * 100).toFixed(1) : 0
                }));
                const ws2 = XLSX.utils.json_to_sheet(qualityExport);
                XLSX.utils.book_append_sheet(wb, ws2, 'Aylƒ±k Kalite');
            }
            
            // Sheet 3: IPTC Summary
            const iptcSummary = {};
            totalDocsData.forEach(item => {
                const iptc = getIPTCCategory(item.theme_code);
                if (iptc) {
                    if (!iptcSummary[iptc]) {
                        iptcSummary[iptc] = { totalDocs: 0, themeCount: new Set(), countryCount: new Set() };
                    }
                    iptcSummary[iptc].totalDocs += item.total_docs || 0;
                    iptcSummary[iptc].themeCount.add(item.theme_code);
                    iptcSummary[iptc].countryCount.add(item.country);
                }
            });
            
            const iptcExport = Object.entries(iptcSummary).map(([cat, data]) => ({
                'IPTC Kategori': cat,
                'Toplam Dok√ºman': data.totalDocs,
                'Tema Sayƒ±sƒ±': data.themeCount.size,
                '√úlke Sayƒ±sƒ±': data.countryCount.size
            })).sort((a, b) => b['Toplam Dok√ºman'] - a['Toplam Dok√ºman']);
            
            const ws3 = XLSX.utils.json_to_sheet(iptcExport);
            XLSX.utils.book_append_sheet(wb, ws3, 'IPTC √ñzet');
            
            // ƒ∞ndir
            const filename = `gdelt_iptc_tam_veri_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showStatus('‚úÖ T√ºm GDELT verileri √ßoklu sayfa XLSX olarak indirildi!', 'success');
        }
        
        // Tam Rapor (ZIP)
        async function exportFullReport() {
            showStatus('üì¶ Tam rapor hazƒ±rlanƒ±yor...', 'info');
            
            // JSZip kontrol√º
            if (typeof JSZip === 'undefined') {
                showStatus('‚ö†Ô∏è ZIP desteƒüi i√ßin JSZip k√ºt√ºphanesi gerekli. Tek tek dosyalarƒ± indirin.', 'error');
                return;
            }
            
            const zip = new JSZip();
            
            // CSV Verileri
            if (totalDocsData && totalDocsData.length > 0) {
                let csv = 'country,theme_code,iptc_category,total_docs\n';
                totalDocsData.forEach(item => {
                    csv += `"${item.country}","${item.theme_code}","${getIPTCCategory(item.theme_code) || ''}",${item.total_docs}\n`;
                });
                zip.file('gdelt_tema_verileri.csv', csv);
            }
            
            // IPTC Mapping JSON
            if (iptcMappingResults) {
                zip.file('iptc_mapping.json', JSON.stringify(iptcMappingResults, null, 2));
            }
            
            // README
            const readme = `# GDELT & IPTC Media Topics Raporu
Olu≈üturulma Tarihi: ${new Date().toLocaleString('tr-TR')}

## Dosyalar
- gdelt_tema_verileri.csv: GDELT tema verileri
- iptc_mapping.json: IPTC e≈üle≈ütirme sonu√ßlarƒ±

## IPTC Kategorileri
${Object.keys(IPTC_CATEGORIES).map(c => `- ${c}`).join('\n')}
`;
            zip.file('README.md', readme);
            
            // ZIP olu≈ütur ve indir
            const blob = await zip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `gdelt_iptc_rapor_${new Date().toISOString().slice(0,10)}.zip`;
            link.click();
            
            showStatus('‚úÖ Tam rapor ZIP olarak indirildi!', 'success');
        }
        
        // ==================== DI≈ûARI AKTARMA FONKSƒ∞YONLARI SONU ====================
        
        // ==================== GDELT TEMA K√úMELEMESƒ∞ FONKSƒ∞YONLARI ====================
        
        let iptcMappingResults = null;
        
        // IPTC e≈üle≈ütirmesini √ßalƒ±≈ütƒ±r
        async function runIPTCMapping() {
            const btn = document.getElementById('iptc-mapping-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>E≈üle≈ütiriliyor...';
            
            // Progress container'ƒ± g√∂ster
            showIPTCProgress();
            showIPTCMappingStatus('üöÄ Python script √ßalƒ±≈ütƒ±rƒ±lƒ±yor...', 'info');
            
            try {
                // Adƒ±m 1: Ba≈ülatma
                updateIPTCProgressStep(1, 'active');
                
                // Python script'i √ßalƒ±≈ütƒ±r API √ºzerinden
                const response = await fetch('/api/run-iptc-mapping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    // Fallback: mevcut JSON dosyasƒ±nƒ± y√ºkle
                    hideIPTCProgress();
                    showIPTCMappingStatus('‚ö†Ô∏è API kullanƒ±lamƒ±yor. Terminalde ≈üu komutu √ßalƒ±≈ütƒ±rƒ±n: python gdelt_iptc_mapping.py', 'info');
                    loadIPTCMappingResults();
                    return;
                }
                
                // T√ºm adƒ±mlarƒ± tamamlandƒ± olarak i≈üaretle (API tek seferde √ßalƒ±≈üƒ±yor)
                for (let i = 1; i <= 5; i++) {
                    updateIPTCProgressStep(i, 'completed');
                }
                
                const data = await response.json();
                iptcMappingResults = data;
                
                // Progress container'ƒ± gizle
                setTimeout(() => hideIPTCProgress(), 1000);
                
                // Sonu√ßlarƒ± g√∂ster
                displayIPTCMappingResults(data);
                
                showIPTCMappingStatus(
                    `‚úÖ IPTC e≈üle≈ütirme tamamlandƒ±! ${data.metadata.total_themes} tema ‚Üí ${data.metadata.iptc_categories} IPTC kategorisi`,
                    'success'
                );
            } catch (error) {
                console.log('Fallback: loading from file...');
                hideIPTCProgress();
                loadIPTCMappingResults();
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ IPTC E≈üle≈ütirme √áalƒ±≈ütƒ±r';
            }
        }
        
        // IPTC sonu√ßlarƒ±nƒ± dosyadan y√ºkle
        async function loadIPTCMappingResults() {
            try {
                const response = await fetch('gdelt_iptc_mapping.json');
                if (!response.ok) throw new Error('File not found');
                const data = await response.json();
                iptcMappingResults = data;
                displayIPTCMappingResults(data);
                showIPTCMappingStatus('‚úÖ IPTC e≈üle≈ütirme sonu√ßlarƒ± y√ºklendi', 'success');
            } catch (error) {
                showIPTCMappingStatus(
                    '‚ùå Sonu√ßlar y√ºklenemedi. √ñnce terminalde √ßalƒ±≈ütƒ±rƒ±n: python gdelt_iptc_mapping.py',
                    'error'
                );
            }
        }
        
        // IPTC e≈üle≈ütirme sonu√ßlarƒ±nƒ± g√∂ster
        function displayIPTCMappingResults(results) {
            if (!results || !results.iptc_categories) {
                showIPTCMappingStatus('‚ùå Ge√ßersiz veri formatƒ±', 'error');
                return;
            }
            
            // IPTC kategorileri i√ßin renk haritasƒ± (17 kategori)
            const iptcColors = {
                'arts, culture, entertainment and media': '#E91E63',
                'crime, law and justice': '#9C27B0',
                'disaster, accident and emergency incident': '#F44336',
                'economy, business and finance': '#FF9800',
                'education': '#3F51B5',
                'environment': '#4CAF50',
                'health': '#00BCD4',
                'human interest': '#FF5722',
                'labour': '#795548',
                'lifestyle and leisure': '#E91E63',
                'politics and government': '#2196F3',
                'religion': '#673AB7',
                'science and technology': '#009688',
                'society': '#607D8B',
                'sport': '#8BC34A',
                'conflict, war and peace': '#F44336',
                'weather': '#03A9F4'
            };
            
            // IPTC kategori kartlarƒ±nƒ± olu≈ütur
            const grid = document.getElementById('iptc-categories-grid');
            grid.innerHTML = '';
            
            // Kategorileri tema sayƒ±sƒ±na g√∂re sƒ±rala
            const sortedCategories = Object.entries(results.iptc_categories)
                .sort((a, b) => b[1].theme_count - a[1].theme_count);
            
            // Her kategori i√ßin ortalama benzerliƒüi hesapla (themes verisinden)
            const themesByCategory = {};
            if (results.themes) {
                results.themes.forEach(t => {
                    const cat = t.iptc_final_label || t.iptc_label;
                    if (cat) {
                        if (!themesByCategory[cat]) themesByCategory[cat] = [];
                        themesByCategory[cat].push(t.nn_score || t.similarity || 0);
                    }
                });
            }
            
            for (const [categoryLabel, info] of sortedCategories) {
                const color = iptcColors[categoryLabel] || '#667eea';
                
                const card = document.createElement('div');
                card.style.cssText = `
                    background: white;
                    border-left: 5px solid ${color};
                    padding: 15px;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    text-align: left;
                `;
                
                const themesList = info.themes.slice(0, 4).map(t => 
                    `<span style="background: ${color}15; color: ${color}; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 500;">${t}</span>`
                ).join('');
                
                // Ortalama benzerlik hesapla
                const catScores = themesByCategory[categoryLabel] || [];
                const avgSim = catScores.length > 0 
                    ? ((catScores.reduce((a, b) => a + b, 0) / catScores.length) * 100).toFixed(1) 
                    : (info.avg_similarity ? (info.avg_similarity * 100).toFixed(1) : '-');
                
                card.innerHTML = `
                    <h4 style="color: ${color}; margin: 0 0 8px 0; font-size: 1em; text-transform: capitalize;">
                        ${categoryLabel}
                    </h4>
                    <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                        <span style="background: ${color}20; color: ${color}; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">
                            ${info.theme_count} tema
                        </span>
                        <span style="background: #e3f2fd; color: #2196F3; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">
                            %${avgSim} benzerlik
                        </span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px;">
                        ${themesList}
                        ${info.themes.length > 4 ? `<span style="color: #999; font-size: 0.8em;">+${info.themes.length - 4} daha</span>` : ''}
                    </div>
                `;
                
                grid.appendChild(card);
            }
            
            // Temalarƒ± tabloya ekle
            displayIPTCThemesTable(results.themes);
        }
        
        // T√ºm temalarƒ± IPTC tablosuyla g√∂ster
        function displayIPTCThemesTable(themes) {
            const tbody = document.getElementById('iptc-themes-tbody');
            tbody.innerHTML = '';
            
            // Benzerlik skoruna g√∂re sƒ±rala (y√ºksekten d√º≈ü√ºƒüe)
            const sortedThemes = [...themes].sort((a, b) => (b.nn_score || b.similarity || 0) - (a.nn_score || a.similarity || 0));
            
            sortedThemes.forEach(theme => {
                // V2 formatƒ± i√ßin alan e≈üle≈ütirmesi
                const iptcLabel = theme.iptc_final_label || theme.iptc_label || '-';
                const similarityVal = theme.nn_score || theme.similarity || 0;
                const similarity = similarityVal ? (similarityVal * 100).toFixed(1) : '-';
                const confidenceVal = theme.final_confidence || theme.confidence || 0;
                const confidence = confidenceVal ? (confidenceVal * 100).toFixed(1) : '-';
                const secondLabel = theme.iptc_second_label || theme.iptc_label_2nd || '-';
                const decisionSource = theme.decision_source || '';
                
                // G√ºven skoru rengini belirle
                let confidenceColor = '#4CAF50'; // ye≈üil (y√ºksek g√ºven)
                if (confidenceVal < 0.3) confidenceColor = '#F44336'; // kƒ±rmƒ±zƒ± (d√º≈ü√ºk g√ºven)
                else if (confidenceVal < 0.5) confidenceColor = '#FF9800'; // turuncu (orta g√ºven)
                
                // Decision source badge
                let sourceBadge = '';
                if (decisionSource === 'agreement') {
                    sourceBadge = '<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7em; margin-left: 5px;">‚úì Uyum</span>';
                } else if (decisionSource === 'rule_preferred') {
                    sourceBadge = '<span style="background: #2196F3; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7em; margin-left: 5px;">Kural</span>';
                } else if (decisionSource.startsWith('nn_')) {
                    sourceBadge = '<span style="background: #9C27B0; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7em; margin-left: 5px;">NN</span>';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 8px; border-bottom: 1px solid #eee; font-family: monospace; font-weight: 600; font-size: 0.9em;">${theme.theme_code}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-transform: capitalize;">
                        <span style="background: #e8f5e9; color: #4CAF50; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">
                            ${iptcLabel}
                        </span>
                        ${sourceBadge}
                    </td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">
                        <span style="background: #e3f2fd; color: #2196F3; padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                            %${similarity}
                        </span>
                    </td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">
                        <span style="background: ${confidenceColor}20; color: ${confidenceColor}; padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                            %${confidence}
                        </span>
                    </td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; color: #999; font-size: 0.85em; text-transform: capitalize;">
                        ${secondLabel}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Progress container'ƒ± g√∂ster
        function showIPTCProgress() {
            const container = document.getElementById('iptc-progress-container');
            if (container) {
                container.style.display = 'block';
                // T√ºm adƒ±mlarƒ± sƒ±fƒ±rla
                document.querySelectorAll('.progress-step').forEach(step => {
                    step.style.color = '#666';
                    const icon = step.querySelector('.step-icon');
                    if (icon) {
                        icon.style.background = '#6b7280';
                        icon.textContent = step.dataset.step;
                    }
                });
                // Progress bar sƒ±fƒ±rla
                const bar = document.getElementById('iptc-progress-bar');
                if (bar) bar.style.width = '0%';
            }
        }
        
        // Progress container'ƒ± gizle
        function hideIPTCProgress() {
            const container = document.getElementById('iptc-progress-container');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        // Progress adƒ±mƒ±nƒ± g√ºncelle
        function updateIPTCProgressStep(stepNumber, status = 'active') {
            const step = document.querySelector(`.progress-step[data-step="${stepNumber}"]`);
            if (!step) return;
            
            const icon = step.querySelector('.step-icon');
            const progressBar = document.getElementById('iptc-progress-bar');
            const progressText = document.getElementById('iptc-progress-text');
            
            if (status === 'active') {
                step.style.color = '#667eea';
                step.style.fontWeight = '600';
                if (icon) {
                    icon.style.background = '#667eea';
                    icon.innerHTML = '<span class="loading-spinner" style="width: 14px; height: 14px; border-width: 2px;"></span>';
                }
                // Progress text g√ºncelle
                const stepText = step.querySelector('.step-text');
                if (progressText && stepText) {
                    progressText.textContent = stepText.textContent;
                }
            } else if (status === 'completed') {
                step.style.color = '#10b981';
                step.style.fontWeight = '500';
                if (icon) {
                    icon.style.background = '#10b981';
                    icon.textContent = '‚úì';
                }
            } else if (status === 'error') {
                step.style.color = '#ef4444';
                if (icon) {
                    icon.style.background = '#ef4444';
                    icon.textContent = '‚úó';
                }
            }
            
            // Progress bar g√ºncelle (5 adƒ±m)
            if (progressBar && status === 'completed') {
                progressBar.style.width = `${(stepNumber / 5) * 100}%`;
            }
        }
        
        // IPTC Status mesajƒ± g√∂ster
        function showIPTCMappingStatus(message, type = 'info') {
            const el = document.getElementById('iptc-mapping-status');
            el.textContent = message;
            el.className = `status-message ${type}`;
            el.style.display = 'block';
        }
        
        // ==================== GDELT CHARTS FONKSƒ∞YONLARI ====================
        
        let gdeltChartInstances = [];
        
        // GDELT & IPTC Grafikleri Olu≈ütur
        function generateGDELTCharts() {
            if (!totalDocsData || totalDocsData.length === 0) {
                showStatus('‚ùå Grafik olu≈üturmak i√ßin √∂nce GDELT CSV verilerini y√ºkleyin!', 'error');
                return;
            }
            
            // Mevcut chart'larƒ± temizle
            gdeltChartInstances.forEach(chart => {
                if (chart) chart.destroy();
            });
            gdeltChartInstances = [];
            
            showStatus('üìä GDELT grafikleri olu≈üturuluyor...', 'info');
            
            // 1. IPTC Kategori Daƒüƒ±lƒ±mƒ±
            createIPTCDistributionChart();
            
            // 2. √úlke Bazlƒ± Tema Hacmi
            createCountryThemeChart();
            
            // 3. En Y√ºksek Hacimli Temalar
            createTopThemesChart();
            
            // 4. IPTC Benzerlik Skorlarƒ±
            createIPTCSimilarityChart();
            
            showStatus('‚úÖ GDELT grafikleri olu≈üturuldu!', 'success');
        }
        
        // IPTC Kategori Daƒüƒ±lƒ±mƒ± (Bar Chart)
        function createIPTCDistributionChart() {
            const canvas = document.getElementById('iptc-distribution-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // IPTC kategorilerine g√∂re toplam dok√ºman hesapla
            const iptcTotals = {};
            totalDocsData.forEach(item => {
                const iptc = getIPTCCategory(item.theme_code);
                if (iptc) {
                    iptcTotals[iptc] = (iptcTotals[iptc] || 0) + (item.total_docs || 0);
                }
            });
            
            // Sƒ±rala ve en y√ºksek 10'u al
            const sorted = Object.entries(iptcTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const labels = sorted.map(([cat]) => cat.split(',')[0].trim()); // Kƒ±sa isim
            const data = sorted.map(([, val]) => val);
            const colors = sorted.map(([cat]) => iptcColors[cat] || '#999');
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Toplam Dok√ºman Sayƒ±sƒ±',
                        data: data,
                        backgroundColor: colors.map(c => c + 'CC'),
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'IPTC Kategori Bazlƒ± Dok√ºman Daƒüƒ±lƒ±mƒ±',
                            font: { size: 16 }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Dok√ºman Sayƒ±sƒ±' } },
                        x: { 
                            ticks: { maxRotation: 45, minRotation: 45 },
                            title: { display: true, text: 'IPTC Kategorisi' }
                        }
                    }
                }
            });
            gdeltChartInstances.push(chart);
        }
        
        // √úlke Bazlƒ± Tema Hacmi (Grouped Bar)
        function createCountryThemeChart() {
            const canvas = document.getElementById('country-theme-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // √úlkelere g√∂re grupla
            const countryTotals = {};
            totalDocsData.forEach(item => {
                const country = item.country || 'Unknown';
                countryTotals[country] = (countryTotals[country] || 0) + (item.total_docs || 0);
            });
            
            // En y√ºksek 15 √ºlkeyi al
            const sorted = Object.entries(countryTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);
            
            const labels = sorted.map(([country]) => country);
            const data = sorted.map(([, val]) => val);
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Toplam Dok√ºman',
                        data: data,
                        backgroundColor: 'rgba(33, 150, 243, 0.7)',
                        borderColor: 'rgba(33, 150, 243, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'En Y√ºksek Tema Hacimli 15 √úlke',
                            font: { size: 16 }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: 'Toplam Dok√ºman' } },
                        y: { title: { display: true, text: '√úlke' } }
                    }
                }
            });
            gdeltChartInstances.push(chart);
        }
        
        // En Y√ºksek Hacimli Temalar (Horizontal Bar)
        function createTopThemesChart() {
            const canvas = document.getElementById('top-themes-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Temalara g√∂re grupla
            const themeTotals = {};
            totalDocsData.forEach(item => {
                const theme = item.theme_code || 'Unknown';
                themeTotals[theme] = (themeTotals[theme] || 0) + (item.total_docs || 0);
            });
            
            // En y√ºksek 15 temayƒ± al
            const sorted = Object.entries(themeTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);
            
            const labels = sorted.map(([theme]) => theme);
            const data = sorted.map(([, val]) => val);
            
            // Her tema i√ßin IPTC rengini bul
            const colors = labels.map(theme => {
                const iptc = getIPTCCategory(theme);
                return iptc ? (iptcColors[iptc] || '#666') : '#999';
            });
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Toplam Dok√ºman',
                        data: data,
                        backgroundColor: colors.map(c => c + 'BB'),
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'En Y√ºksek Hacimli 15 GDELT Tema',
                            font: { size: 16 }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: 'Toplam Dok√ºman' } },
                        y: { title: { display: true, text: 'GDELT Tema Kodu' } }
                    }
                }
            });
            gdeltChartInstances.push(chart);
        }
        
        // IPTC Benzerlik Skorlarƒ± (Radar veya Bar)
        function createIPTCSimilarityChart() {
            const canvas = document.getElementById('iptc-similarity-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // IPTC e≈üle≈ütirme sonu√ßlarƒ±ndan benzerlik skorlarƒ±nƒ± al
            let similarities = [];
            
            if (iptcMappingResults && iptcMappingResults.mappings) {
                // E≈üle≈ütirme varsa benzerlik skorlarƒ±nƒ± kullan
                const iptcAvg = {};
                iptcMappingResults.mappings.forEach(m => {
                    const cat = m.iptc_category;
                    if (!iptcAvg[cat]) iptcAvg[cat] = { sum: 0, count: 0 };
                    iptcAvg[cat].sum += m.similarity;
                    iptcAvg[cat].count++;
                });
                
                similarities = Object.entries(iptcAvg)
                    .map(([cat, data]) => ({
                        category: cat,
                        similarity: data.sum / data.count
                    }))
                    .sort((a, b) => b.similarity - a.similarity);
            } else {
                // E≈üle≈ütirme yoksa tema sayƒ±sƒ±na g√∂re g√∂ster
                const iptcCounts = {};
                totalDocsData.forEach(item => {
                    const iptc = getIPTCCategory(item.theme_code);
                    if (iptc) {
                        if (!iptcCounts[iptc]) iptcCounts[iptc] = new Set();
                        iptcCounts[iptc].add(item.theme_code);
                    }
                });
                
                similarities = Object.entries(iptcCounts)
                    .map(([cat, themes]) => ({
                        category: cat,
                        similarity: themes.size // Tema sayƒ±sƒ± olarak
                    }))
                    .sort((a, b) => b.similarity - a.similarity);
            }
            
            if (similarities.length === 0) {
                return;
            }
            
            const labels = similarities.slice(0, 10).map(s => s.category.split(',')[0].trim());
            const data = similarities.slice(0, 10).map(s => 
                iptcMappingResults ? (s.similarity * 100).toFixed(1) : s.similarity
            );
            const colors = similarities.slice(0, 10).map(s => iptcColors[s.category] || '#999');
            
            const chartTitle = iptcMappingResults 
                ? 'IPTC Kategorileri - Ortalama Benzerlik Skoru (%)'
                : 'IPTC Kategorileri - E≈üle≈üen Tema Sayƒ±sƒ±';
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: iptcMappingResults ? 'Benzerlik (%)' : 'Tema Sayƒ±sƒ±',
                        data: data,
                        backgroundColor: colors.map(c => c + 'AA'),
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: chartTitle,
                            font: { size: 16 }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: iptcMappingResults ? 'Benzerlik (%)' : 'Tema Sayƒ±sƒ±' },
                            max: iptcMappingResults ? 100 : undefined
                        },
                        x: { 
                            ticks: { maxRotation: 45, minRotation: 45 },
                            title: { display: true, text: 'IPTC Kategorisi' }
                        }
                    }
                }
            });
            gdeltChartInstances.push(chart);
        }
        
        // ==================== IPTC MAPPING FONKSƒ∞YONLARI SONU ====================
        
        // ==================== GDELT TEMA ANALƒ∞Zƒ∞ FONKSƒ∞YONLARI ====================
        
        let gdeltTotalDocs = [];      // bquxjob_645c6baa... (country, theme_code, total_docs)
        let gdeltMonthlyQuality = []; // bquxjob_4750d984... (country, theme_code, months_total, months_ok, median_docs)
        let gdeltMonthlyDetail = [];  // bquxjob_5c135702... (ym, country, theme_code, n_docs)
        let gdeltDataLoaded = false;
        
        // IPTC Media Topics - Resmi 17 √úst D√ºzey Kategori
        const IPTC_CATEGORIES = {
            'arts, culture, entertainment and media': ['MEDIA', 'CULTURE'],
            'conflict, war and peace': ['CRISISLEX', 'ARMEDCONFLICT', 'KILL', 'TERROR', 'SECURITY', 'MILITARY'],
            'crime, law and justice': ['CRIME', 'JUSTICE', 'LAW'],
            'disaster, accident and emergency incident': ['MANMADE', 'DISASTER', 'NATURAL'],
            'economy, business and finance': ['ECON', 'EPU', 'EPU_ECONOMY', 'TAX', 'AGRICULTURE'],
            'education': ['EDUCATION'],
            'environment': ['ENV', 'CLIMATE'],
            'health': ['HEALTH', 'MEDICAL', 'GENERAL_HEALTH'],
            'human interest': ['AFFECT', 'GENERAL'],
            'labour': ['LABOR', 'EMPLOYMENT', 'WORKFORCE'],
            'lifestyle and leisure': ['TOURISM', 'TRAVEL', 'LEISURE'],
            'politics and government': ['LEADER', 'ELECTION', 'DEMOCRACY', 'LEGISLATION', 'GOVERNMENT', 'GENERAL_GOVERNMENT', 'GOV', 'UNGP'],
            'religion': ['RELIGION'],
            'science and technology': ['SCIENCE', 'TECHNOLOGY', 'RESEARCH'],
            'society': ['SOC', 'SOCIAL', 'COMMUNITY'],
            'sport': ['SPORT', 'SPORTS'],
            'weather': ['WEATHER', 'CLIMATE_WEATHER']
        };
        
        // T√ºm kullanƒ±labilir GDELT temalarƒ±
        const USABLE_CATEGORIES = [
            // economy, business and finance
            'ECON', 'EPU', 'EPU_ECONOMY', 'TAX', 'AGRICULTURE',
            // conflict, war and peace
            'CRISISLEX', 'ARMEDCONFLICT', 'KILL', 'TERROR', 'SECURITY', 'MILITARY',
            // politics and government
            'LEADER', 'ELECTION', 'DEMOCRACY', 'LEGISLATION', 'GOVERNMENT', 'GENERAL_GOVERNMENT', 'GOV', 'UNGP',
            // health
            'HEALTH', 'MEDICAL', 'GENERAL_HEALTH',
            // education
            'EDUCATION',
            // lifestyle and leisure
            'TOURISM', 'TRAVEL', 'LEISURE',
            // disaster, accident
            'MANMADE', 'DISASTER', 'NATURAL',
            // environment
            'ENV', 'CLIMATE',
            // arts, culture, entertainment
            'MEDIA', 'CULTURE',
            // society
            'SOC', 'SOCIAL',
            // human interest
            'AFFECT', 'GENERAL',
            // religion
            'RELIGION',
            // science and technology
            'SCIENCE', 'TECHNOLOGY'
        ];
        
        const METADATA_PREFIXES = ['TAX_', 'WB_', 'USPEC_', 'UNGP_', 'SOC_', 'SLFID_'];
        
        // Tema i√ßin IPTC kategorisi bul
        function getIPTCCategory(themeCode) {
            for (const [iptcLabel, themes] of Object.entries(IPTC_CATEGORIES)) {
                if (themes.includes(themeCode)) {
                    return iptcLabel;
                }
            }
            return null;
        }
        
        // Tema tipini belirle (IPTC kategorili veya metadata)
        function getThemeType(themeCode) {
            // Metadata kontrol√º (prefix ile ba≈ülayanlar)
            for (const prefix of METADATA_PREFIXES) {
                if (themeCode.startsWith(prefix)) {
                    return 'metadata';
                }
            }
            // IPTC kategorisinde mi?
            const iptc = getIPTCCategory(themeCode);
            if (iptc) {
                return 'iptc';  // IPTC e≈üle≈ümi≈ü kategori
            }
            // Kullanƒ±labilir kategori listesinde mi?
            if (USABLE_CATEGORIES.includes(themeCode)) {
                return 'category';
            }
            // Varsayƒ±lan: Diƒüer
            return 'other';
        }
        
        // CSV parse (basit)
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((h, idx) => {
                    let val = (values[idx] || '').trim();
                    // Sayƒ±sal deƒüerleri d√∂n√º≈üt√ºr
                    if (['total_docs', 'months_total', 'months_ok', 'min_docs', 'median_docs', 'n_docs'].includes(h)) {
                        row[h] = parseInt(val) || 0;
                    } else {
                        row[h] = val;
                    }
                });
                data.push(row);
            }
            return data;
        }
        
        // GDELT Status mesajƒ±
        function showGDELTStatus(message, type = 'info') {
            const el = document.getElementById('gdelt-status');
            el.textContent = message;
            el.className = `status-message ${type}`;
            el.style.display = 'block';
        }
        
        // CSV verilerini y√ºkle
        async function loadGDELTData() {
            const btn = document.getElementById('load-gdelt-data-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>Y√ºkleniyor...';
            
            showGDELTStatus('üì• CSV dosyalarƒ± y√ºkleniyor...', 'info');
            
            try {
                // Tablo-1: total_docs
                const resp1 = await fetch('bquxjob_645c6baa_19b43fe1bcd.csv');
                if (!resp1.ok) throw new Error('total_docs CSV bulunamadƒ±');
                const text1 = await resp1.text();
                gdeltTotalDocs = parseCSV(text1);
                
                // Tablo-2: monthly quality
                const resp2 = await fetch('bquxjob_4750d984_19b43fefa20.csv');
                if (!resp2.ok) throw new Error('monthly quality CSV bulunamadƒ±');
                const text2 = await resp2.text();
                gdeltMonthlyQuality = parseCSV(text2);
                
                // Aylƒ±k detay (opsiyonel)
                try {
                    const resp3 = await fetch('bquxjob_5c135702_19b43f3f270.csv');
                    if (resp3.ok) {
                        const text3 = await resp3.text();
                        gdeltMonthlyDetail = parseCSV(text3);
                    }
                } catch (e) {
                    console.log('Aylƒ±k detay dosyasƒ± y√ºklenemedi (opsiyonel)');
                }
                
                gdeltDataLoaded = true;
                
                // Tablolarƒ± g√ºncelle
                updateTotalDocsTable();
                updateMonthlyQualityTable();
                
                // Butonlarƒ± aktif et
                document.getElementById('analyze-themes-btn').disabled = false;
                document.getElementById('generate-matrix-btn').disabled = false;
                document.getElementById('export-gdelt-btn').disabled = false;
                
                showGDELTStatus(`‚úÖ Veriler y√ºklendi! Toplam Docs: ${gdeltTotalDocs.length} satƒ±r, Aylƒ±k Kalite: ${gdeltMonthlyQuality.length} satƒ±r`, 'success');
                
            } catch (error) {
                showGDELTStatus(`‚ùå Y√ºkleme hatasƒ±: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üì• CSV Verilerini Y√ºkle';
            }
        }
        
        // Tablo-1'i g√ºncelle (total_docs)
        function updateTotalDocsTable() {
            const tbody = document.getElementById('total-docs-tbody');
            const countryFilter = document.getElementById('gdelt-country-select').value;
            
            if (!gdeltDataLoaded || gdeltTotalDocs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">CSV y√ºklenmedi.</td></tr>';
                return;
            }
            
            // Filtrele
            let filtered = gdeltTotalDocs;
            if (countryFilter !== 'ALL') {
                filtered = gdeltTotalDocs.filter(d => d.country === countryFilter);
            }
            
            // Sƒ±rala (total_docs'a g√∂re azalan)
            filtered.sort((a, b) => b.total_docs - a.total_docs);
            
            // ƒ∞lk 100 satƒ±r
            const toShow = filtered.slice(0, 100);
            
            // IPTC renk haritasƒ±
            const iptcColors = {
                'economy, business and finance': '#FF9800',
                'conflict, war and peace': '#F44336',
                'politics and government': '#2196F3',
                'health': '#4CAF50',
                'education': '#9C27B0',
                'lifestyle and leisure': '#00BCD4',
                'disaster, accident and emergency incident': '#E91E63',
                'environment': '#8BC34A',
                'arts, culture, entertainment and media': '#673AB7',
                'society': '#607D8B',
                'human interest': '#FF5722',
                'religion': '#795548',
                'science and technology': '#009688',
                'crime, law and justice': '#3F51B5',
                'labour': '#FFC107',
                'sport': '#CDDC39',
                'weather': '#03A9F4'
            };
            
            tbody.innerHTML = '';
            toShow.forEach(row => {
                const iptcCategory = getIPTCCategory(row.theme_code);
                let iptcBadge = '';
                
                if (iptcCategory) {
                    const color = iptcColors[iptcCategory] || '#667eea';
                    const shortLabel = iptcCategory.split(',')[0]; // ƒ∞lk kƒ±smƒ± al
                    iptcBadge = `<span style="background: ${color}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; text-transform: capitalize;">${shortLabel}</span>`;
                } else {
                    iptcBadge = '<span style="background: #9e9e9e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em;">Diƒüer</span>';
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${row.country}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; font-family: monospace; font-weight: 600;">${row.theme_code}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;">${row.total_docs.toLocaleString()}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${iptcBadge}</td>
                `;
                tbody.appendChild(tr);
            });
            
            if (toShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #999;">Veri bulunamadƒ±</td></tr>';
            }
        }
        
        // Tablo-2'yi g√ºncelle (monthly quality)
        function updateMonthlyQualityTable() {
            const tbody = document.getElementById('monthly-quality-tbody');
            const qualityFilter = document.getElementById('gdelt-quality-filter').value;
            
            if (!gdeltDataLoaded || gdeltMonthlyQuality.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">CSV y√ºklenmedi.</td></tr>';
                return;
            }
            
            // IPTC renk haritasƒ±
            const iptcColors = {
                'economy, business and finance': '#FF9800',
                'conflict, war and peace': '#F44336',
                'politics and government': '#2196F3',
                'health': '#4CAF50',
                'education': '#9C27B0',
                'lifestyle and leisure': '#00BCD4',
                'disaster, accident and emergency incident': '#E91E63',
                'environment': '#8BC34A',
                'arts, culture, entertainment and media': '#673AB7',
                'society': '#607D8B',
                'human interest': '#FF5722',
                'religion': '#795548',
                'science and technology': '#009688',
                'crime, law and justice': '#3F51B5',
                'labour': '#FFC107',
                'sport': '#CDDC39',
                'weather': '#03A9F4'
            };
            
            // Oran hesapla ve filtrele
            let filtered = gdeltMonthlyQuality.map(row => {
                const ratio = row.months_total > 0 ? row.months_ok / row.months_total : 0;
                let decision = '';
                let decisionColor = '';
                
                if (ratio >= 0.7) {
                    decision = '‚úÖ Aylƒ±k';
                    decisionColor = '#4CAF50';
                } else if (ratio >= 0.4) {
                    decision = '‚ö†Ô∏è Quarterly';
                    decisionColor = '#FF9800';
                } else {
                    decision = '‚ùå √áƒ±kar';
                    decisionColor = '#f44336';
                }
                
                return { ...row, ratio, decision, decisionColor };
            });
            
            // Kalite filtresi
            if (qualityFilter === 'good') {
                filtered = filtered.filter(d => d.ratio >= 0.7);
            } else if (qualityFilter === 'marginal') {
                filtered = filtered.filter(d => d.ratio >= 0.4 && d.ratio < 0.7);
            } else if (qualityFilter === 'poor') {
                filtered = filtered.filter(d => d.ratio < 0.4);
            }
            
            // Sadece IPTC kategorisine sahip temalarƒ± g√∂ster
            filtered = filtered.filter(d => getIPTCCategory(d.theme_code) !== null);
            
            // Sƒ±rala (ratio'ya g√∂re azalan)
            filtered.sort((a, b) => b.ratio - a.ratio || b.median_docs - a.median_docs);
            
            // ƒ∞lk 100
            const toShow = filtered.slice(0, 100);
            
            tbody.innerHTML = '';
            toShow.forEach(row => {
                const iptcCategory = getIPTCCategory(row.theme_code);
                const color = iptcColors[iptcCategory] || '#667eea';
                const shortLabel = iptcCategory ? iptcCategory.split(',')[0] : 'Diƒüer';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${row.country}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; font-family: monospace; font-weight: 600;">${row.theme_code}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">
                        <span style="background: ${color}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; text-transform: capitalize;">${shortLabel}</span>
                    </td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">${row.months_ok}/${row.months_total}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center; font-weight: 600;">${(row.ratio * 100).toFixed(0)}%</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center; color: ${row.decisionColor}; font-weight: 600;">${row.decision}</td>
                `;
                tbody.appendChild(tr);
            });
            
            if (toShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">Filtreye uygun veri yok</td></tr>';
            }
        }
        
        // Tema analizi yap
        function analyzeThemes() {
            if (!gdeltDataLoaded) {
                showGDELTStatus('‚ùå √ñnce CSV verilerini y√ºkleyin!', 'error');
                return;
            }
            
            showGDELTStatus('üîç Tema analizi yapƒ±lƒ±yor...', 'info');
            
            // T√ºm √ºlkelerde ortak olan ve y√ºksek hacimli temalarƒ± bul
            const countries = ['CE', 'HO', 'HR', 'KG', 'LO', 'SA'];
            const themeCountByCountry = {};
            
            // Her tema i√ßin hangi √ºlkelerde var?
            gdeltTotalDocs.forEach(row => {
                if (!themeCountByCountry[row.theme_code]) {
                    themeCountByCountry[row.theme_code] = { countries: new Set(), totalDocs: 0 };
                }
                themeCountByCountry[row.theme_code].countries.add(row.country);
                themeCountByCountry[row.theme_code].totalDocs += row.total_docs;
            });
            
            // T√ºm 6 √ºlkede bulunan temalar
            const commonThemes = [];
            for (const [theme, data] of Object.entries(themeCountByCountry)) {
                if (data.countries.size === 6 && getThemeType(theme) === 'category') {
                    commonThemes.push({ theme, totalDocs: data.totalDocs });
                }
            }
            
            // Toplam docs'a g√∂re sƒ±rala
            commonThemes.sort((a, b) => b.totalDocs - a.totalDocs);
            
            // Listeyi g√ºncelle
            const listEl = document.getElementById('common-themes-list');
            if (commonThemes.length > 0) {
                listEl.innerHTML = commonThemes.slice(0, 20).map(t => 
                    `<div style="margin-bottom: 4px;"><code style="background: #e8f5e9; padding: 2px 6px; border-radius: 3px;">${t.theme}</code> <span style="color: #666;">(${(t.totalDocs/1000000).toFixed(2)}M docs)</span></div>`
                ).join('');
            } else {
                listEl.innerHTML = '<span style="color: #f44336;">Hi√ßbir tema 6 √ºlkede ortak deƒüil!</span>';
            }
            
            showGDELTStatus(`‚úÖ Analiz tamamlandƒ±! ${commonThemes.length} ortak tema bulundu.`, 'success');
        }
        
        // √úlke-Kategori matrisi olu≈ütur
        function generateCountryThemeMatrix() {
            if (!gdeltDataLoaded) {
                showGDELTStatus('‚ùå √ñnce CSV verilerini y√ºkleyin!', 'error');
                return;
            }
            
            showGDELTStatus('üìä Matris olu≈üturuluyor...', 'info');
            
            const countries = ['CE', 'HO', 'HR', 'KG', 'LO', 'SA'];
            const categoryGroups = {
                'Economy': ['ECON', 'EPU_ECONOMY', 'EPU'],
                'Government': ['GENERAL_GOVERNMENT', 'GENERAL', 'GOV', 'LEADER'],
                'Security': ['CRISISLEX', 'ARMEDCONFLICT', 'TERROR', 'SECURITY'],
                'Health': ['HEALTH', 'MEDICAL'],
                'Education': ['EDUCATION'],
                'Tourism': ['TOURISM']
            };
            
            // Her √ºlke-kategori i√ßin ratio hesapla
            const matrix = {};
            countries.forEach(country => {
                matrix[country] = {};
                
                for (const [catName, themeCodes] of Object.entries(categoryGroups)) {
                    // Bu kategorideki temalarƒ±n kalitesini kontrol et
                    let bestRatio = 0;
                    let bestDecision = '‚úñ';
                    let bestColor = '#f44336';
                    
                    for (const themeCode of themeCodes) {
                        const qualityRow = gdeltMonthlyQuality.find(
                            r => r.country === country && r.theme_code === themeCode
                        );
                        
                        if (qualityRow) {
                            const ratio = qualityRow.months_total > 0 ? qualityRow.months_ok / qualityRow.months_total : 0;
                            if (ratio > bestRatio) {
                                bestRatio = ratio;
                                if (ratio >= 0.7) {
                                    bestDecision = '‚úî';
                                    bestColor = '#4CAF50';
                                } else if (ratio >= 0.4) {
                                    bestDecision = '‚ö†';
                                    bestColor = '#FF9800';
                                } else {
                                    bestDecision = '‚úñ';
                                    bestColor = '#f44336';
                                }
                            }
                        }
                    }
                    
                    matrix[country][catName] = { ratio: bestRatio, decision: bestDecision, color: bestColor };
                }
            });
            
            // Tabloyu render et
            const tbody = document.getElementById('matrix-tbody');
            tbody.innerHTML = '';
            
            countries.forEach(country => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding: 12px; font-weight: 600; border-bottom: 1px solid #eee;">${country}</td>
                    ${Object.keys(categoryGroups).map(cat => {
                        const cell = matrix[country][cat];
                        return `<td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee; color: ${cell.color}; font-weight: 600; font-size: 1.2em;" title="${(cell.ratio * 100).toFixed(0)}%">${cell.decision}</td>`;
                    }).join('')}
                `;
                tbody.appendChild(tr);
            });
            
            showGDELTStatus('‚úÖ Matris olu≈üturuldu!', 'success');
        }
        
        // GDELT analizini CSV olarak dƒ±≈üa aktar
        function exportGDELTAnalysis() {
            if (!gdeltDataLoaded) {
                showGDELTStatus('‚ùå √ñnce CSV verilerini y√ºkleyin!', 'error');
                return;
            }
            
            // Aylƒ±k kalite verilerini dƒ±≈üa aktar
            let csv = 'country,theme_code,theme_type,months_total,months_ok,ratio,median_docs,decision\n';
            
            gdeltMonthlyQuality.forEach(row => {
                const themeType = getThemeType(row.theme_code);
                if (themeType !== 'category') return; // Sadece kategorileri
                
                const ratio = row.months_total > 0 ? (row.months_ok / row.months_total) : 0;
                let decision = ratio >= 0.7 ? 'monthly' : (ratio >= 0.4 ? 'quarterly' : 'exclude');
                
                csv += `${row.country},${row.theme_code},${themeType},${row.months_total},${row.months_ok},${ratio.toFixed(3)},${row.median_docs},${decision}\n`;
            });
            
            // ƒ∞ndir
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `gdelt_theme_analysis_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            showGDELTStatus('‚úÖ Analiz sonu√ßlarƒ± CSV olarak indirildi!', 'success');
        }
        
        // ==================== GDELT TEMA ANALƒ∞Zƒ∞ FONKSƒ∞YONLARI SONU ====================
        
        // Sayfa y√ºklendiƒüinde
        window.addEventListener('DOMContentLoaded', () => {
            initTabButtons();
            initPipelineButtons();  // Pipeline se√ßim butonlarƒ±nƒ± ba≈ülat
            initExportFilters();    // Export filtre event listener'larƒ±nƒ± ba≈ülat
            attachEventListeners();
            updateInfoBox();
            
            // √ñnce otomatik y√ºkleme dene, yoksa varsayƒ±lan veriyi y√ºkle
            autoLoadLastAnalysis().then(() => {
                // Eƒüer veri y√ºklenmediyse varsayƒ±lan veriyi y√ºkle
                if (allData.length === 0) {
                    loadData();
                }
                // Export filtre bilgisini g√ºncelle
                updateExportFilterInfo();
            });
        });
        
        // Debug: GDELT Clustering otomatik y√ºkleme (sayfa y√ºklendiƒüinde test i√ßin)
        document.addEventListener('DOMContentLoaded', () => {
            // Clustering sekmesine ge√ßilirse otomatik olarak sonu√ßlarƒ± y√ºklemeye √ßalƒ±≈ü
            const loadResultsBtn = document.getElementById('gdelt-load-results-btn');
            if (loadResultsBtn) {
                // Buton etkinle≈ütir ve tƒ±kla
                loadResultsBtn.disabled = false;
                // Sayfa y√ºklendikten 2 saniye sonra otomatik y√ºkleme dene
                setTimeout(() => {
                    loadGDELTClusteringResults().catch(e => console.warn('Auto-load failed:', e));
                }, 2000);
            }
        });
    </script>
</body>
</html>
